#!/system/bin/sh
# ==============================================================================
# f2fsopt - F2FS/EXT4 ä¼˜åŒ–å™¨ - è‡ªåŠ¨ Trim + GC
# ==============================================================================

# ==============================================================================
# é€€å‡ºç å®šä¹‰
# ==============================================================================

# æˆåŠŸ
EXIT_SUCCESS=0

# é”å†²çªï¼ˆå¦ä¸€ä¸ªå®ä¾‹æ­£åœ¨è¿è¡Œï¼‰
EXIT_LOCK_CONFLICT=1

# æ¡ä»¶ä¸æ»¡è¶³ï¼ˆæœªå……ç”µ/äº®å±ç­‰ï¼‰
EXIT_CONDITION=2

# æ—  Root æƒé™
EXIT_NO_ROOT=3

# å¿…éœ€å·¥å…·ç¼ºå¤±
EXIT_TOOL_MISSING=127

# ==============================================================================
# é…ç½®åŒºåŸŸ
# ==============================================================================

# åŠŸèƒ½å¼€å…³

# æ›´æ–°æ¨¡å—æè¿°ï¼ˆå¯é…ç½®ï¼‰
ENABLE_MAGISK_UI=true

# å‘é€ç³»ç»Ÿé€šçŸ¥ (ä»…æ”¯æŒ Android 10+)
ENABLE_NOTIFICATIONS=true

# å¥åº·åˆ†åŒºè·³è¿‡ GC
ENABLE_SMART_GC=true

# å¥åº·åˆ†åŒºè·³è¿‡ Trim
ENABLE_SMART_TRIM=true

# äº®å±æ—¶ä¸­æ–­æ‰§è¡Œ
STOP_ON_SCREEN_ON=false

# ä»…åœ¨å……ç”µæ—¶è¿è¡Œ
ONLY_CHARGING=false

# GC ç­–ç•¥

# å¯ç”¨æé€Ÿ GC æ¨¡å¼
ENABLE_TURBO_GC=true

# GC æ¨¡å¼ï¼š1=å‰å° 2=åå°ï¼ˆå¯é…ç½®ï¼Œå»ºè®®ä¿æŒé»˜è®¤ï¼‰
# æ³¨ï¼šå†…æ ¸å¯èƒ½è¿”å› 3/5 ç­‰æ‰©å±•æšä¸¾ï¼Œå±æ­£å¸¸
GC_MODE_PREF="1"

# è„æ®µé˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼è§¦å‘ GCï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š50-1000ï¼‰
GC_DIRTY_MIN=200

# æé€Ÿ GC ç¡çœ é—´éš”ï¼Œå•ä½æ¯«ç§’ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š10-5000ï¼‰
GC_TURBO_SLEEP=50

# å®‰å…¨ GC ç¡çœ é—´éš”ï¼Œå•ä½æ¯«ç§’ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š100-10000ï¼‰
GC_SAFE_SLEEP=500

# æœ€å¤§è¿è¡Œæ—¶é•¿ï¼Œå•ä½ç§’ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š60-3600ï¼‰
GC_MAX_SEC=500

# ç¨³å®šè®¡æ•°é˜ˆå€¼ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š1-50ï¼‰
GC_STABLE_CNT=8

# Trim è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š60-3600ï¼‰
TRIM_TIMEOUT=500

# GC è½®è¯¢é—´éš”ï¼Œå•ä½ç§’ï¼ˆå¯é…ç½®ï¼ŒèŒƒå›´ï¼š1-60ï¼‰
GC_POLL=1

# æ‰«ææ€§èƒ½è¯Šæ–­

# æŒ‚è½½ç‚¹æ‰«æè¯Šæ–­å¼€å…³ï¼š0=ç¦ç”¨ 1=å¯ç”¨
DEBUG_SCAN=1

# æ…¢é€ŸæŒ‚è½½é˜ˆå€¼ï¼Œå•ä½æ¯«ç§’ï¼Œè¶…è¿‡æ­¤å€¼è¾“å‡ºä¿¡æ¯
SLOW_MOUNT_THRESHOLD=1000

# ææ…¢æŒ‚è½½é˜ˆå€¼ï¼Œå•ä½æ¯«ç§’ï¼Œè¶…è¿‡æ­¤å€¼è¾“å‡ºè­¦å‘Š
VERY_SLOW_THRESHOLD=1500

# ç³»ç»Ÿè·¯å¾„
# æ³¨æ„: å¦‚æœä¿®æ”¹ LOCK_DIRï¼Œè¯·åŠ¡å¿…åŒæ­¥ä¿®æ”¹ action.sh ä¸­çš„ F2FSOPT_LOCK_DIR
LOCK_DIR="/data/local/tmp/f2fsopt.lock.d"
LOCK_PID_FILE="$LOCK_DIR/pid"
WAKE_LOCK_ID="f2fsopt_lck"

# å¿½ç•¥è·¯å¾„å‰ç¼€ï¼ˆç»Ÿä¸€é»‘åå•é…ç½®ï¼‰
IGNORE_PREFIXES="
/storage /mnt /apex /bionic /system /vendor /product /odm /dev /sys /proc
/acct /config /debug_ramdisk /data_mirror /linkerconfig /postinstall
/metadata /oem /lost+found /system_ext /vendor /my_product /odm /bin /sbin
/data/user_de /data/data /data/adb
"

# ä¾èµ–å·¥å…·åˆ—è¡¨
REQUIRED_TOOLS="stat readlink fstrim timeout ls mkdir rm rmdir sleep date"

# ==============================================================================
# ç¯å¢ƒåˆå§‹åŒ–
# ==============================================================================

# åˆå§‹åŒ–æ¨¡å—ç›®å½•
_f2fs_script="$0"
_f2fs_dir=""

# 1. å¤„ç†ç¬¦å·é“¾æ¥
if [ -L "$_f2fs_script" ]; then
    _f2fs_real=$(readlink -f "$_f2fs_script" 2>/dev/null)
    if [ -n "$_f2fs_real" ]; then
        _f2fs_dir="${_f2fs_real%/*}"
    else
        _f2fs_dir="${_f2fs_script%/*}"
    fi
else
    _f2fs_dir="${_f2fs_script%/*}"
fi

# 2. ç¡®ä¿ç»å¯¹è·¯å¾„
case "$_f2fs_dir" in
    /*) MODDIR="$_f2fs_dir" ;;
    *)  MODDIR="$(cd "$_f2fs_dir" 2>/dev/null && pwd)" ;;
esac

# 3. éªŒè¯ MODDIR æœ‰æ•ˆæ€§
if [ -z "$MODDIR" ]; then
    printf 'è‡´å‘½é”™è¯¯: æ— æ³•åˆå§‹åŒ–æ¨¡å—ç›®å½•\n' >&2
    exit 1
fi

# å¦‚æœ MODDIR ä¸å­˜åœ¨ï¼Œä½¿ç”¨å½“å‰ç›®å½•
if [ ! -d "$MODDIR" ]; then
    # å°è¯•ä½¿ç”¨å½“å‰å·¥ä½œç›®å½•ä½œä¸ºå›é€€
    if [ -n "$PWD" ] && [ -d "$PWD" ]; then
        MODDIR="$PWD"
    else
        :  # ç©ºæ“ä½œï¼Œä¿æŒ MODDIR ä¸ºè§£æå‡ºçš„è·¯å¾„
    fi
fi

SCRIPT_NAME="${0##*/}"
START_TIME=$(date +%s)

# ä¿å­˜å½“å‰è¿›ç¨‹IDï¼ˆé¿å…åœ¨å­shellä¸­ä½¿ç”¨ $$ å¯¼è‡´çš„é—®é¢˜ï¼‰
CURRENT_PID=$$

# ç»Ÿè®¡å˜é‡
TOTAL_TRIM_KB=0
TOTAL_GC_SEGS=0
COUNT_GC_RUN=0
COUNT_GC_SKIP=0
COUNT_TRIM_RUN=0
COUNT_TRIM_SKIP=0
COUNT_TRIM_ZERO=0
COUNT_SCREEN_SKIP=0
COUNT_SYS_API=0
LIST_FAIL=""
EXIT_CODE=0

# sm fstrim å…¨å±€è°ƒç”¨æ ‡è®°
SM_FSTRIM_CALLED=false

# sm idle-maint å…¨å±€è°ƒç”¨æ ‡è®°
SM_IDLE_MAINT_CALLED=false

# å¹¶å‘æ§åˆ¶å˜é‡åˆå§‹åŒ–
HAS_ACQUIRED_WAKELOCK=false
ACTIVE_GC_NODE=""
ACTIVE_SLEEP_NODE=""
RESTORE_GC_VAL=""
RESTORE_SLEEP_VAL=""

export LC_ALL=C

# SYNC: Busybox æ¢æµ‹è·¯å¾„ - ä¸ service.sh init_busybox() ä¿æŒä¸€è‡´
# æ›´æ–°æ—¶è¯·åŒæ­¥ä¿®æ”¹ service.sh
# æŸ¥æ‰¾ Busybox
BB_PATH=""
_bb_p=""

# å¹‚ç­‰æ€§æ£€æŸ¥ - å¦‚æœå·²ç»æ‰¾åˆ°å¯ç”¨çš„ Busyboxï¼Œç›´æ¥è·³è¿‡
if [ -z "$BB_PATH" ] || [ ! -x "$BB_PATH" ]; then
    # éå†é¢„å®šä¹‰è·¯å¾„åˆ—è¡¨ï¼ˆåŒ…å«é€šé…ç¬¦æ‰«æï¼‰
    for _bb_p in \
        "/data/adb/magisk/busybox" \
        "/data/adb/ksu/bin/busybox" \
        "/data/adb/ap/bin/busybox" \
        /data/adb/*/busybox \
        "/system/bin/busybox"; do
        # è·³è¿‡é€šé…ç¬¦æœªå±•å¼€çš„æƒ…å†µ
        case "$_bb_p" in *'*'*) continue ;; esac
        
        if [ -x "$_bb_p" ]; then
            BB_PATH="$_bb_p"
            export PATH="${BB_PATH%/*}:$PATH"
            break
        fi
    done
    
    # åŠ¨æ€å›é€€ - å°è¯•é€šè¿‡ command -v æŸ¥æ‰¾
    if [ -z "$BB_PATH" ]; then
        _bb_p=$(command -v busybox 2>/dev/null)
        if [ -n "$_bb_p" ] && [ -x "$_bb_p" ]; then
            BB_PATH="$_bb_p"
            export PATH="${BB_PATH%/*}:$PATH"
        fi
    fi
fi

# æœªæ‰¾åˆ° Busybox æ—¶è®°å½•è­¦å‘Šï¼ˆä½†ç»§ç»­æ‰§è¡Œï¼‰
[ -z "$BB_PATH" ] && log_msg "è­¦å‘Š: æœªæ‰¾åˆ° Busybox,å°†ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤"

# 1. å®šä¹‰busyboxä»£ç† (å…¨ä»£ç†æ¨¡å¼ + å®‰å…¨è¿‡æ»¤)
init_command_proxy() {
    # åŸºç¡€æ£€æŸ¥ - BB_PATH æ— æ•ˆæ—¶é™é»˜è¿”å›å¤±è´¥
    [ -z "$BB_PATH" ] || [ ! -x "$BB_PATH" ] && return 1
    
    _icp_cmd=""; _icp_bb_caps=""; _icp_type_out=""
    
    # 1. è·å– Busybox èƒ½åŠ›æ¸…å•å¹¶æ¸…æ´—æ ¼å¼
    _icp_bb_caps=$("$BB_PATH" --list 2>/dev/null)
    
    # éªŒè¯èƒ½åŠ›æ¸…å•è·å–æˆåŠŸ
    [ -z "$_icp_bb_caps" ] && return 1
    
    # 2. æ‰¹é‡è¿‡æ»¤ï¼šShell builtin/reserved
    # é¢„å®šä¹‰ Shell æ ¸å¿ƒå‘½ä»¤é»‘åå•ï¼Œé¿å…é‡å¤ type è°ƒç”¨
    _icp_shell_builtins="echo cd pwd exit test true false [ : . break continue eval exec export return set shift times trap unset"
    
    # 3. éå† Busybox æ”¯æŒçš„æ¯ä¸ªå‘½ä»¤
    for _icp_cmd in $_icp_bb_caps; do
        # [è¿‡æ»¤å™¨ A] å­—ç¬¦åˆæ³•æ€§æ£€æŸ¥
        case "$_icp_cmd" in
            *[!a-zA-Z0-9_.-]*) continue ;;  # æ’é™¤ç‰¹æ®Šå­—ç¬¦
            [0-9]*) continue ;;              # æ’é™¤æ•°å­—å¼€å¤´
        esac
        
        # [è¿‡æ»¤å™¨ B] Shell æ ¸å¿ƒå‘½ä»¤é»‘åå•ï¼ˆå¿«é€Ÿè·¯å¾„ï¼‰
        case " $_icp_shell_builtins " in
            *" $_icp_cmd "*) continue ;;
        esac
        
        # [è¿‡æ»¤å™¨ C] type æ£€æµ‹å…œåº•ï¼ˆä»…å¯¹é»‘åå•å¤–çš„å‘½ä»¤ï¼‰
        _icp_type_out=$(type "$_icp_cmd" 2>/dev/null)
        case "$_icp_type_out" in
            *builtin*|*reserved*|*keyword*) continue ;;
        esac
        
        # 4. æ‰§è¡Œä»£ç†æ³¨å†Œï¼ˆå®‰å…¨å‘½ä»¤ï¼‰
        eval "$_icp_cmd() { '$BB_PATH' $_icp_cmd \"\$@\"; }"
    done
    
    # 5. åˆ·æ–° Shell å“ˆå¸Œè¡¨
    hash -r 2>/dev/null || true
    return 0
}

# æ‰§è¡Œä»£ç†åˆå§‹åŒ– - å¤±è´¥æ—¶è®°å½•è­¦å‘Šä½†ç»§ç»­
init_command_proxy || log_msg "å‘½ä»¤ä»£ç†åˆå§‹åŒ–å¤±è´¥,å°†ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤"

HAS_TIMEOUT=false
HAS_STAT=false
HAS_FSTRIM=false

# æ£€æµ‹å¯ç”¨æ€§ï¼ˆä»£ç†å±‚å·²å¼ºåˆ¶åˆ›å»ºï¼Œæ­¤å¤„ä»…æ£€æµ‹æœ€ç»ˆå¯ç”¨æ€§ï¼‰
command -v timeout >/dev/null 2>&1 && HAS_TIMEOUT=true
command -v stat >/dev/null 2>&1 && HAS_STAT=true
command -v fstrim >/dev/null 2>&1 && HAS_FSTRIM=true

# å‘½ä»¤ç¼“å­˜å˜é‡ï¼ˆé¿å…é‡å¤ type è°ƒç”¨ï¼‰
TIMEOUT_CMD="timeout"
STAT_CMD="stat"
FSTRIM_CMD="fstrim"

# åˆå§‹åŒ–å‘½ä»¤ç¼“å­˜ï¼ˆæ£€æµ‹å¹¶è§£åŒ…ä»£ç†å‡½æ•°ï¼‰
init_command_cache() {
    _icc_type=""
    
    if [ "$HAS_TIMEOUT" = true ]; then
        _icc_type=$(type timeout 2>/dev/null)
        case "$_icc_type" in
            *function*) [ -n "$BB_PATH" ] && TIMEOUT_CMD="$BB_PATH timeout" ;;
        esac
    fi
    
    if [ "$HAS_STAT" = true ]; then
        _icc_type=$(type stat 2>/dev/null)
        case "$_icc_type" in
            *function*) [ -n "$BB_PATH" ] && STAT_CMD="$BB_PATH stat" ;;
        esac
    fi
    
    if [ "$HAS_FSTRIM" = true ]; then
        _icc_type=$(type fstrim 2>/dev/null)
        case "$_icc_type" in
            *function*) [ -n "$BB_PATH" ] && FSTRIM_CMD="$BB_PATH fstrim" ;;
        esac
    fi
}

# æ‰§è¡Œå‘½ä»¤ç¼“å­˜åˆå§‹åŒ–
init_command_cache

# ==============================================================================
# å‘½ä»¤è¡Œæ¥å£
# ==============================================================================

show_help() {
    printf "ç”¨æ³•: %s [é€‰é¡¹] [è·¯å¾„...]\n" "$SCRIPT_NAME"
    printf "åŠŸèƒ½: F2FS/EXT4 åˆ†åŒºæ™ºèƒ½ä¼˜åŒ– (Trim + GC)\n\n"
    printf "é€‰é¡¹:\n"
    printf "  -t, --fstrim   ä»…æ‰§è¡Œ Trim\n"
    printf "  -g, --gc       ä»…æ‰§è¡Œ GC\n"
    printf "  -s, --system   å¼ºåˆ¶ä½¿ç”¨ç³»ç»Ÿ API (sm)\n"
    printf "  -h, --help     æ˜¾ç¤ºå¸®åŠ©\n\n"
    printf "è·¯å¾„å‚æ•°:\n"
    printf "  ä¸æŒ‡å®šè·¯å¾„ - è‡ªåŠ¨æ‰«ææ‰€æœ‰F2FS/EXT4åˆ†åŒº\n"
    printf "  æŒ‡å®šè·¯å¾„   - ä»…ä¼˜åŒ–æŒ‡å®šæŒ‚è½½ç‚¹\n\n"
    printf "ç¤ºä¾‹:\n"
    printf "  %s                    # è‡ªåŠ¨æ‰«æï¼Œæ‰§è¡ŒTrim+GC\n" "$SCRIPT_NAME"
    printf "  %s -t                 # è‡ªåŠ¨æ‰«æï¼Œä»…Trim\n" "$SCRIPT_NAME"
    printf "  %s -g /data           # ä»…å¯¹/dataæ‰§è¡ŒGC\n" "$SCRIPT_NAME"
    printf "  %s /data /cache       # ä»…ä¼˜åŒ–/dataå’Œ/cache\n" "$SCRIPT_NAME"
}

TRIM=false; GC=false; USE_SYSTEM_API=false; MANUAL_TARGETS=""
while [ "$#" -gt 0 ]; do
    case "$1" in
        -t|--fstrim) TRIM=true ;;
        -g|--gc)     GC=true ;;
        -s|--system) USE_SYSTEM_API=true ;;
        -h|--help)   show_help; exit 0 ;;
        *)           MANUAL_TARGETS="$MANUAL_TARGETS $1" ;;
    esac
    shift
done
if [ "$TRIM" = false ] && [ "$GC" = false ]; then TRIM=true; GC=true; fi

# ==============================================================================
# æ ¸å¿ƒå‡½æ•°
# ==============================================================================

is_integer() { case "$1" in ''|*[!0-9]*) return 1 ;; *) return 0 ;; esac }

# è®¡ç®—è·¯å¾„ä¸­æ–œæ çš„æ•°é‡ï¼ˆç›®å½•å±‚çº§æ·±åº¦ï¼‰
count_slashes() {
    _cs_path="$1"
    _cs_count=0
    _cs_rest="$_cs_path"
    
    # çº¯ Shell å®ç°ï¼Œé¿å… fork
    while case "$_cs_rest" in */*) true;; *) false;; esac; do
        _cs_count=$((_cs_count + 1))
        _cs_rest="${_cs_rest#*/}"
    done
    
    printf '%d\n' "$_cs_count"
}

# æ—¥å¿—é…ç½®éªŒè¯
validate_log_mode() {
    _vlm_mode="$1"
    case "$_vlm_mode" in
        NONE|INFO|DEBUG) return 0 ;;
        *) return 1 ;;
    esac
}

# éªŒè¯å¹¶ä¿®æ­£ LOG_MODE é…ç½®
if [ -n "$LOG_MODE" ]; then
    if ! validate_log_mode "$LOG_MODE"; then
        log_msg "âš ï¸ LOG_MODE=$LOG_MODE æ— æ•ˆï¼Œä½¿ç”¨é»˜è®¤å€¼ INFO"
        LOG_MODE="INFO"
    fi
else
    LOG_MODE="INFO"
fi

# ==============================================================================
# æ—¥å¿—å‡½æ•°
# ==============================================================================

log_msg() {
    [ "${LOG_MODE:-INFO}" = "NONE" ] && return 0
    printf '%s I %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$1" >&2
}

log_warn() {
    [ "${LOG_MODE:-INFO}" = "NONE" ] && return 0
    printf '%s W %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$1" >&2
}

log_err() {
    # è®¾è®¡å†³ç­–ï¼šé”™è¯¯æ—¥å¿—å§‹ç»ˆè®°å½•ï¼Œç”¨äºæ•…éšœæ’æŸ¥
    printf '%s E %s\n' "$(date '+%Y-%m-%d %H:%M:%S')" "$1" >&2
}

# è·å–æ¯«ç§’æ—¶é—´æˆ³
get_timestamp_ms() {
    _gtm_sec=""; _gtm_nsec=""; _gtm_ms=""
    # ä¼˜å…ˆä½¿ç”¨é«˜ç²¾åº¦æ—¶é—´
    if read -r _gtm_sec _gtm_nsec < /proc/uptime 2>/dev/null; then
        # è½¬æ¢çº³ç§’ä¸ºæ¯«ç§’ï¼šå»æ‰å°æ•°ç‚¹ï¼Œå–å‰ä¸‰ä½
        _gtm_nsec="${_gtm_nsec#*.}"  # æå–å°æ•°éƒ¨åˆ†
        _gtm_nsec="${_gtm_nsec}000"  # è¡¥é½ä½æ•°
        
        # POSIX å…¼å®¹ï¼šä½¿ç”¨å¾ªç¯é€ä½ç§»é™¤åç¼€ï¼ˆä¿ç•™å‰3ä½ï¼‰
        _gtm_ms="$_gtm_nsec"
        while [ "${#_gtm_ms}" -gt 3 ]; do
            _gtm_ms="${_gtm_ms%?}"
        done
        
        # å»é™¤å‰å¯¼é›¶ï¼Œé¿å…å…«è¿›åˆ¶è§£æé”™è¯¯
        case "$_gtm_ms" in
            0*) _gtm_ms="${_gtm_ms#0}"; _gtm_ms="${_gtm_ms#0}" ;;
        esac
        # ç©ºå­—ç¬¦ä¸²å›é€€ä¸º 0
        [ -z "$_gtm_ms" ] && _gtm_ms=0
        
        printf '%d%03d\n' "${_gtm_sec%%.*}" "$_gtm_ms"
    else
        # å›é€€ï¼šç§’çº§ç²¾åº¦
        printf '%d000\n' "$(date +%s)"
    fi
}

read_first_line() {
    eval "$1=''"
    [ -r "$2" ] 2>/dev/null || return 1
    _rfl_tmp_line=""
    read -r _rfl_tmp_line < "$2" 2>/dev/null || return 1
    eval "$1=\$_rfl_tmp_line"
}

decode_path() {
    _dp_path="$1"; _dp_out=""; _dp_c=""; _dp_oct=""
    
    # å¿«é€Ÿè·¯å¾„ï¼šæ— è½¬ä¹‰ç›´æ¥è¿”å›
    case "$_dp_path" in
        *\\[0-7][0-7][0-7]*) ;;
        *) printf '%s\n' "$_dp_path"; return 0 ;;
    esac
    
    # å®‰å…¨è§£æï¼šä»…å¤„ç†å¸¸è§å…«è¿›åˆ¶è½¬ä¹‰
    while [ -n "$_dp_path" ]; do
        case "$_dp_path" in
            \\[0-7][0-7][0-7]*)
                _dp_oct="${_dp_path#\\}"
                _dp_oct="${_dp_oct%%[!0-7]*}"
                _dp_c="${_dp_oct#[0-7]}"
                _dp_c="${_dp_c#[0-7]}"
                _dp_oct="${_dp_oct%"$_dp_c"}"
                
                case "$_dp_oct" in
                    040) _dp_out="$_dp_out " ;;      # ç©ºæ ¼
                    011) _dp_out="$_dp_out	" ;;    # Tab
                    012) _dp_out="$_dp_out
" ;;                                           # æ¢è¡Œ
                    *) _dp_out="$_dp_out\\$_dp_oct" ;;  # å…¶ä»–ä¿ç•™åŸæ ·
                esac
                
                _dp_path="${_dp_path#\\$_dp_oct}"
                ;;
            *\\*)
                _dp_out="$_dp_out${_dp_path%%\\*}"
                _dp_path="${_dp_path#*\\}"
                ;;
            *)
                _dp_out="$_dp_out$_dp_path"
                break
                ;;
        esac
    done
    printf '%s\n' "$_dp_out"
}

is_path_ignored() {
    _ipi_path="$1"; _ipi_prefix=""
    for _ipi_prefix in $IGNORE_PREFIXES; do
        case "$_ipi_path" in "$_ipi_prefix"|"${_ipi_prefix}"/*) return 0 ;; esac
    done
    return 1
}

# æ›´æ–°æ¨¡å—æè¿°
update_magisk_ui() {
    _umu_msg="$1"
    [ "$ENABLE_MAGISK_UI" = true ] || return 0
    [ -f "$MODDIR/module.prop" ] || return 0
    _umu_final_msg="$_umu_msg ğŸ•’æ—¥æœŸ:$(date "+%Y-%m-%d %H:%M:%S")"
    _umu_tmp="$MODDIR/module.prop.tmp"
    {
        while IFS= read -r _umu_line || [ -n "$_umu_line" ]; do
            case "$_umu_line" in
                description=*)
                    printf 'description=%s\n' "$_umu_final_msg"
                    ;;
                *)
                    printf '%s\n' "$_umu_line"
                    ;;
            esac
        done < "$MODDIR/module.prop"
    } > "$_umu_tmp" 2>/dev/null && mv "$_umu_tmp" "$MODDIR/module.prop" 2>/dev/null
    # æ¸…ç†å¤±è´¥æ®‹ç•™
    rm -f "$_umu_tmp" 2>/dev/null
}

# ==============================================================================
# é€šç”¨é€šçŸ¥å‘é€å‡½æ•°
# ==============================================================================
send_notification() {
    _sn_msg="$1"
    
    # 1. åŸºç¡€ç¯å¢ƒæ£€æŸ¥
    [ "$ENABLE_NOTIFICATIONS" = true ] || return 0
    
    # 2. Android ç‰ˆæœ¬æ£€æŸ¥ï¼ˆcmd notification post éœ€è¦ Android 10+ï¼‰
    _sn_sdk=$(getprop ro.build.version.sdk 2>/dev/null)
    case "$_sn_sdk" in *[!0-9]*) _sn_sdk=0 ;; esac
    if [ "$_sn_sdk" -lt 29 ] 2>/dev/null; then
        log_msg "[é€šçŸ¥] Android ç‰ˆæœ¬è¿‡ä½ (SDK: $_sn_sdk < 29ï¼Œéœ€è¦ Android 10+)"
        return 0
    fi
    
    # 3. å®šä½ cmd å‘½ä»¤ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼Œé¿å… PATH é—®é¢˜ï¼‰
    _sn_cmd_bin=""
    if [ -x "/system/bin/cmd" ]; then
        _sn_cmd_bin="/system/bin/cmd"
    elif command -v cmd >/dev/null 2>&1; then
        _sn_cmd_bin="cmd"
    else
        log_msg "[é€šçŸ¥] cmd å‘½ä»¤ä¸å¯ç”¨"
        return 0
    fi
    
    # 4. æˆªæ–­è¿‡é•¿æ–‡æœ¬ï¼ˆé˜²æ­¢ç³»ç»Ÿæ‹’æ”¶ï¼‰
    _sn_date_suffix=" ğŸ•’æ—¥æœŸ:$(date '+%Y-%m-%d %H:%M:%S')"
    _sn_max_len=$((1024 - ${#_sn_date_suffix}))
    
    if [ "${#_sn_msg}" -gt "$_sn_max_len" ]; then
        _sn_msg="$(printf '%.'"$((${_sn_max_len} - 3))"'s' "$_sn_msg")..."
        log_msg "[é€šçŸ¥] å†…å®¹å·²æˆªæ–­"
    fi
    
    # æ·»åŠ æ—¥æœŸæ—¶é—´åç¼€
    _sn_msg="$_sn_msg$_sn_date_suffix"
    
    # 5. æ„é€ æ ¸å¿ƒå‘½ä»¤ï¼ˆä½¿ç”¨ç»å¯¹è·¯å¾„ï¼‰
    # -S bigtext: å±•å¼€é•¿æ–‡æœ¬
    # -t: æ ‡é¢˜
    # ä¸æŒ‡å®š -i (å›¾æ ‡): ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ï¼Œé¿å… invalid icon é”™è¯¯
    # ä¸æŒ‡å®š -c (æ¸ é“): è‡ªåŠ¨è½å…¥ shell_cmd é»˜è®¤æ¸ é“
    _sn_tag="f2fs_opt"
    _sn_title="F2FS Optimizer"
    
    # è½¬ä¹‰å•å¼•å·ï¼ˆé˜²æ­¢å‘½ä»¤æ³¨å…¥ï¼‰
    _sn_msg_escaped=""
    _sn_rest="$_sn_msg"
    while case "$_sn_rest" in *"'"*) true;; *) false;; esac; do
        _sn_before="${_sn_rest%%\'*}"
        _sn_msg_escaped="$_sn_msg_escaped$_sn_before'\\''"
        _sn_rest="${_sn_rest#*\'}"
    done
    _sn_msg_escaped="$_sn_msg_escaped$_sn_rest"
    
    _sn_core_cmd="$_sn_cmd_bin notification post -S bigtext -t '$_sn_title' '$_sn_tag' '$_sn_msg_escaped'"
    
    # 6. èº«ä»½åˆ‡æ¢å‘é€
    _sn_ret=1
    
    if [ "$(id -u)" -eq 0 ]; then
        # Root ç¯å¢ƒï¼šå°è¯•åˆ‡æ¢åˆ° Shell ç”¨æˆ·ï¼ˆAndroid 7.0+ æ¨èï¼‰
        # æ³¨æ„ï¼šéƒ¨åˆ†è®¾å¤‡çš„ su ä¸æ”¯æŒæ•°å­— UIDï¼Œéœ€è¦ä½¿ç”¨ç”¨æˆ·å
        if command -v su >/dev/null 2>&1; then
            # å°è¯•æ–¹æ¡ˆ 1: su shell (ç”¨æˆ·å) - è®¾ç½®å®Œæ•´ PATH
            if su shell -c "true" >/dev/null 2>&1; then
                if [ "$HAS_TIMEOUT" = true ]; then
                    $TIMEOUT_CMD 3 su shell -c "PATH=/system/bin:\$PATH $_sn_core_cmd" >/dev/null 2>&1
                    _sn_ret=$?
                else
                    su shell -c "PATH=/system/bin:\$PATH $_sn_core_cmd" >/dev/null 2>&1
                    _sn_ret=$?
                fi
                
                if [ "$_sn_ret" -eq 0 ]; then
                    log_msg "[é€šçŸ¥] å‘é€æˆåŠŸ (Shell ç”¨æˆ·)"
                    return 0
                else
                    log_msg "[é€šçŸ¥] Shell ç”¨æˆ·å‘é€å¤±è´¥ [é€€å‡ºç : $_sn_ret]"
                fi
            # å°è¯•æ–¹æ¡ˆ 2: su 2000 (UID) - è®¾ç½®å®Œæ•´ PATH
            elif su 2000 -c "true" >/dev/null 2>&1; then
                if [ "$HAS_TIMEOUT" = true ]; then
                    $TIMEOUT_CMD 3 su 2000 -c "PATH=/system/bin:\$PATH $_sn_core_cmd" >/dev/null 2>&1
                    _sn_ret=$?
                else
                    su 2000 -c "PATH=/system/bin:\$PATH $_sn_core_cmd" >/dev/null 2>&1
                    _sn_ret=$?
                fi
                
                if [ "$_sn_ret" -eq 0 ]; then
                    log_msg "[é€šçŸ¥] å‘é€æˆåŠŸ (UID 2000)"
                    return 0
                else
                    log_msg "[é€šçŸ¥] UID 2000 å‘é€å¤±è´¥ [é€€å‡ºç : $_sn_ret]"
                fi
            else
                log_msg "[é€šçŸ¥] æ— æ³•åˆ‡æ¢åˆ° Shell ç”¨æˆ·ï¼Œå°è¯•ç›´æ¥å‘é€"
            fi
        else
            log_msg "[é€šçŸ¥] su å‘½ä»¤ä¸å¯ç”¨ï¼Œå°è¯•ç›´æ¥å‘é€"
        fi
        
        # å›é€€ï¼šç›´æ¥ä»¥ Root èº«ä»½å‘é€ï¼ˆå¯èƒ½è¢«æ‹¦æˆªï¼‰
        if [ "$HAS_TIMEOUT" = true ]; then
            $TIMEOUT_CMD 3 eval "$_sn_core_cmd" >/dev/null 2>&1
            _sn_ret=$?
        else
            eval "$_sn_core_cmd" >/dev/null 2>&1
            _sn_ret=$?
        fi
        
        if [ "$_sn_ret" -eq 0 ]; then
            log_msg "[é€šçŸ¥] å‘é€æˆåŠŸ (Root èº«ä»½ï¼Œå¯èƒ½è¢«ç³»ç»Ÿæ‹¦æˆª)"
            return 0
        else
            log_warn "[é€šçŸ¥] å‘é€å¤±è´¥ [é€€å‡ºç : $_sn_ret]"
            return 1
        fi
    else
        # é Root ç¯å¢ƒï¼ˆç½•è§ï¼‰ï¼Œç›´æ¥å‘é€
        if [ "$HAS_TIMEOUT" = true ]; then
            $TIMEOUT_CMD 3 eval "$_sn_core_cmd" >/dev/null 2>&1
            _sn_ret=$?
        else
            eval "$_sn_core_cmd" >/dev/null 2>&1
            _sn_ret=$?
        fi
        
        if [ "$_sn_ret" -eq 0 ]; then
            log_msg "[é€šçŸ¥] å‘é€æˆåŠŸ"
            return 0
        else
            log_warn "[é€šçŸ¥] å‘é€å¤±è´¥ [é€€å‡ºç : $_sn_ret]"
            return 1
        fi
    fi
}

# è§£æè®¾å¤‡è·¯å¾„ï¼šå¤„ç†ç¬¦å·é“¾æ¥
resolve_dev_path() {
    _rdp_path="$1"; _rdp_limit=10; _rdp_target=""; _rdp_dir=""; _rdp_out=""
    
    # å¿«é€Ÿè·¯å¾„: readlink -f
    _rdp_out=$(readlink -f "$_rdp_path" 2>/dev/null)
    [ -e "$_rdp_out" ] && { printf '%s\n' "$_rdp_out"; return 0; }
    
    # å›é€€è·¯å¾„: æ‰‹åŠ¨é€’å½’è§£æ
    while [ -L "$_rdp_path" ] && [ "$_rdp_limit" -gt 0 ]; do
        _rdp_target=$(readlink "$_rdp_path" 2>/dev/null)
        # å…¼å®¹æ€§å›é€€: ls -l è§£æ
        if [ -z "$_rdp_target" ]; then
            _rdp_ls_out=$(ls -l "$_rdp_path" 2>/dev/null)
            case "$_rdp_ls_out" in *" -> "*) _rdp_target="${_rdp_ls_out##* -> }" ;; *) break ;; esac
        fi
        
        _rdp_target="${_rdp_target## }"; _rdp_target="${_rdp_target%% }"
        [ -z "$_rdp_target" ] && break
        
        case "$_rdp_target" in 
            /*) _rdp_path="$_rdp_target" ;;
            *) 
                _rdp_dir="${_rdp_path%/*}"
                [ "$_rdp_dir" = "$_rdp_path" ] && _rdp_dir="."
                _rdp_path="$_rdp_dir/$_rdp_target"
            ;;
        esac
        _rdp_limit=$((_rdp_limit - 1))
    done
    
    # è®°å½•é€’å½’æ·±åº¦è¶…é™æƒ…å†µï¼ˆç”¨äºè°ƒè¯•ï¼‰
    if [ -L "$_rdp_path" ] && [ "$_rdp_limit" -eq 0 ]; then
        # é€’å½’æ·±åº¦è¾¾åˆ°é™åˆ¶ï¼Œå¯èƒ½å­˜åœ¨å¾ªç¯é“¾æ¥
        # æ³¨æ„ï¼šç”Ÿäº§ç¯å¢ƒä¸è¾“å‡ºæ—¥å¿—ï¼Œä»…åœ¨è°ƒè¯•æ—¶å¯ç”¨
        : # å ä½ç¬¦
    fi
    
    # ç®€å•çš„è§„èŒƒåŒ– (ç§»é™¤ /./ï¼Œå¾ªç¯ç›´åˆ°ä¸åŒ…å«æ­¤æ¨¡å¼)
    while case "$_rdp_path" in */./*) true;; *) false;; esac; do
        _rdp_path="${_rdp_path%%/./*}/${_rdp_path#*/./}"
    done
    [ -e "$_rdp_path" ] && printf '%s\n' "$_rdp_path"
}

# è·å–æŒ‚è½½ç‚¹è®¾å¤‡ID
get_mountinfo_id() {
    _gmi_target_mnt="$1"; _gmi_decoded_mnt=""
    [ -r "/proc/self/mountinfo" ] || return 1
    while read -r _gmi_id _gmi_par _gmi_devid _gmi_root _gmi_mnt _gmi_rest; do
        _gmi_decoded_mnt=$(decode_path "$_gmi_mnt")
        if [ "$_gmi_decoded_mnt" = "$_gmi_target_mnt" ]; then printf '%s\n' "$_gmi_devid"; return 0; fi
    done < /proc/self/mountinfo
    return 1
}

# è·å–è®¾å¤‡å”¯ä¸€æŒ‡çº¹
get_device_fingerprint() {
    _gdf_path="$1"; _gdf_mnt="$2"; _gdf_real_path=""; _gdf_bname=""; _gdf_id=""
    
    _gdf_real_path=$(resolve_dev_path "$_gdf_path")
    
    # ä¼˜å…ˆçº§ 1: Stat 
    if [ "$HAS_STAT" = true ] && [ -e "$_gdf_real_path" ]; then
        _gdf_maj=""; _gdf_min=""; _gdf_stat_out=""; _gdf_maj_dec=""; _gdf_min_dec=""
        
        # å°è¯•ä½¿ç”¨ timeoutï¼ˆå¦‚æœå¯ç”¨ï¼‰ï¼Œå¦åˆ™ç›´æ¥æ‰§è¡Œ
        if [ "$HAS_TIMEOUT" = true ]; then
            _gdf_stat_out=$($TIMEOUT_CMD 2 $STAT_CMD -L -c '%t %T' "$_gdf_real_path" 2>/dev/null)
            # å¦‚æœ timeout å¤±è´¥ï¼ˆè¿”å›ç  124 è¡¨ç¤ºè¶…æ—¶ï¼‰ï¼Œå›é€€åˆ°æ—  timeout ç‰ˆæœ¬
            if [ $? -eq 124 ] 2>/dev/null; then
                _gdf_stat_out=$($STAT_CMD -L -c '%t %T' "$_gdf_real_path" 2>/dev/null)
            fi
        else
            _gdf_stat_out=$($STAT_CMD -L -c '%t %T' "$_gdf_real_path" 2>/dev/null)
        fi
        
        if [ -n "$_gdf_stat_out" ]; then
            _gdf_maj="${_gdf_stat_out%% *}"
            _gdf_min="${_gdf_stat_out##* }"
            
            # éªŒè¯åå…­è¿›åˆ¶æ ¼å¼
            case "$_gdf_maj$_gdf_min" in *[!0-9a-fA-F]*) ;; *)
                # å°è¯•åå…­è¿›åˆ¶è½¬æ¢ï¼ˆéªŒè¯ Shell å…¼å®¹æ€§ï¼‰
                _gdf_maj_dec=$(printf '%d' "0x$_gdf_maj" 2>/dev/null) || _gdf_maj_dec=""
                _gdf_min_dec=$(printf '%d' "0x$_gdf_min" 2>/dev/null) || _gdf_min_dec=""
                
                # ä»…åœ¨è½¬æ¢æˆåŠŸæ—¶è¿”å›
                if [ -n "$_gdf_maj_dec" ] && [ -n "$_gdf_min_dec" ]; then
                    printf "%d:%d" "$_gdf_maj_dec" "$_gdf_min_dec"
                    return 0
                fi
            ;; esac
        fi
    fi

    # ä¼˜å…ˆçº§ 2: Mountinfo
    if [ -n "$_gdf_mnt" ]; then
        _gdf_id=$(get_mountinfo_id "$_gdf_mnt")
        if [ -n "$_gdf_id" ]; then printf '%s\n' "$_gdf_id"; return 0; fi
    fi
    
    # ä¼˜å…ˆçº§ 3: Sysfs
    [ ! -e "$_gdf_real_path" ] && return 1
    _gdf_bname="${_gdf_real_path##*/}"
    if [ -r "/sys/class/block/$_gdf_bname/dev" ]; then
        read -r _gdf_id < "/sys/class/block/$_gdf_bname/dev"
        _gdf_id="${_gdf_id%% *}"
        if [ -n "$_gdf_id" ]; then printf '%s\n' "$_gdf_id"; return 0; fi
    fi
    
    # æœ€åçš„æ‰‹æ®µï¼šè·¯å¾„å“ˆå¸Œ
    printf '%s\n' "path_$_gdf_real_path"
    return 0
}

# ==============================================================================
# GC æ¥å£è®¾å¤‡å·è·å–ä¸åŒ¹é…
# ==============================================================================

# å®‰å…¨å†™å…¥ Sysfs èŠ‚ç‚¹
write_sysfs() {
    _ws_val="$1"
    _ws_node="$2"
    _ws_retry="${3:-1}"
    
    [ ! -e "$_ws_node" ] && return 1
    
    # ------------------------------------------------------
    # å°è¯• 1: æ ‡å‡†å†™å…¥ï¼ˆå¸¦æ¢è¡Œï¼‰
    # ------------------------------------------------------
    if echo "$_ws_val" > "$_ws_node" 2>/dev/null; then
        return 0
    fi
    
    # ------------------------------------------------------
    # å°è¯• 2: æ— æ¢è¡Œå†™å…¥ï¼ˆéƒ¨åˆ†å†…æ ¸å‚æ•°æ•æ„Ÿï¼‰
    # ------------------------------------------------------
    if printf '%s' "$_ws_val" > "$_ws_node" 2>/dev/null; then
        return 0
    fi
    
    # ------------------------------------------------------
    # å°è¯• 3: å»¶è¿Ÿé‡è¯•ï¼ˆå¤„ç† EBUSY ç­‰æš‚æ—¶æ€§é”™è¯¯ï¼‰
    # ------------------------------------------------------
    if [ "$_ws_retry" -gt 0 ]; then
        sleep 0.1
        write_sysfs "$_ws_val" "$_ws_node" $((_ws_retry - 1))
        return $?
    fi
    
    # æ‰€æœ‰å°è¯•å¤±è´¥
    return 1
}

# GC æ¨¡å¼å­—ç¬¦ä¸²è½¬æ•°å­—
gc_str_to_num() {
    _gstn_val="$1"
    
    case "$_gstn_val" in
        # æ ‡å‡†æ¨¡å¼
        0|"GC_NORMAL"|"")
            printf '0\n'
            ;;
        1|"GC_URGENT_HIGH"|"GC_URGENT")
            printf '1\n'
            ;;
        2|"GC_URGENT_LOW")
            printf '2\n'
            ;;
        3|"GC_URGENT_MID")
            printf '3\n'
            ;;
        # æœªçŸ¥å­—ç¬¦ä¸²ï¼Œå½’é›¶ï¼ˆå®‰å…¨ç­–ç•¥ï¼‰
        *[!0-9]*)
            printf '0\n'
            ;;
        # å·²ç»æ˜¯æ•°å­—ï¼Œç›´æ¥è¿”å›
        *)
            printf '%s\n' "$_gstn_val"
            ;;
    esac
}

# è·å–è®¾å¤‡çš„ Major:Minor å·
get_dev_mm() {
    _gdm_path="$1"
    _gdm_real=""
    
    # è§£æç¬¦å·é“¾æ¥
    _gdm_real=$(resolve_dev_path "$_gdm_path")
    [ -z "$_gdm_real" ] && _gdm_real="$_gdm_path"
    
    # ------------------------------------------------------
    # æ–¹æ¡ˆ A: stat å‘½ä»¤ (é¦–é€‰ï¼Œæœ€å¿«æœ€å‡†)
    # ------------------------------------------------------
    if [ "$HAS_STAT" = true ] && [ -e "$_gdm_real" ]; then
        _gdm_out=""
        
        # ä½¿ç”¨ timeout ä¿æŠ¤ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if [ "$HAS_TIMEOUT" = true ]; then
            _gdm_out=$($TIMEOUT_CMD 2 $STAT_CMD -L -c '%t:%T' "$_gdm_real" 2>/dev/null)
            # è¶…æ—¶å›é€€
            if [ $? -eq 124 ] 2>/dev/null; then
                _gdm_out=$($STAT_CMD -L -c '%t:%T' "$_gdm_real" 2>/dev/null)
            fi
        else
            _gdm_out=$($STAT_CMD -L -c '%t:%T' "$_gdm_real" 2>/dev/null)
        fi
        
        if [ -n "$_gdm_out" ]; then
            _gdm_maj="${_gdm_out%%:*}"
            _gdm_min="${_gdm_out##*:}"
            
            # éªŒè¯åå…­è¿›åˆ¶æ ¼å¼
            case "$_gdm_maj$_gdm_min" in
                *[!0-9a-fA-F]*) ;;
                *)
                    # Hex è½¬ Dec
                    _gdm_maj_dec=$(printf '%d' "0x$_gdm_maj" 2>/dev/null) || _gdm_maj_dec=""
                    _gdm_min_dec=$(printf '%d' "0x$_gdm_min" 2>/dev/null) || _gdm_min_dec=""
                    
                    if [ -n "$_gdm_maj_dec" ] && [ -n "$_gdm_min_dec" ]; then
                        printf '%d:%d\n' "$_gdm_maj_dec" "$_gdm_min_dec"
                        return 0
                    fi
                    ;;
            esac
        fi
    fi

    # ------------------------------------------------------
    # æ–¹æ¡ˆ B: ls -l è§£æ (å…¼å®¹æ€§å›é€€)
    # ------------------------------------------------------
    if [ -e "$_gdm_real" ]; then
        _gdm_ls=""
        _gdm_ls=$(ls -l "$_gdm_real" 2>/dev/null)
        
        if [ -n "$_gdm_ls" ]; then
            # å»é™¤é€—å·
            _gdm_ls=$(printf '%s' "$_gdm_ls" | tr -d ',')
            
            # è§£æ Major:Minor (å¯å‘å¼æ–¹æ³•ï¼šæŸ¥æ‰¾è¿ç»­çš„ä¸¤ä¸ªæ•°å­—)
            _gdm_maj=""; _gdm_min=""; _gdm_found_first=false
            
            for _gdm_field in $_gdm_ls; do
                if is_integer "$_gdm_field"; then
                    if [ "$_gdm_found_first" = false ]; then
                        _gdm_maj="$_gdm_field"
                        _gdm_found_first=true
                    else
                        _gdm_min="$_gdm_field"
                        break
                    fi
                fi
            done
            
            if [ -n "$_gdm_maj" ] && [ -n "$_gdm_min" ]; then
                printf '%d:%d\n' "$_gdm_maj" "$_gdm_min"
                return 0
            fi
        fi
    fi
    
    # ------------------------------------------------------
    # æ–¹æ¡ˆ C: Sysfs å›é€€ (æœ€ç»ˆå…œåº•)
    # ------------------------------------------------------
    _gdm_bname="${_gdm_real##*/}"
    if [ -r "/sys/class/block/$_gdm_bname/dev" ]; then
        _gdm_res=""
        read_first_line _gdm_res "/sys/class/block/$_gdm_bname/dev"
        if [ -n "$_gdm_res" ]; then
            printf '%s\n' "${_gdm_res%% *}"
            return 0
        fi
    fi
    
    return 1
}

# é€’å½’è§£æ dm è®¾å¤‡çš„åº•å±‚è®¾å¤‡ (slaves)
resolve_dm_slaves() {
    _rds_dev="$1"
    _rds_result="$_rds_dev"
    _rds_slaves_dir="/sys/class/block/$_rds_dev/slaves"
    
    # æ£€æŸ¥æ˜¯å¦ä¸º dm è®¾å¤‡
    [ ! -d "$_rds_slaves_dir" ] && { printf '%s\n' "$_rds_result"; return 0; }
    
    # éå† slaves (ç¬¬ 1 å±‚)
    for _rds_slave in "$_rds_slaves_dir"/*; do
        [ -e "$_rds_slave" ] || continue
        _rds_slave_name="${_rds_slave##*/}"
        _rds_result="$_rds_result $_rds_slave_name"
        
        # é€’å½’æŸ¥æ‰¾ slave çš„ slave (ç¬¬ 2 å±‚ï¼Œé™åˆ¶æ·±åº¦)
        _rds_slave2_dir="/sys/class/block/$_rds_slave_name/slaves"
        if [ -d "$_rds_slave2_dir" ]; then
            for _rds_slave2 in "$_rds_slave2_dir"/*; do
                [ -e "$_rds_slave2" ] || continue
                _rds_slave2_name="${_rds_slave2##*/}"
                _rds_result="$_rds_result $_rds_slave2_name"
                
                # ç¬¬ 3 å±‚ï¼ˆæœ€å¤šï¼‰
                _rds_slave3_dir="/sys/class/block/$_rds_slave2_name/slaves"
                if [ -d "$_rds_slave3_dir" ]; then
                    for _rds_slave3 in "$_rds_slave3_dir"/*; do
                        [ -e "$_rds_slave3" ] || continue
                        _rds_result="$_rds_result ${_rds_slave3##*/}"
                    done
                fi
            done
        fi
    done
    
    printf '%s\n' "$_rds_result"
    return 0
}

# è§£æ Trim è¾“å‡ºå­—èŠ‚æ•°
parse_trim_bytes() {
    _ptb_str="$1"; _ptb_val=""
    case "$_ptb_str" in
        *" bytes"*) 
            _ptb_val="${_ptb_str%% bytes*}"
            # ç§»é™¤éæ•°å­—å‰ç¼€
            _ptb_val="${_ptb_val##*[!0-9]}" 
            ;;
        *) 
            _ptb_word=""; _ptb_num=0; _ptb_clean=""
            for _ptb_word in $_ptb_str; do
                _ptb_clean="$_ptb_word"
                # æ¸…ç†å¸¸è§åç¼€å’Œæ ‡ç‚¹
                _ptb_clean="${_ptb_clean%:}"
                _ptb_clean="${_ptb_clean%;}"
                _ptb_clean="${_ptb_clean%,}"
                _ptb_clean="${_ptb_clean%bytes}"
                _ptb_clean="${_ptb_clean%B}"
                
                case "$_ptb_clean" in 
                    ''|*[!0-9]*) continue ;; 
                    *) 
                        # é˜²å¾¡æ€§æ£€æŸ¥ï¼šé˜²æ­¢32ä½æ•´æ•°æº¢å‡ºï¼ˆæœ€å¤§å€¼ 2147483647 = 10ä½ï¼‰
                        if [ "${#_ptb_clean}" -le 10 ]; then
                            # 32ä½å®‰å…¨èŒƒå›´ï¼šå®‰å…¨æ¯”è¾ƒ
                            if [ "$_ptb_clean" -gt "$_ptb_num" ] 2>/dev/null; then
                                _ptb_num="$_ptb_clean"
                            fi
                        elif [ "${#_ptb_clean}" -le 15 ]; then
                            # å¤§æ•°å­—ç›´æ¥é‡‡ç”¨ï¼ˆå‡å®šä¸ºçœŸå®å­—èŠ‚æ•°ï¼‰
                            _ptb_num="$_ptb_clean"
                        fi
                        # è¶…è¿‡15ä½ï¼šä¸¢å¼ƒï¼ˆå¯èƒ½æ˜¯å¼‚å¸¸è¾“å‡ºï¼‰
                    ;;
                esac
            done
            _ptb_val="$_ptb_num" ;;
    esac
    is_integer "$_ptb_val" && printf '%s\n' "$_ptb_val" || printf '%s\n' "0"
}

# ==============================================================================
# execute_trim_robust (æ™ºèƒ½è§£åŒ… + å¤šçº§å›é€€)
# æ™ºèƒ½è§£åŒ…ä»£ç†å‡½æ•° + sm fstrim å›é€€ + è¯¦ç»†æ—¥å¿—
# ==============================================================================
execute_trim_robust() {
    _etr_mnt="$1"; _etr_out=""; _etr_ret=1
    
    # ç»“æœæœ‰æ•ˆæ€§æ ¡éªŒ
    _etr_is_valid() {
        _etr_iv_r="$1"; _etr_iv_o="$2"
        [ "$_etr_iv_r" -eq 0 ] && return 0
        case "$_etr_iv_o" in
            *"bytes"*|*"trimmed"*|*"B "*|*" KB"*|*" MB"*) return 0 ;;
            "") return 0 ;;
        esac
        return 1
    }
    
    # ------------------------------------------------------
    # ä¼˜å…ˆçº§ 1: timeout + fstrim
    # ------------------------------------------------------
    if [ "$HAS_TIMEOUT" = true ] && [ "$HAS_FSTRIM" = true ]; then
        _etr_out=$($TIMEOUT_CMD $TRIM_TIMEOUT $FSTRIM_CMD -v "$_etr_mnt" 2>&1)
        _etr_ret=$?
        
        if _etr_is_valid "$_etr_ret" "$_etr_out"; then
            printf '%s\n' "$_etr_out"
            return 0
        fi
        
        # å¤±è´¥è¯Šæ–­
        log_msg "    â”œâ”€ âš ï¸ timeout+fstrim å¤±è´¥ [é€€å‡ºç : $_etr_ret]"
        [ -n "$_etr_out" ] && log_msg "            â””â”€ è¾“å‡º: $_etr_out"
    fi
    
    # ------------------------------------------------------
    # ä¼˜å…ˆçº§ 2: fstrim ç›´æ¥è°ƒç”¨
    # ------------------------------------------------------
    if [ "$HAS_FSTRIM" = true ]; then
        _etr_out=$($FSTRIM_CMD -v "$_etr_mnt" 2>&1)
        _etr_ret=$?
        
        if _etr_is_valid "$_etr_ret" "$_etr_out"; then
            printf '%s\n' "$_etr_out"
            return 0
        fi
        
        log_msg "    â”œâ”€ âš ï¸ fstrim å¤±è´¥ [é€€å‡ºç : $_etr_ret]"
        [ -n "$_etr_out" ] && log_msg "            â””â”€ è¾“å‡º: $_etr_out"
    fi
    
    # ------------------------------------------------------
    # ä¼˜å…ˆçº§ 3: Busybox fstrim è£¸è°ƒï¼ˆæœ€åæ‰‹æ®µï¼‰
    # ------------------------------------------------------
    if [ -n "$BB_PATH" ]; then
        _etr_out=$("$BB_PATH" fstrim -v "$_etr_mnt" 2>&1)
        _etr_ret=$?
        
        if _etr_is_valid "$_etr_ret" "$_etr_out"; then
            printf '%s\n' "$_etr_out"
            return 0
        fi
    fi
    
    # ------------------------------------------------------
    # ä¼˜å…ˆçº§ 4: sm fstrim (Android ä¸“ç”¨ï¼Œå…¨å±€ Trim)
    # ------------------------------------------------------
    if [ "$SM_FSTRIM_CALLED" = false ] && command -v sm >/dev/null 2>&1; then
        _etr_out=$(sm fstrim 2>&1)
        _etr_ret=$?
        SM_FSTRIM_CALLED=true
        
        if [ "$_etr_ret" -eq 0 ]; then
            printf '%s\n' "$_etr_out"
            return 0
        fi
    fi
    
    # æ‰€æœ‰æ–¹æ³•å‡å¤±è´¥
    printf '%s\n' "${_etr_out:-[Trim ä¸å¯ç”¨]}"
    return 127
}



# ==============================================================================
# çŠ¶æ€æ£€æµ‹ä¸å¹¶å‘é”
# ==============================================================================

# å±å¹•çŠ¶æ€æ£€æµ‹ (åŠ¨æ€åˆå§‹åŒ–)
init_screen_check() {
    _isc_node=""; _isc_val=""

    # ç­–ç•¥ 1: DRM èŠ‚ç‚¹ (æœ€å¿«/æœ€å‡†)
    for _isc_node in /sys/class/drm/card*/enabled; do
        [ -e "$_isc_node" ] || continue
        [ -r "$_isc_node" ] || continue
        read -r _isc_val < "$_isc_node" 2>/dev/null
        if [ "$_isc_val" = "enabled" ] || [ "$_isc_val" = "disabled" ]; then
            eval "is_screen_on() { read -r _iso_v < \"$_isc_node\" 2>/dev/null; [ \"\$_iso_v\" = \"enabled\" ]; }"
            return 0
        fi
    done

    # ç­–ç•¥ 2: èƒŒå…‰äº®åº¦ (é€šç”¨)
    for _isc_node in /sys/class/backlight/*/brightness; do
        [ -e "$_isc_node" ] || continue
        [ -r "$_isc_node" ] || continue
        read -r _isc_val < "$_isc_node" 2>/dev/null
        if is_integer "$_isc_val"; then
            [ "$_isc_val" -gt 0 ] && return 0
        fi
    done

    # ç­–ç•¥ 3: API çŠ¶æ€ (å›é€€)
    if command -v getprop >/dev/null 2>&1; then
        _isc_val=$(getprop sys.display.state 2>/dev/null)
        if [ -n "$_isc_val" ]; then
            is_screen_on() { 
                case "$(getprop sys.display.state 2>/dev/null)" in ON|DOZE) return 0 ;; *) return 1 ;; esac 
            }
            return 0
        fi
    fi

    # ç­–ç•¥ 4: Dumpsys (æœ€æ…¢ï¼Œä»…ä½œä¸ºæœ€åæ‰‹æ®µï¼Œä¸”é™åˆ¶é¢‘ç‡)
    _LAST_SCREEN_CHECK=0
    _LAST_SCREEN_STATE=1

    is_screen_on() {
        _iso_now=""
        _iso_now=$(date +%s)
        if [ $((_iso_now - _LAST_SCREEN_CHECK)) -lt 5 ]; then
            return $_LAST_SCREEN_STATE
        fi
        _LAST_SCREEN_CHECK=$_iso_now
        if dumpsys power 2>/dev/null | {
            while IFS= read -r _iso_line; do
                case "$_iso_line" in
                    *"mWakefulness=Awake"*)
                        exit 0 
                        ;;
                esac
            done
            exit 1
        }; then
            _LAST_SCREEN_STATE=0
            return 0
        else
            _LAST_SCREEN_STATE=1
            return 1
        fi
    }
}

# åˆå§‹åŒ–å±å¹•æ£€æµ‹
init_screen_check

is_charging() {
    _ic_val=""; _ic_node=""
    if [ -f "/sys/class/power_supply/battery/status" ]; then
        read_first_line _ic_val "/sys/class/power_supply/battery/status"
        case "$_ic_val" in Charging|Full) return 0 ;; esac
    fi
    for _ic_node in /sys/class/power_supply/*/online; do
        [ -e "$_ic_node" ] || continue
        read_first_line _ic_val "$_ic_node"; [ "$_ic_val" = "1" ] && return 0
    done
    return 1
}

acquire_lock() {
    _al_retry=0; _al_max_retry=3
    _al_start_time=$(date +%s)
    _al_lock_timeout=1800  # é”è¶…æ—¶æ—¶é—´ï¼š30 åˆ†é’Ÿ
    
    while [ "$_al_retry" -lt "$_al_max_retry" ]; do
        # åŸå­æ“ä½œï¼šmkdir æˆåŠŸå³è·å–é”
        if mkdir "$LOCK_DIR" 2>/dev/null; then
            echo "$CURRENT_PID" > "$LOCK_PID_FILE"
            # åˆ›å»ºæ—¶é—´æˆ³æ–‡ä»¶
            date +%s > "$LOCK_DIR/timestamp" 2>/dev/null
            return 0
        fi
        
        # ------------------------------------------------------
        # æ–°å¢ï¼šåƒµå°¸é”æ£€æµ‹ï¼ˆè¶…æ—¶æ¸…ç†ï¼‰
        # ------------------------------------------------------
        if [ -f "$LOCK_DIR/timestamp" ]; then
            _al_ts=""
            read_first_line _al_ts "$LOCK_DIR/timestamp"
            
            if is_integer "$_al_ts"; then
                _al_now=$(date +%s)
                _al_age=$((_al_now - _al_ts))
                
                # å¦‚æœé”æ–‡ä»¶å­˜åœ¨è¶…è¿‡ 30 åˆ†é’Ÿï¼Œè§†ä¸ºåƒµå°¸é”ï¼Œå¼ºåˆ¶æ¸…ç†
                if [ "$_al_age" -gt "$_al_lock_timeout" ]; then
                    log_msg "âš ï¸ æ£€æµ‹åˆ°åƒµå°¸é” [å¹´é¾„: ${_al_age}ç§’ > ${_al_lock_timeout}ç§’]ï¼Œå¼ºåˆ¶æ¸…ç†"
                    rm -rf "$LOCK_DIR" 2>/dev/null
                    continue  # ç«‹å³é‡è¯•
                fi
            fi
        fi
        # ------------------------------------------------------
        
        # éªŒè¯é”æ–‡ä»¶å®Œæ•´æ€§
        if [ ! -f "$LOCK_PID_FILE" ]; then
            # é”ç›®å½•å­˜åœ¨ä½†PIDæ–‡ä»¶ç¼ºå¤±ï¼Œå¯èƒ½æ˜¯åˆ›å»ºä¸­æ–­
            sleep 1
            [ ! -f "$LOCK_PID_FILE" ] && rm -rf "$LOCK_DIR" 2>/dev/null
            _al_retry=$((_al_retry + 1))
            continue
        fi
        
        # è¯»å–å¹¶éªŒè¯PID
        _al_pid=""
        read_first_line _al_pid "$LOCK_PID_FILE"
        
        # PID ç©ºå€¼å’Œæ ¼å¼éªŒè¯
        if [ -z "$_al_pid" ] || ! is_integer "$_al_pid"; then
            rm -rf "$LOCK_DIR" 2>/dev/null
            _al_retry=$((_al_retry + 1))
            continue
        fi
        
        # è¿›ç¨‹å­˜æ´»æ£€æŸ¥
        if [ ! -d "/proc/$_al_pid" ]; then
            # è¿›ç¨‹å·²æ­»ï¼Œæ¸…ç†é™ˆæ—§é”
            rm -rf "$LOCK_DIR" 2>/dev/null
            _al_retry=$((_al_retry + 1))
            continue
        fi
        
        # ç²¾ç¡®åŒ¹é…ï¼šæ£€æŸ¥è¿›ç¨‹æ˜¯å¦çœŸçš„æ˜¯ f2fsopt
        _al_cmd=""
        read -r _al_cmd < "/proc/$_al_pid/cmdline" 2>/dev/null
        # POSIX å…¼å®¹ï¼šä½¿ç”¨å‚æ•°æ‰©å±•åˆ†å‰²è€Œéå­—ç¬¦ç±»
        _al_cmd="${_al_cmd%% *}"  # æå–ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆç©ºæ ¼åˆ†å‰²ï¼‰
        _al_cmd="${_al_cmd%%	*}"  # æå–ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆåˆ¶è¡¨ç¬¦åˆ†å‰²ï¼‰
        case "$_al_cmd" in
            */"$SCRIPT_NAME"|"$SCRIPT_NAME")
                # ç¡®å®æ˜¯åŒåè„šæœ¬åœ¨è¿è¡Œ
                # è®°å½•é”æŒæœ‰è€…ä¿¡æ¯
                _al_lock_time=""
                if [ -f "$LOCK_DIR/timestamp" ]; then
                    read -r _al_lock_time < "$LOCK_DIR/timestamp" 2>/dev/null
                    _al_now=$(date +%s)
                    _al_duration=$((_al_now - _al_lock_time))
                    log_msg "é”è¢«å ç”¨ [PID:$_al_pid, æŒç»­:${_al_duration}ç§’]"
                else
                    log_msg "é”è¢«å ç”¨ [PID:$_al_pid]"
                fi
                return 1
                ;;
            *)
                # PIDè¢«å¤ç”¨ï¼Œæ¸…ç†é™ˆæ—§é”
                rm -rf "$LOCK_DIR" 2>/dev/null
                _al_retry=$((_al_retry + 1))
                continue
                ;;
        esac
    done
    
    # é‡è¯•è€—å°½
    _al_end_time=$(date +%s)
    _al_total_time=$((_al_end_time - _al_start_time))
    log_msg "é”è·å–å¤±è´¥ [é‡è¯•:$_al_max_retryæ¬¡, è€—æ—¶:${_al_total_time}ç§’]"
    return 1
}
# GC çŠ¶æ€æ¢å¤
restore_gc_state_robust() {
    _rgsr_node="$1"
    _rgsr_val="$2"
    
    # è½¬æ¢ä¸ºæ•°å­—æ ¼å¼ï¼ˆå¦‚æœæ˜¯å­—ç¬¦ä¸²ï¼‰
    _rgsr_num=$(gc_str_to_num "$_rgsr_val")
    
    # å°è¯• 1: ä½¿ç”¨ write_sysfs æ¢å¤æ•°å­—å€¼
    if write_sysfs "$_rgsr_num" "$_rgsr_node" 2; then
        return 0
    fi
    
    # å°è¯• 2: å¦‚æœåŸå€¼æ˜¯å­—ç¬¦ä¸²ï¼Œå°è¯•æ¢å¤å­—ç¬¦ä¸²
    case "$_rgsr_val" in
        *[!0-9]*)
            if write_sysfs "$_rgsr_val" "$_rgsr_node" 2; then
                log_msg "âš ï¸ GC çŠ¶æ€ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼æ¢å¤ [$_rgsr_val]"
                return 0
            fi
            ;;
    esac
    
    # å°è¯• 3: å¼ºåˆ¶æ¢å¤ä¸º 0ï¼ˆå®‰å…¨å€¼ï¼‰
    if write_sysfs "0" "$_rgsr_node" 2; then
        log_msg "âš ï¸ GC çŠ¶æ€ä½¿ç”¨å®‰å…¨å€¼æ¢å¤ [0]"
        return 0
    fi
    
    # å°è¯• 4: å°è¯•å­—ç¬¦ä¸²æšä¸¾ï¼ˆæœ€åæ‰‹æ®µï¼‰
    for _rgsr_fallback in "GC_NORMAL" ""; do
        if write_sysfs "$_rgsr_fallback" "$_rgsr_node" 1; then
            log_msg "âš ï¸ GC çŠ¶æ€ä½¿ç”¨å¤‡ç”¨å€¼æ¢å¤ [$_rgsr_fallback]"
            return 0
        fi
    done
    
    return 1
}

# å­è¿›ç¨‹æ¸…ç†
cleanup_child_processes() {
    _ccp_cleaned=0
    
    # éå† /proc æŸ¥æ‰¾å­è¿›ç¨‹
    for _ccp_p in /proc/[0-9]*; do
        [ -d "$_ccp_p" ] || continue
        _ccp_pid="${_ccp_p##*/}"
        
        case "$_ccp_pid" in *[!0-9]*) continue ;; esac
        [ "$_ccp_pid" = "$CURRENT_PID" ] && continue
        
        # è¯»å–çˆ¶è¿›ç¨‹ PID
        read -r _ _ _ _ccp_ppid _ < "$_ccp_p/stat" 2>/dev/null || continue
        
        if [ "$_ccp_ppid" = "$CURRENT_PID" ]; then
            # ä¼˜é›…ç»ˆæ­¢
            if kill -TERM "$_ccp_pid" 2>/dev/null; then
                _ccp_cleaned=$((_ccp_cleaned + 1))
                sleep 1
                # å¼ºåˆ¶ç»ˆæ­¢ï¼ˆå¦‚æœè¿˜å­˜æ´»ï¼‰
                [ -d "$_ccp_p" ] && kill -KILL "$_ccp_pid" 2>/dev/null
            else
                log_msg "âš ï¸ å­è¿›ç¨‹æ¸…ç†å¤±è´¥ [PID:$_ccp_pid]"
            fi
        fi
    done
    
    [ "$_ccp_cleaned" -gt 0 ] && log_msg "æ¸…ç†äº† $_ccp_cleaned ä¸ªå­è¿›ç¨‹"
}

cleanup() {
    _cu_code="${1:-$EXIT_CODE}"
    trap - EXIT TERM INT HUP QUIT ABRT
    
    # å­è¿›ç¨‹æ¸…ç†
    cleanup_child_processes
    
    # é‡Šæ”¾å”¤é†’é”
    if [ "$HAS_ACQUIRED_WAKELOCK" = true ]; then
        if ! write_sysfs "$WAKE_LOCK_ID" "/sys/power/wake_unlock"; then
            log_msg "âš ï¸ æ¸…ç†è­¦å‘Š: å”¤é†’é”é‡Šæ”¾å¤±è´¥ [ID:$WAKE_LOCK_ID]"
        fi
    fi
    
    # GC çŠ¶æ€æ¢å¤
    if [ -n "$ACTIVE_GC_NODE" ] && [ -n "$RESTORE_GC_VAL" ]; then
        if ! restore_gc_state_robust "$ACTIVE_GC_NODE" "$RESTORE_GC_VAL"; then
            log_msg "âŒ æ¸…ç†å¤±è´¥: GC çŠ¶æ€æ— æ³•æ¢å¤"
            log_msg "   èŠ‚ç‚¹: $ACTIVE_GC_NODE"
            log_msg "   æœŸæœ›å€¼: $RESTORE_GC_VAL"
            log_msg "   å½“å‰å€¼: $(cat "$ACTIVE_GC_NODE" 2>/dev/null || echo "æ— æ³•è¯»å–")"
            log_msg "   æ‰‹åŠ¨ä¿®å¤: echo $RESTORE_GC_VAL > $ACTIVE_GC_NODE"
        fi
    fi
    
    # sleep_time æ¢å¤
    if [ -n "$ACTIVE_SLEEP_NODE" ] && [ -n "$RESTORE_SLEEP_VAL" ]; then
        if ! write_sysfs "$RESTORE_SLEEP_VAL" "$ACTIVE_SLEEP_NODE"; then
            log_msg "âš ï¸ æ¸…ç†è­¦å‘Š: sleep_time æ¢å¤å¤±è´¥ [$ACTIVE_SLEEP_NODE=$RESTORE_SLEEP_VAL]"
        fi
    fi
    
    # é”ç›®å½•æ¸…ç†
    if ! rm -rf "$LOCK_DIR" 2>/dev/null; then
        _cu_err=$?
        log_msg "âš ï¸ æ¸…ç†è­¦å‘Š: é”ç›®å½•åˆ é™¤å¤±è´¥ [è·¯å¾„:$LOCK_DIR, errno:$_cu_err]"
        # å°è¯•è¯Šæ–­åŸå› 
        if [ ! -w "${LOCK_DIR%/*}" ]; then
            log_msg "   åŸå› : çˆ¶ç›®å½•æ— å†™æƒé™"
        elif command -v tail >/dev/null 2>&1 && command -v awk >/dev/null 2>&1; then
            _cu_avail=$(df "$LOCK_DIR" 2>/dev/null | tail -1 | awk '{print $4}')
            [ "$_cu_avail" = "0" ] && log_msg "   åŸå› : ç£ç›˜ç©ºé—´ä¸è¶³"
        fi
    fi
    
    if [ "$_cu_code" -ne 0 ]; then 
        log_msg "âŒ é€€å‡º [Code: $_cu_code]"
    fi
    exit "$_cu_code"
}

# ==============================================================================
# é…ç½®éªŒè¯
# ==============================================================================

# é…ç½®éªŒè¯
validate_config() {
    _vc_errors=0
    
    # éªŒè¯ GC_DIRTY_MIN
    if ! is_integer "$GC_DIRTY_MIN" || [ "$GC_DIRTY_MIN" -lt 0 ] || [ "$GC_DIRTY_MIN" -gt 10000 ]; then
        log_msg "âš ï¸ é…ç½®é”™è¯¯: GC_DIRTY_MIN=$GC_DIRTY_MIN ä¸åœ¨ [0, 10000] èŒƒå›´å†…ï¼Œä½¿ç”¨é»˜è®¤å€¼ 200"
        GC_DIRTY_MIN=200
        _vc_errors=$((_vc_errors + 1))
    fi
    
    # éªŒè¯ TRIM_TIMEOUT
    if ! is_integer "$TRIM_TIMEOUT" || [ "$TRIM_TIMEOUT" -lt 1 ] || [ "$TRIM_TIMEOUT" -gt 3600 ]; then
        log_msg "âš ï¸ é…ç½®é”™è¯¯: TRIM_TIMEOUT=$TRIM_TIMEOUT ä¸åœ¨ [1, 3600] èŒƒå›´å†…ï¼Œä½¿ç”¨é»˜è®¤å€¼ 500"
        TRIM_TIMEOUT=500
        _vc_errors=$((_vc_errors + 1))
    fi
    
    return "$_vc_errors"
}

# ==============================================================================
# æ‰§è¡Œé€»è¾‘
# ==============================================================================

do_system_action() {
    _dsa_path="$1"; _dsa_type="$2"
    if command -v sm >/dev/null 2>&1; then
        if [ "$_dsa_type" = "trim" ]; then
            # æ£€æŸ¥ sm fstrim æ˜¯å¦å·²è¢«è°ƒç”¨ï¼ˆå…¨å±€æ“ä½œï¼Œä¸€æ¬¡å³å¯ï¼‰
            if [ "$SM_FSTRIM_CALLED" = true ]; then
                log_msg "               â„¹ï¸ å·²åœ¨å…¶ä»–åˆ†åŒºæ‰§è¡Œï¼Œè·³è¿‡é‡å¤è°ƒç”¨"
                return 0
            fi
            
            # è°ƒç”¨ sm fstrim å¹¶è®°å½•ï¼ˆä¿ç•™è¾“å‡ºç”¨äºè¯Šæ–­ï¼‰
            _dsa_sm_out=""; _dsa_sm_ret=0
            _dsa_sm_out=$(sm fstrim 2>&1)
            _dsa_sm_ret=$?
            SM_FSTRIM_CALLED=true
            
            if [ "$_dsa_sm_ret" -eq 0 ]; then
                log_msg "               âœ… sm fstrim æˆåŠŸ [å…¨å±€Trim]"
                [ -n "$_dsa_sm_out" ] && log_msg "                  è¾“å‡º: $_dsa_sm_out"
                return 0
            else
                log_msg "               âš ï¸ sm fstrim å¤±è´¥ [é€€å‡ºç : $_dsa_sm_ret]"
                [ -n "$_dsa_sm_out" ] && log_msg "                  è¾“å‡º: $_dsa_sm_out"
                return 1
            fi
        else
            # GC: sm idle-maint runï¼ˆå…¨å±€æ“ä½œï¼Œé¿å…é‡å¤è°ƒç”¨ï¼‰
            if [ "$SM_IDLE_MAINT_CALLED" = true ]; then
                log_msg "               â„¹ï¸ å·²åœ¨å…¶ä»–åˆ†åŒºæ‰§è¡Œï¼Œè·³è¿‡é‡å¤è°ƒç”¨"
                return 0
            fi
            
            # è°ƒç”¨ sm idle-maint å¹¶è®°å½•ï¼ˆä¿ç•™è¾“å‡ºç”¨äºè¯Šæ–­ï¼‰
            _dsa_sm_out=""; _dsa_sm_ret=0
            _dsa_sm_out=$(sm idle-maint run 2>&1)
            _dsa_sm_ret=$?
            SM_IDLE_MAINT_CALLED=true
            COUNT_SYS_API=$((COUNT_SYS_API + 1))
            
            if [ "$_dsa_sm_ret" -eq 0 ]; then
                log_msg "               âœ… sm idle-maint æˆåŠŸ [å…¨å±€ç»´æŠ¤]"
                [ -n "$_dsa_sm_out" ] && log_msg "                  è¾“å‡º: $_dsa_sm_out"
                return 0
            else
                log_msg "               âš ï¸ sm idle-maint å¤±è´¥ [é€€å‡ºç : $_dsa_sm_ret]"
                [ -n "$_dsa_sm_out" ] && log_msg "                  è¾“å‡º: $_dsa_sm_out"
                return 1
            fi
        fi
    fi
    return 1
}

# æŸ¥æ‰¾ F2FS sysfs èŠ‚ç‚¹
find_f2fs_node() {
    _ffn_dev_path="$1"
    _ffn_bname="${_ffn_dev_path##*/}"
    _ffn_target_mm=""
    _ffn_candidates=""
    
    # å‡†å¤‡æœç´¢è·¯å¾„ï¼šæ ‡å‡† F2FS å’Œå°ç±³ MIFS
    _ffn_search_dirs="/sys/fs/f2fs /sys/fs/mifs"
    
    # ------------------------------------------------------
    # é˜¶æ®µ 0: å¿«é€Ÿè·¯å¾„ - ç›®å½•åç›´æ¥åŒ¹é…
    # ------------------------------------------------------
    for _ffn_base in $_ffn_search_dirs; do
        [ -d "$_ffn_base/$_ffn_bname" ] && { printf '%s\n' "$_ffn_base/$_ffn_bname"; return 0; }
    done
    
    # ------------------------------------------------------
    # é˜¶æ®µ 1: é»„é‡‘æ ‡å‡† - Major:Minor è®¾å¤‡å·ç²¾ç¡®åŒ¹é…
    # ------------------------------------------------------
    _ffn_target_mm=$(get_dev_mm "$_ffn_dev_path")
    
    if [ -n "$_ffn_target_mm" ]; then
        # è·å– dm è®¾å¤‡çš„å€™é€‰åˆ—è¡¨
        _ffn_candidates=$(resolve_dm_slaves "$_ffn_bname")
        
        # éå†æ‰€æœ‰ sysfs èŠ‚ç‚¹ï¼Œé€šè¿‡è®¾å¤‡å·åŒ¹é…
        for _ffn_base in $_ffn_search_dirs; do
            [ -d "$_ffn_base" ] || continue
            
            for _ffn_d in "$_ffn_base"/*; do
                [ -d "$_ffn_d" ] || continue
                
                # æ£€æŸ¥ sysfs ä¸‹çš„ dev æ–‡ä»¶ (superblock å¯¹åº”çš„è®¾å¤‡å·)
                if [ -r "$_ffn_d/dev" ]; then
                    _ffn_curr_mm=""
                    read_first_line _ffn_curr_mm "$_ffn_d/dev"
                    _ffn_curr_mm="${_ffn_curr_mm%% *}"
                    
                    if [ "$_ffn_curr_mm" = "$_ffn_target_mm" ]; then
                        printf '%s\n' "$_ffn_d"
                        return 0
                    fi
                fi
            done
        done
    fi
    
    # ------------------------------------------------------
    # é˜¶æ®µ 2: ä¼ ç»Ÿæ–¹æ³• - åç§°åŒ¹é… (å›é€€æœºåˆ¶)
    # ------------------------------------------------------
    # å¦‚æœæ²¡æœ‰å€™é€‰åˆ—è¡¨ï¼Œä½¿ç”¨åŸºç¡€åç§°
    [ -z "$_ffn_candidates" ] && _ffn_candidates="$_ffn_bname"
    
    for _ffn_base in $_ffn_search_dirs; do
        [ -d "$_ffn_base" ] || continue
        
        # 2.1: å°è¯•åŒ¹é… dev_name æ–‡ä»¶å†…å®¹
        for _ffn_d in "$_ffn_base"/*; do
            [ -d "$_ffn_d" ] || continue
            [ -f "$_ffn_d/dev_name" ] || continue
            
            _ffn_iname=""
            read_first_line _ffn_iname "$_ffn_d/dev_name"
            _ffn_iname="${_ffn_iname%% *}"
            
            # éå†æ‰€æœ‰å€™é€‰è®¾å¤‡å
            for _ffn_cand in $_ffn_candidates; do
                case "$_ffn_iname" in
                    "$_ffn_dev_path"|"/dev/block/$_ffn_cand"|"$_ffn_cand")
                        printf '%s\n' "$_ffn_d"
                        return 0
                        ;;
                esac
            done
            
            # å…¼å®¹è®¾å¤‡å·æ ¼å¼çš„ dev_name
            if [ -n "$_ffn_target_mm" ] && [ "$_ffn_iname" = "$_ffn_target_mm" ]; then
                printf '%s\n' "$_ffn_d"
                return 0
            fi
        done
    done
    
    # ------------------------------------------------------
    # é˜¶æ®µ 3: æ¨¡ç³ŠåŒ¹é… (æœ€åæ‰‹æ®µ)
    # ------------------------------------------------------
    for _ffn_base in $_ffn_search_dirs; do
        [ -d "$_ffn_base" ] || continue
        
        for _ffn_d in "$_ffn_base"/*; do
            [ -d "$_ffn_d" ] || continue
            [ -f "$_ffn_d/dev_name" ] || continue
            
            _ffn_iname=""
            read_first_line _ffn_iname "$_ffn_d/dev_name"
            
            for _ffn_cand in $_ffn_candidates; do
                case "$_ffn_iname" in
                    *"/${_ffn_cand}"|"${_ffn_cand}")
                        printf '%s\n' "$_ffn_d"
                        return 0
                        ;;
                esac
            done
        done
    done
    
    # ------------------------------------------------------
    # åŒ¹é…å¤±è´¥ - è¿”å›å¤±è´¥ï¼ˆä¸è¾“å‡ºè¯Šæ–­ï¼Œç”±è°ƒç”¨æ–¹å†³å®šï¼‰
    # ------------------------------------------------------
    return 1
}

# è¾“å‡º GC æ¥å£è¯Šæ–­ä¿¡æ¯
# å‚æ•°: $1 - è®¾å¤‡è·¯å¾„, $2 - sysfs èŠ‚ç‚¹è·¯å¾„(å¯é€‰)
log_gc_diagnostic() {
    _lgd_dev="$1"
    _lgd_node="$2"
    _lgd_bname="${_lgd_dev##*/}"
    _lgd_mm=""
    _lgd_real=""
    _lgd_slaves=""
    
    log_msg "    â”œâ”€ [è¯Šæ–­] GC æ¥å£æŸ¥æ‰¾å¤±è´¥"
    
    # è®¾å¤‡ä¿¡æ¯
    _lgd_mm=$(get_dev_mm "$_lgd_dev")
    log_msg "            ç›®æ ‡è®¾å¤‡: $_lgd_bname (è®¾å¤‡ID: ${_lgd_mm:-æ— æ³•è·å–})"
    
    # ç¬¦å·é“¾æ¥ä¿¡æ¯
    _lgd_real=$(resolve_dev_path "$_lgd_dev")
    if [ "$_lgd_real" != "$_lgd_dev" ]; then
        log_msg "            ç¬¦å·é“¾æ¥: $_lgd_dev -> $_lgd_real"
    fi
    
    # dm slaves ä¿¡æ¯
    if [ -d "/sys/class/block/$_lgd_bname/slaves" ]; then
        _lgd_slaves=$(resolve_dm_slaves "$_lgd_bname")
        log_msg "            dm slaves: ${_lgd_slaves#* }"  # å»æ‰ç¬¬ä¸€ä¸ªï¼ˆè‡ªå·±ï¼‰
    fi
    
    # å‘ç°çš„ sysfs èŠ‚ç‚¹
    _lgd_found_nodes=""
    for _lgd_base in /sys/fs/f2fs /sys/fs/mifs; do
        [ -d "$_lgd_base" ] || continue
        for _lgd_d in "$_lgd_base"/*; do
            [ -d "$_lgd_d" ] || continue
            _lgd_found_nodes="$_lgd_found_nodes ${_lgd_d##*/}"
        done
    done
    
    if [ -n "$_lgd_found_nodes" ]; then
        log_msg "            å‘ç°èŠ‚ç‚¹:$_lgd_found_nodes"
    else
        log_msg "            å‘ç°èŠ‚ç‚¹: æ— "
    fi
    
    # èŠ‚ç‚¹è¯¦æƒ…ï¼ˆä»…è¾“å‡ºå‰ 3 ä¸ªï¼Œé¿å…æ—¥å¿—è¿‡é•¿ï¼‰
    _lgd_count=0
    for _lgd_base in /sys/fs/f2fs /sys/fs/mifs; do
        [ -d "$_lgd_base" ] || continue
        for _lgd_d in "$_lgd_base"/*; do
            [ -d "$_lgd_d" ] || continue
            [ "$_lgd_count" -ge 3 ] && break 2
            
            _lgd_node_mm=""
            _lgd_node_name=""
            [ -f "$_lgd_d/dev" ] && read_first_line _lgd_node_mm "$_lgd_d/dev"
            [ -f "$_lgd_d/dev_name" ] && read_first_line _lgd_node_name "$_lgd_d/dev_name"
            
            _lgd_match=""
            [ "$_lgd_node_mm" = "$_lgd_mm" ] && _lgd_match=" âœ“ åŒ¹é…"
            
            log_msg "              - ${_lgd_d##*/}: dev=$_lgd_node_mm, dev_name=$_lgd_node_name$_lgd_match"
            _lgd_count=$((_lgd_count + 1))
        done
    done
    
    # GC æ¥å£å¯ç”¨æ€§ï¼ˆå¦‚æœæä¾›äº†èŠ‚ç‚¹è·¯å¾„ï¼‰
    if [ -n "$_lgd_node" ]; then
        log_msg "            GC æ¥å£:"
        if [ -f "$_lgd_node/gc_urgent_mode" ]; then
            if [ -w "$_lgd_node/gc_urgent_mode" ]; then
                log_msg "              - gc_urgent_mode: å­˜åœ¨ä¸”å¯å†™"
            else
                log_msg "              - gc_urgent_mode: å­˜åœ¨ä½†åªè¯»"
            fi
        else
            log_msg "              - gc_urgent_mode: ä¸å­˜åœ¨"
        fi
        
        if [ -f "$_lgd_node/gc_urgent" ]; then
            if [ -w "$_lgd_node/gc_urgent" ]; then
                log_msg "              - gc_urgent: å­˜åœ¨ä¸”å¯å†™"
            else
                log_msg "              - gc_urgent: å­˜åœ¨ä½†åªè¯»"
            fi
        else
            log_msg "              - gc_urgent: ä¸å­˜åœ¨"
        fi
    fi
}

process_target() {
    _pt_mnt="$1"; _pt_raw_dev="$2"; _pt_fstype="$3"
    _pt_real_dev=""; _pt_bname=""; _pt_node=""; _pt_is_healthy=false; _pt_s_dirty="0"
    
    # å‚æ•°ç©ºå€¼æ£€æŸ¥
    if [ -z "$_pt_mnt" ] || [ -z "$_pt_raw_dev" ] || [ -z "$_pt_fstype" ]; then
        log_msg "âš ï¸ è·³è¿‡: å‚æ•°ä¸å®Œæ•´ [mnt=$_pt_mnt, dev=$_pt_raw_dev, fs=$_pt_fstype]"
        return 1
    fi
    
    _pt_real_dev=$(resolve_dev_path "$_pt_raw_dev")
    
    # è®¾å¤‡è·¯å¾„éªŒè¯
    if [ -z "$_pt_real_dev" ]; then
        log_msg "âš ï¸ è·³è¿‡: æ— æ³•è§£æè®¾å¤‡è·¯å¾„ [$_pt_raw_dev]"
        return 1
    fi
    
    _pt_bname="${_pt_real_dev##*/}"
    _pt_node=$(find_f2fs_node "$_pt_real_dev")

    log_msg "â© ç›®æ ‡: $_pt_mnt [$_pt_fstype]"
    
    # è·å–è®¾å¤‡å·ï¼ˆç”¨äºè°ƒè¯•ï¼‰
    _pt_dbg_mm=""
    if [ -r "/sys/class/block/$_pt_bname/dev" ]; then
        read -r _pt_dbg_mm < "/sys/class/block/$_pt_bname/dev" 2>/dev/null
        _pt_dbg_mm="${_pt_dbg_mm%% *}"
    fi
    log_msg "    â”œâ”€ è®¾å¤‡: $_pt_raw_dev -> $_pt_bname [ID:${_pt_dbg_mm:-Unknown}]"

    if [ -n "$_pt_node" ] && [ -f "$_pt_node/dirty_segments" ]; then
        read_first_line _pt_s_dirty "$_pt_node/dirty_segments"
        if is_integer "$_pt_s_dirty" && [ "$_pt_s_dirty" -lt "$GC_DIRTY_MIN" ]; then _pt_is_healthy=true; fi
    fi

    # Trim æ‰§è¡Œé€»è¾‘
    if [ "$TRIM" = true ]; then
        if [ "$STOP_ON_SCREEN_ON" = true ] && is_screen_on; then
            log_msg "    â”œâ”€ Trim: ğŸš« è·³è¿‡ [äº®å±]"
            COUNT_SCREEN_SKIP=$((COUNT_SCREEN_SKIP + 1))
        elif [ "$ENABLE_SMART_TRIM" = true ] && [ "$_pt_is_healthy" = true ]; then
            log_msg "    â”œâ”€ Trim: ğŸ’¤ è·³è¿‡ [å¥åº· Dirty:$_pt_s_dirty]"
            COUNT_TRIM_SKIP=$((COUNT_TRIM_SKIP + 1))
        elif [ "$USE_SYSTEM_API" = true ]; then
            do_system_action "$_pt_mnt" "trim"
            log_msg "    â”œâ”€ Trim: âš ï¸ ç³»ç»Ÿæ‰˜ç®¡ [å¼ºåˆ¶]"
        else
            # åŒæ­¥è„æ•°æ®
            log_msg "    â”œâ”€ åŒæ­¥: æ­£åœ¨åŒæ­¥ç£ç›˜ç¼“å­˜..."
            
            # åå° sync å¹¶è¶…æ—¶ç›‘æ§
            sync &
            _pt_sync_pid=$!
            _pt_wait=0
            _pt_sync_timeout=30  # 30 ç§’è¶…æ—¶
            
            while kill -0 "$_pt_sync_pid" 2>/dev/null; do
                if [ "$_pt_wait" -ge "$_pt_sync_timeout" ]; then
                    # è¶…æ—¶ï¼Œå¼ºåˆ¶ç»ˆæ­¢
                    kill -KILL "$_pt_sync_pid" 2>/dev/null
                    log_msg "    â”œâ”€ âš ï¸ sync è¶…æ—¶ [${_pt_sync_timeout}ç§’]ï¼Œå¼ºåˆ¶ç»ˆæ­¢"
                    break
                fi
                sleep 1
                _pt_wait=$((_pt_wait + 1))
            done
            
            # ç­‰å¾… sync è¿›ç¨‹é€€å‡º
            wait "$_pt_sync_pid" 2>/dev/null
            
            log_msg "    â”œâ”€ åŒæ­¥å®Œæˆ [è€—æ—¶:${_pt_wait}ç§’]"
            
            _pt_out=""; _pt_ret=0; _pt_bytes=0; _pt_kb=0
            _pt_out=$(execute_trim_robust "$_pt_mnt")
            _pt_ret=$?
            
            if [ "$_pt_ret" -eq 0 ] 2>/dev/null; then
                COUNT_TRIM_RUN=$((COUNT_TRIM_RUN + 1))
                _pt_bytes=$(parse_trim_bytes "$_pt_out")
                
                if [ "$_pt_bytes" -gt 0 ] 2>/dev/null; then
                    _pt_kb=$(( (_pt_bytes + 1023) / 1024 ))
                    if [ ${#TOTAL_TRIM_KB} -le 9 ] 2>/dev/null; then
                        TOTAL_TRIM_KB=$((TOTAL_TRIM_KB + _pt_kb))
                    fi
                    log_msg "    â””â”€ ç»“æœ: âœ… ${_pt_kb} KB"
                else
                    # 0å­—èŠ‚æƒ…å†µï¼šè®°å½•å¹¶æ˜¾ç¤ºï¼ˆå¯èƒ½æ˜¯ discard/F2FS/SELinuxï¼‰
                    COUNT_TRIM_ZERO=$((COUNT_TRIM_ZERO + 1))
                    log_msg "    â””â”€ ç»“æœ: âœ… 0 B [æ— éœ€æ¸…ç†]"
                    [ -n "$_pt_out" ] && log_msg "            â””â”€ åŸå§‹: $_pt_out"
                fi
            else
                # Trim å¤±è´¥ï¼šæ˜¾ç¤ºè¯¦ç»†é”™è¯¯ï¼ˆè°ƒè¯•ç”¨ï¼‰
                log_msg "    â”œâ”€ Trim: âŒ æœ€ç»ˆå¤±è´¥ [é€€å‡ºç : $_pt_ret]"
                [ -n "$_pt_out" ] && log_msg "            â””â”€ è¾“å‡º: $_pt_out"
                
                # å°è¯•ç³»ç»Ÿ API è¡¥æ•‘
                log_msg "    â””â”€ Trim: âš ï¸ ç³»ç»ŸAPIæ‰˜ç®¡ [è¡¥æ•‘å°è¯•]"
                if do_system_action "$_pt_mnt" "trim"; then
                    : # æˆåŠŸï¼Œdo_system_action å·²è¾“å‡ºæ—¥å¿—
                else
                    LIST_FAIL="$LIST_FAIL $_pt_mnt:Trim"
                fi
            fi
        fi
    fi

    # GC æ‰§è¡Œé€»è¾‘
    if [ "$GC" = true ]; then
        case "$_pt_fstype" in f2fs|mifs) ;; *) return 0 ;; esac
        
        _pt_ctrl=""
        _pt_gc_type=""
        
        # GC æ¥å£æ£€æµ‹ï¼šä¼˜å…ˆæ£€æŸ¥å­˜åœ¨æ€§ï¼ˆ-fï¼‰è€Œéå¯å†™æ€§ï¼ˆ-wï¼‰
        if [ -n "$_pt_node" ]; then
            # ä¼˜å…ˆçº§ 1: gc_urgent_mode (æ–°å†…æ ¸æ ‡å‡†, æ”¯æŒ 0/1/2/3/4)
            if [ -f "${_pt_node}/gc_urgent_mode" ]; then
                _pt_ctrl="${_pt_node}/gc_urgent_mode"
                _pt_gc_type="mode"
            
            # ä¼˜å…ˆçº§ 2: gc_urgent (æ—§å†…æ ¸æ ‡å‡†, ä»… 0/1)
            elif [ -f "${_pt_node}/gc_urgent" ]; then
                _pt_ctrl="${_pt_node}/gc_urgent"
                _pt_gc_type="legacy"
            fi
            
            # å¯å†™æ€§éªŒè¯ï¼ˆè­¦å‘Šä½†ä¸é˜»æ–­ï¼ŒRoot å¼ºè¡Œå†™é€šå¸¸èƒ½è¿‡ï¼‰
            if [ -n "$_pt_ctrl" ] && [ ! -w "$_pt_ctrl" ]; then
                log_msg "    â”œâ”€ âš ï¸ GC æ¥å£å¯èƒ½åªè¯» [$_pt_ctrl]ï¼Œå°è¯•å¼ºè¡Œå†™å…¥"
            fi
        fi

        if [ "$USE_SYSTEM_API" = true ]; then
            log_msg "    â””â”€ GC: âš ï¸ ç³»ç»Ÿæ‰˜ç®¡ [å¼ºåˆ¶]"
            do_system_action "$_pt_mnt" "gc"
            return
        fi

        if [ -z "$_pt_ctrl" ]; then
            # è¾“å‡ºè¯Šæ–­ä¿¡æ¯ï¼ˆä»… F2FS/MIFS åˆ†åŒºï¼‰
            if [ "${LOG_MODE:-INFO}" != "NONE" ]; then
                log_gc_diagnostic "$_pt_real_dev" "$_pt_node"
            fi
            log_msg "    â””â”€ GC: âš ï¸ ç³»ç»Ÿæ‰˜ç®¡ [æ— æ¥å£]"
            do_system_action "$_pt_mnt" "gc"
            return
        fi

        if [ "$ENABLE_SMART_GC" = true ] && [ "$_pt_is_healthy" = true ]; then
            log_msg "    â””â”€ GC: ğŸ’¤ è·³è¿‡ [å¥åº·]"
            COUNT_GC_SKIP=$((COUNT_GC_SKIP + 1))
            return
        fi

        if [ "$STOP_ON_SCREEN_ON" = true ] && is_screen_on; then
            log_msg "    â””â”€ GC: ğŸš« è·³è¿‡ [äº®å±]"
            COUNT_SCREEN_SKIP=$((COUNT_SCREEN_SKIP + 1))
            return 0
        fi

        COUNT_GC_RUN=$((COUNT_GC_RUN + 1))
        sync
        
        # è·å–å”¤é†’é”
        write_sysfs "$WAKE_LOCK_ID" "/sys/power/wake_lock"
        HAS_ACQUIRED_WAKELOCK=true
        
        # ä¿å­˜GCåŸå§‹å€¼ï¼ˆå…¨å±€å˜é‡ï¼Œç”¨äºcleanupæ¢å¤ï¼‰
        read_first_line RESTORE_GC_VAL "$_pt_ctrl"
        
        # çŠ¶æ€è‡ªæ„ˆï¼šå¤„ç†å­—ç¬¦ä¸²æšä¸¾å€¼
        _pt_original_val="$RESTORE_GC_VAL"
        
        case "$RESTORE_GC_VAL" in 
            0|"GC_NORMAL"|"") 
                # æ­£å¸¸çŠ¶æ€ï¼Œç¡®ä¿æ¢å¤å€¼ä¸ºæ•°å­— 0
                RESTORE_GC_VAL="0"
                ;;
            1|"GC_URGENT_HIGH"|"GC_URGENT")
                # ä¹‹å‰æ˜¯é«˜è´Ÿè½½æ¨¡å¼ï¼Œä¸ºå®‰å…¨èµ·è§æ¢å¤ä¸º 0
                # ï¼ˆé¿å…æ¨¡å—å¼‚å¸¸é€€å‡ºåæ‰‹æœºä¸€ç›´å¡é¡¿ï¼‰
                log_msg "    â”œâ”€ åŸçŠ¶æ€ä¸ºé«˜è´Ÿè½½æ¨¡å¼ [$_pt_original_val]ï¼Œæ¢å¤æ—¶å°†é‡ç½®ä¸º Normal"
                RESTORE_GC_VAL="0"
                ;;
            2|"GC_URGENT_LOW")
                # ä½è´Ÿè½½æ¨¡å¼ï¼Œä¿æŒ
                RESTORE_GC_VAL="2"
                ;;
            3|"GC_URGENT_MID")
                # ä¸­ç­‰æ¨¡å¼ï¼Œä¿æŒ
                RESTORE_GC_VAL="3"
                ;;
            *[!0-9]*)
                # æœªçŸ¥å­—ç¬¦ä¸²ï¼Œå¼ºåˆ¶å½’é›¶
                log_msg "    â”œâ”€ âš ï¸ æœªçŸ¥ GC çŠ¶æ€ [$_pt_original_val]ï¼Œæ¢å¤æ—¶å°†é‡ç½®ä¸º 0"
                RESTORE_GC_VAL="0"
                ;;
            *)
                # å…¶ä»–æ•°å­—ï¼ˆå¦‚ 4/5ï¼‰ï¼Œå°è¯•é‡ç½®ä¸º 0ï¼ˆå¼‚å¸¸æ®‹ç•™ï¼‰
                if [ "$RESTORE_GC_VAL" != "0" ]; then
                    log_msg "    â”œâ”€ âš ï¸ æ£€æµ‹åˆ°å¼‚å¸¸æ®‹ç•™çŠ¶æ€ [$RESTORE_GC_VAL]ï¼Œæ¢å¤æ—¶å°†é‡ç½®ä¸º 0"
                    RESTORE_GC_VAL="0"
                fi
                ;;
        esac
        
        ACTIVE_GC_NODE="$_pt_ctrl"
        
        # Turbo GCï¼šå°è¯•è®¾ç½® sleep_timeï¼ˆå¯é€‰ï¼Œå¤±è´¥ä¸å½±å“GCï¼‰
        if [ "$ENABLE_TURBO_GC" = true ] && [ -f "$_pt_node/gc_urgent_sleep_time" ]; then
            _pt_snode="$_pt_node/gc_urgent_sleep_time"
            read_first_line RESTORE_SLEEP_VAL "$_pt_snode"
            
            # ä½¿ç”¨ write_sysfs è¿›è¡Œé²æ£’å†™å…¥
            if write_sysfs "$GC_TURBO_SLEEP" "$_pt_snode"; then
                ACTIVE_SLEEP_NODE="$_pt_snode"
            else
                # æƒé™ä¸è¶³æ—¶è®°å½•å¹¶ç»§ç»­ï¼ˆä½¿ç”¨å†…æ ¸é»˜è®¤å€¼ï¼‰
                log_msg "    â”œâ”€ âš ï¸ sleep_time ä¸å¯å†™ï¼Œä½¿ç”¨å†…æ ¸é»˜è®¤å€¼"
                RESTORE_SLEEP_VAL=""
            fi
        fi
        
        # ä½¿ç”¨ write_sysfs æ¿€æ´» GC æ¨¡å¼
        _pt_mode_ok=false
        if write_sysfs "$GC_MODE_PREF" "$_pt_ctrl"; then
            _pt_mode_ok=true
        else
            # å°è¯•å¤‡é€‰æ¨¡å¼
            _pt_alt="2"
            [ "$GC_MODE_PREF" = "2" ] && _pt_alt="1"
            write_sysfs "$_pt_alt" "$_pt_ctrl" && _pt_mode_ok=true
        fi

        if [ "$_pt_mode_ok" = false ]; then
            ACTIVE_GC_NODE=""; RESTORE_GC_VAL=""; ACTIVE_SLEEP_NODE=""; RESTORE_SLEEP_VAL=""
            write_sysfs "$WAKE_LOCK_ID" "/sys/power/wake_unlock"
            HAS_ACQUIRED_WAKELOCK=false
            log_msg "    â””â”€ GC: âŒ æ¿€æ´»å¤±è´¥ [åˆ‡æ¢ç³»ç»Ÿæ‰˜ç®¡]"
            do_system_action "$_pt_mnt" "gc"
            return
        fi
        
        log_msg "    â””â”€ GC: ğŸš€ å›æ”¶ä¸­... [åˆå§‹Dirty: $_pt_s_dirty]"
        
        # [è°ƒè¯•] è®°å½•GCå‚æ•°ï¼ˆæ˜¾ç¤ºå†™å…¥å€¼ï¼Œé¿å…å†…æ ¸æšä¸¾æ··æ·†ï¼‰
        _pt_set_mode="$GC_MODE_PREF"
        _pt_set_sleep="${GC_TURBO_SLEEP:-é»˜è®¤}"
        _pt_act_mode=""; _pt_act_sleep=""
        
        # [è°ƒè¯•] è¯»å–å†…æ ¸å®é™…å€¼ä½œä¸ºå‚è€ƒ
        read_first_line _pt_act_mode "$_pt_ctrl"
        [ -n "$ACTIVE_SLEEP_NODE" ] && read_first_line _pt_act_sleep "$ACTIVE_SLEEP_NODE"
        
        # åˆ¤æ–­æ˜¯å¦æœ‰å†…æ ¸å·®å¼‚æ—¥å¿—
        _pt_has_kernel_diff=false
        if [ -n "$_pt_act_mode" ] && [ "$_pt_act_mode" != "$_pt_set_mode" ]; then
            _pt_has_kernel_diff=true
        fi
        
        # ä¸»æ—¥å¿—ï¼šæ˜¾ç¤ºè„šæœ¬è®¾ç½®å€¼ï¼ˆæ ¹æ®æ˜¯å¦æœ‰åç»­æ—¥å¿—é€‰æ‹©ç¬¦å·ï¼‰
        if [ "$_pt_has_kernel_diff" = true ]; then
            # æœ‰åç»­æ—¥å¿—ï¼Œä½¿ç”¨ â”œâ”€
            if [ -n "$ACTIVE_SLEEP_NODE" ]; then
                log_msg "            â”œâ”€ å‚æ•°: Mode=${_pt_set_mode}, Sleep=${_pt_set_sleep}ms"
            else
                log_msg "            â”œâ”€ å‚æ•°: Mode=${_pt_set_mode}, Sleep=å†…æ ¸é»˜è®¤"
            fi
            log_msg "            â””â”€ å†…æ ¸å®é™…: Mode=$_pt_act_mode"
        else
            # æ— åç»­æ—¥å¿—ï¼Œä½¿ç”¨ â””â”€
            if [ -n "$ACTIVE_SLEEP_NODE" ]; then
                log_msg "            â””â”€ å‚æ•°: Mode=${_pt_set_mode}, Sleep=${_pt_set_sleep}ms"
            else
                log_msg "            â””â”€ å‚æ•°: Mode=${_pt_set_mode}, Sleep=å†…æ ¸é»˜è®¤"
            fi
        fi
        
        # GC è½®è¯¢å¾ªç¯
        _pt_interrupted=false; _pt_read_success=false; _pt_prev_cur=""
        _pt_time=0; _pt_cur=$_pt_s_dirty; _pt_stable=0; _pt_last=$_pt_s_dirty
        
        while [ "$_pt_time" -lt "$GC_MAX_SEC" ]; do
            if [ "$STOP_ON_SCREEN_ON" = true ] && is_screen_on; then 
                 log_msg "            â””â”€ âš ï¸ äº®å±ä¸­æ–­"
                 COUNT_SCREEN_SKIP=$((COUNT_SCREEN_SKIP + 1))
                 _pt_interrupted=true
                 break
            fi
            
            sleep "$GC_POLL"
            [ -f "$_pt_node/dirty_segments" ] || break
            
            _pt_prev_cur=$_pt_cur
            if read_first_line _pt_cur "$_pt_node/dirty_segments" && is_integer "$_pt_cur"; then
                _pt_read_success=true
                if [ "$_pt_cur" -lt "$_pt_last" ]; then 
                    _pt_stable=0
                    _pt_last=$_pt_cur
                else 
                    _pt_stable=$((_pt_stable + 1))
                fi
            else
                _pt_cur=$_pt_prev_cur
            fi
            
            if [ "$_pt_stable" -ge "$GC_STABLE_CNT" ]; then break; fi
            _pt_time=$((_pt_time + 1))
        done

        [ -n "$RESTORE_GC_VAL" ] && echo "$RESTORE_GC_VAL" > "$ACTIVE_GC_NODE" 2>/dev/null
        [ -n "$RESTORE_SLEEP_VAL" ] && echo "$RESTORE_SLEEP_VAL" > "$ACTIVE_SLEEP_NODE" 2>/dev/null
        echo "$WAKE_LOCK_ID" > /sys/power/wake_unlock 2>/dev/null
        HAS_ACQUIRED_WAKELOCK=false
        ACTIVE_GC_NODE=""; ACTIVE_SLEEP_NODE=""
        
        # ç»Ÿè®¡ç»“æœï¼ˆä»…åœ¨æˆåŠŸè¯»å–æ—¶è®¡ç®—ï¼Œå¸¦æº¢å‡ºä¿æŠ¤ï¼‰
        if [ "$_pt_interrupted" = false ]; then
            if [ "$_pt_read_success" = true ] && is_integer "$_pt_cur" && is_integer "$_pt_s_dirty"; then
                _pt_diff=$((_pt_s_dirty - _pt_cur))
                if [ "$_pt_diff" -gt 0 ]; then
                    # æ•´æ•°æº¢å‡ºä¿æŠ¤ï¼ˆ32ä½æœ€å¤§å€¼çº¦ 21 äº¿ï¼Œé™åˆ¶ä¸º 9 ä½æ•°ï¼‰
                    if [ ${#TOTAL_GC_SEGS} -le 9 ] 2>/dev/null; then
                        TOTAL_GC_SEGS=$((TOTAL_GC_SEGS + _pt_diff))
                    fi
                    log_msg "            â””â”€ ç»“æœ: âœ… æ¸…ç† $_pt_diff æ®µ"
                else
                    log_msg "            â””â”€ ç»“æœ: â¤ æ— å˜åŒ– [åˆå§‹:$_pt_s_dirty -> ç»“æŸ:$_pt_cur]"
                fi
            else
                log_msg "            â””â”€ ç»“æœ: âš ï¸ è¯»å–å¤±è´¥ï¼Œæ— æ³•ç»Ÿè®¡"
            fi
        else
            log_msg "            â””â”€ ç»“æœ: âš ï¸ å·²ä¸­æ–­"
        fi
    fi
}

# ==============================================================================
# ä¸»æµç¨‹
# ==============================================================================

if ! acquire_lock; then
    _pid=""; read_first_line _pid "$LOCK_PID_FILE"
    log_msg "âŒ é”å†²çª [PID: $_pid]"
    exit $EXIT_LOCK_CONFLICT
fi
log_msg "âœ… é”å·²è·å– (PID: $CURRENT_PID)"

# [è‡ªæˆ‘ä¿®å¤] æ¸…ç†å¯èƒ½æ®‹ç•™çš„å”¤é†’é” (é˜²æ­¢ä¸Šæ¬¡å¼‚å¸¸é€€å‡ºå¯¼è‡´æ— æ³•ä¼‘çœ )
echo "$WAKE_LOCK_ID" > /sys/power/wake_unlock 2>/dev/null

trap 'cleanup' EXIT TERM INT HUP QUIT ABRT

if [ "$(id -u)" -ne 0 ]; then
    log_msg "âŒ éœ€è¦ Root æƒé™"
    exit $EXIT_NO_ROOT
fi

log_msg "=== f2fsopt å¯åŠ¨ ==="

# é…ç½®éªŒè¯
validate_config

# æ£€æµ‹æ¨¡å—çŠ¶æ€ï¼ˆç¦ç”¨/å¸è½½/æ›´æ–°ï¼‰
if [ -f "$MODDIR/disable" ] || [ -f "$MODDIR/remove" ] || [ -f "$MODDIR/update" ]; then
    log_msg "âš ï¸ æ£€æµ‹åˆ°æ¨¡å—æ“ä½œæ ‡è®°ï¼Œè·³è¿‡æ‰§è¡Œ"
    cleanup $EXIT_SUCCESS
fi

# OOM ä¿æŠ¤ï¼šé™ä½è¢«ç³»ç»Ÿ Low Memory Killer æ€æ­»çš„æ¦‚ç‡
if [ -w /proc/self/oom_score_adj ]; then
    if echo "-900" > /proc/self/oom_score_adj 2>/dev/null; then
        : # é™é»˜æˆåŠŸ
    fi
fi

# å……ç”µçŠ¶æ€æ£€æŸ¥
if [ "$ONLY_CHARGING" = true ] && ! is_charging; then
    log_msg "ğŸ”‹ æœªå……ç”µï¼Œè·³è¿‡æ‰§è¡Œ"
    cleanup $EXIT_CONDITION
fi

# å±å¹•çŠ¶æ€æ£€æŸ¥
if [ "$STOP_ON_SCREEN_ON" = true ] && is_screen_on; then
    log_msg "ğŸ“± äº®å±ä¸­ï¼Œè·³è¿‡æ‰§è¡Œ"
    cleanup $EXIT_CONDITION
fi

if [ -n "$MANUAL_TARGETS" ]; then
    log_msg "ğŸ¯ æ‰‹åŠ¨æ¨¡å¼ (æŒ‡å®šè·¯å¾„)"
    
    # æ”¶é›†æ‰‹åŠ¨æŒ‡å®šè·¯å¾„çš„è®¾å¤‡ä¿¡æ¯
    _unique_ids=""
    _manual_count=0
    
    for _m_target in $MANUAL_TARGETS; do
        # è·¯å¾„å®‰å…¨éªŒè¯
        case "$_m_target" in
            */../*|*/../*|../*|*/..)
                log_msg "   âŒ è·³è¿‡: $_m_target [åŒ…å«è·¯å¾„éå†]"
                continue
                ;;
            /*)
                # è·¯å¾„ä»¥ / å¼€å¤´ï¼Œåˆæ³•
                ;;
            *)
                log_msg "   âŒ è·³è¿‡: $_m_target [å¿…é¡»æ˜¯ç»å¯¹è·¯å¾„]"
                continue
                ;;
        esac
        
        # éªŒè¯è·¯å¾„å­˜åœ¨
        if [ ! -d "$_m_target" ]; then
            log_msg "   âŒ è·³è¿‡: $_m_target [ç›®å½•ä¸å­˜åœ¨]"
            continue
        fi
        
        # è§„èŒƒåŒ–è·¯å¾„
        _m_target="${_m_target%/}"
        [ -z "$_m_target" ] && _m_target="/"  # ä¿æŠ¤æ ¹åˆ†åŒº
        
        # ä» /proc/mounts æŸ¥æ‰¾æŒ‚è½½ä¿¡æ¯
        _m_found=false
        while read -r _m_dev _m_mnt _m_type _m_opts _m_rest; do
            _m_mnt=$(decode_path "$_m_mnt")
            _m_mnt="${_m_mnt%/}"
            [ -z "$_m_mnt" ] && _m_mnt="/"  # ä¿æŠ¤æ ¹åˆ†åŒº
            
            # ç²¾ç¡®åŒ¹é…æŒ‚è½½ç‚¹
            if [ "$_m_mnt" = "$_m_target" ]; then
                # éªŒè¯æ–‡ä»¶ç³»ç»Ÿç±»å‹
                case "$_m_type" in
                    f2fs|mifs|ext4)
                        # éªŒè¯æŒ‚è½½é€‰é¡¹
                        case "$_m_opts" in
                            *rw,*)
                                # è·å–è®¾å¤‡æŒ‡çº¹ï¼ˆç»Ÿä¸€å»é‡æœºåˆ¶ï¼‰
                                _m_fp=$(get_device_fingerprint "$_m_dev" "$_m_mnt")
                                if [ -n "$_m_fp" ]; then
                                    # æŒ‡çº¹å®‰å…¨åŒ–ï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ eval æ³¨å…¥ï¼‰
                                    _id_safe="$_m_fp"
                                    # ç§»é™¤ : å’Œ /
                                    while case "$_id_safe" in *[:/]*) true;; *) false;; esac; do
                                        case "$_id_safe" in
                                            *:*) _id_safe="${_id_safe%%:*}_${_id_safe#*:}" ;;
                                            */*) _id_safe="${_id_safe%%/*}_${_id_safe#*/}" ;;
                                        esac
                                    done
                                    # é¢å¤–å®‰å…¨æ£€æŸ¥ï¼šç§»é™¤å…¶ä»–æ½œåœ¨å±é™©å­—ç¬¦
                                    case "$_id_safe" in
                                        *[\$\`\"\'\\\;]*) 
                                            log_msg "   âš ï¸ è·³è¿‡: è®¾å¤‡æŒ‡çº¹åŒ…å«éæ³•å­—ç¬¦"
                                            continue
                                            ;;
                                    esac
                                    
                                    _len=${#_m_mnt}
                                    eval "_recorded_len=\${_best_len_${_id_safe}:-99999}"
                                    
                                    # è‡ªåŠ¨é€‰æ‹©æœ€çŸ­è·¯å¾„ï¼ˆåŒè®¾å¤‡å¤šä¸ªæŒ‚è½½ç‚¹ï¼‰
                                    if [ "$_len" -lt "$_recorded_len" ] 2>/dev/null; then
                                        eval "_best_len_${_id_safe}='$_len'"
                                        eval "_best_line_${_id_safe}='$_m_dev@@@$_m_mnt@@@$_m_type'"
                                        
                                        eval "_is_seen=\${_seen_${_id_safe}}"
                                        if [ -z "$_is_seen" ]; then
                                            _unique_ids="$_unique_ids $_id_safe"
                                            eval "_seen_${_id_safe}=1"
                                            log_msg "   âœ… $_m_target ($_m_type, $_m_dev)"
                                        else
                                            log_msg "   ğŸ”„ æ›´æ–°: $_m_target (è·¯å¾„æ›´çŸ­)"
                                        fi
                                    else
                                        log_msg "   âš ï¸ è·³è¿‡: $_m_target [å·²æœ‰æ›´çŸ­è·¯å¾„]"
                                    fi
                                    
                                    eval "_best_count_${_id_safe}=\$((\${_best_count_${_id_safe}:-0} + 1))"
                                    _manual_count=$((_manual_count + 1))
                                fi
                                _m_found=true
                                break
                                ;;
                            *)
                                log_msg "   âš ï¸ è·³è¿‡: $_m_target [åªè¯»æŒ‚è½½]"
                                _m_found=true
                                break
                                ;;
                        esac
                        ;;
                    *)
                        log_msg "   âš ï¸ è·³è¿‡: $_m_target [ä¸æ”¯æŒçš„æ–‡ä»¶ç³»ç»Ÿ: $_m_type]"
                        _m_found=true
                        break
                        ;;
                esac
            fi
        done < /proc/mounts
        
        if ! $_m_found; then
            log_msg "   âš ï¸ è·³è¿‡: $_m_target [æœªæ‰¾åˆ°æŒ‚è½½ä¿¡æ¯]"
        fi
    done
    
    # å¤„ç†æ”¶é›†åˆ°çš„è®¾å¤‡ï¼ˆæœ€çŸ­è·¯å¾„ä¼˜å…ˆï¼‰
    log_msg "ğŸ“‹ å¾…å¤„ç†: ${_manual_count} ä¸ªæŒ‡å®šè·¯å¾„"
    
    for _id in $_unique_ids; do
        eval "_line=\${_best_line_${_id}}"
        eval "_count=\${_best_count_${_id}}"
        
        if [ -n "$_line" ]; then
            _m_dev="${_line%%@@@*}"
            _rest="${_line#*@@@}"
            _m_mnt="${_rest%%@@@*}"
            _m_type="${_rest#*@@@}"
            
            if [ "$_count" -gt 1 ]; then
                log_msg "   ğŸ”— $_m_mnt [åˆå¹¶ $_count ä¸ªæŒ‚è½½ç‚¹]"
            fi
            process_target "$_m_mnt" "$_m_dev" "$_m_type"
        fi
    done
else
        log_msg "ğŸ” è‡ªåŠ¨æ‰«ææŒ‚è½½ç‚¹..."
    
    _unique_ids=""
    _scan_count=0 _skip_count=0
    _slow_mounts=""  # è®°å½•æ…¢é€ŸæŒ‚è½½ç‚¹
    _very_slow_count=0
    
    while read -r _dev _mnt _type _opts _rest; do
        # åŸºç¡€è¿‡æ»¤ï¼ˆä¼˜å…ˆï¼Œé¿å…æ— æ•ˆè®¡æ—¶ï¼‰
        case "$_dev" in /dev/block/*) ;; *) continue ;; esac
        case "$_type" in f2fs|mifs|ext4) ;; *) continue ;; esac
        case "$_opts" in *rw,*) ;; *) continue ;; esac
        
        # è·¯å¾„è§£ç 
        _mnt_decoded=$(decode_path "$_mnt")
        _mnt_decoded="${_mnt_decoded%/}"
        [ -z "$_mnt_decoded" ] && _mnt_decoded="/"  # ä¿æŠ¤æ ¹åˆ†åŒº
        
        # ç»Ÿä¸€é»‘åå•æ£€æŸ¥
        if is_path_ignored "$_mnt_decoded"; then
            _skip_count=$((_skip_count + 1))
            continue
        fi
        
        _scan_count=$((_scan_count + 1))
        
        # æ€§èƒ½ç›‘æ§ï¼šä»…è°ƒè¯•æ¨¡å¼å¯ç”¨ï¼Œä¸”ä»…å¯¹éœ€å¤„ç†çš„æŒ‚è½½ç‚¹è®¡æ—¶
        _mount_start_ms=0
        [ "$DEBUG_SCAN" = "1" ] && _mount_start_ms=$(get_timestamp_ms)
        
        # è·å–è®¾å¤‡æŒ‡çº¹ (æ€§èƒ½ç“¶é¢ˆç‚¹)
        _fingerprint=$(get_device_fingerprint "$_dev" "$_mnt_decoded")
        if [ -z "$_fingerprint" ]; then continue; fi
        
        # æŒ‡çº¹å®‰å…¨åŒ–ï¼ˆç§»é™¤ç‰¹æ®Šå­—ç¬¦ï¼Œé˜²æ­¢ eval æ³¨å…¥ï¼‰
        _id_safe="$_fingerprint"
        # ç§»é™¤ : å’Œ /
        while case "$_id_safe" in *[:/]*) true;; *) false;; esac; do
            case "$_id_safe" in
                *:*) _id_safe="${_id_safe%%:*}_${_id_safe#*:}" ;;
                */*) _id_safe="${_id_safe%%/*}_${_id_safe#*/}" ;;
            esac
        done
        # é¢å¤–å®‰å…¨æ£€æŸ¥ï¼šç§»é™¤å…¶ä»–æ½œåœ¨å±é™©å­—ç¬¦
        case "$_id_safe" in
            *[\$\`\"\'\\\;]*) continue ;;  # è·³è¿‡åŒ…å«å±é™©å­—ç¬¦çš„è®¾å¤‡
        esac
        
        _slash_count=$(count_slashes "$_mnt_decoded")
        eval "_recorded_slashes=\${_best_slashes_${_id_safe}:-99999}"
        
        # æ›´æ–°æœ€å°‘æ–œæ è·¯å¾„ï¼ˆå±‚çº§æœ€æµ…ï¼‰
        if [ "$_slash_count" -lt "$_recorded_slashes" ] 2>/dev/null; then
            eval "_best_slashes_${_id_safe}='$_slash_count'"
            eval "_best_line_${_id_safe}='$_dev@@@$_mnt_decoded@@@$_type'"
            
            eval "_is_seen=\${_seen_${_id_safe}}"
            if [ -z "$_is_seen" ]; then
                 _unique_ids="$_unique_ids $_id_safe"
                 eval "_seen_${_id_safe}=1"
            fi
        fi
        
        eval "_best_count_${_id_safe}=\$((\${_best_count_${_id_safe}:-0} + 1))"
        
        # æ€§èƒ½ç›‘æ§ï¼šä»…è°ƒè¯•æ¨¡å¼ä¸‹è®¡ç®—è€—æ—¶
        if [ "$DEBUG_SCAN" = "1" ] && [ "$_mount_start_ms" -gt 0 ] 2>/dev/null; then
            _mount_end_ms=0; _mount_elapsed_ms=0
            _mount_end_ms=$(get_timestamp_ms)
            _mount_elapsed_ms=$((_mount_end_ms - _mount_start_ms))
            
            # æç«¯æ…¢é€Ÿ (>2ç§’)
            if [ "$_mount_elapsed_ms" -ge 2000 ] 2>/dev/null; then
                log_msg "   ğŸš¨ æç«¯æ…¢é€Ÿ: $_mnt_decoded (${_mount_elapsed_ms}ms)"
                _slow_mounts="$_slow_mounts$_mnt_decoded|${_mount_elapsed_ms}ms
"
                _very_slow_count=$((_very_slow_count + 1))
            # æ…¢é€Ÿ (>1.5ç§’)
            elif [ "$_mount_elapsed_ms" -ge "$VERY_SLOW_THRESHOLD" ] 2>/dev/null; then
                log_msg "   âš ï¸ æ…¢é€Ÿ: $_mnt_decoded (${_mount_elapsed_ms}ms) [ç±»å‹: $_type, è®¾å¤‡: $_dev]"
                _slow_mounts="$_slow_mounts$_mnt_decoded|${_mount_elapsed_ms}ms
"
                _very_slow_count=$((_very_slow_count + 1))
            # è¾ƒæ…¢ (>500ms)
            elif [ "$_mount_elapsed_ms" -ge "$SLOW_MOUNT_THRESHOLD" ] 2>/dev/null; then
                log_msg "   â±ï¸ è¾ƒæ…¢: $_mnt_decoded (${_mount_elapsed_ms}ms)"
            fi
        fi
        
    done < /proc/mounts

    log_msg "âš–ï¸ æ‰«æå®Œæˆ [å¤„ç†: ${_scan_count}, è·³è¿‡: ${_skip_count}]"
    
    # æ€§èƒ½è¯Šæ–­æŠ¥å‘Š
    if [ "$DEBUG_SCAN" = "1" ] && [ "$_very_slow_count" -gt 0 ]; then
        log_msg "ğŸ“Š æ€§èƒ½è¯Šæ–­æŠ¥å‘Š:"
        log_msg "    â”œâ”€ å‘ç° ${_very_slow_count} ä¸ªæ…¢é€ŸæŒ‚è½½ç‚¹ [>= ${VERY_SLOW_THRESHOLD}ms]"
        log_msg "    â”œâ”€ è¯¦ç»†åˆ—è¡¨:"
        printf '%s' "$_slow_mounts" | while IFS='|' read -r _slow_path _slow_time; do
            [ -n "$_slow_path" ] && log_msg "            - $_slow_path [$_slow_time]"
        done
        log_msg "    â””â”€ å»ºè®®: å°†ä¸Šè¿°è·¯å¾„æ·»åŠ åˆ°é»‘åå• IGNORE_PREFIXES"
    fi
    
    # ç»“æœè¾“å‡ºä¸æ‰§è¡Œ
    for _id in $_unique_ids; do
        eval "_line=\${_best_line_${_id}}"
        eval "_count=\${_best_count_${_id}}"
        
        if [ -n "$_line" ]; then
            _dev="${_line%%@@@*}"
            _rest="${_line#*@@@}"
            _mnt="${_rest%%@@@*}"
            _type="${_rest#*@@@}"
            
            if [ "$_count" -gt 1 ]; then
                 log_msg "ğŸ”¸ $_mnt [ä¼˜é€‰è‡ª ${_count} ä¸ªæŒ‚è½½ç‚¹]"
            else
                 log_msg "ğŸ”¹ $_mnt"
            fi
            
            [ -n "$_mnt" ] && process_target "$_mnt" "$_dev" "$_type"
        fi
    done
fi
    
# ==============================================================================
# ç»Ÿè®¡æ‘˜è¦
# ==============================================================================

# è®¡ç®—è€—æ—¶
DURATION=$(( $(date +%s) - START_TIME ))
if [ "$DURATION" -lt 0 ] 2>/dev/null; then
    DURATION=0
    log_msg "âš ï¸ æ£€æµ‹åˆ°æ—¶é—´å¼‚å¸¸ï¼ˆå›æ‹¨ï¼‰ï¼Œè€—æ—¶å½’é›¶"
elif [ "$DURATION" -gt 86400 ] 2>/dev/null; then
    DURATION=86400
    log_msg "âš ï¸ æ£€æµ‹åˆ°æ—¶é—´å¼‚å¸¸ï¼ˆè¶…24å°æ—¶ï¼‰ï¼Œè€—æ—¶æˆªæ–­"
fi

if [ "$TOTAL_TRIM_KB" -gt 1048576 ]; then 
    _gb=$((TOTAL_TRIM_KB * 10 / 1024 / 1024))
    _int=$((_gb / 10))
    _dec=$((_gb % 10))
    SHOW_TRIM="${_int}.${_dec}GB"
elif [ "$TOTAL_TRIM_KB" -gt 1024 ]; then 
    SHOW_TRIM="$((TOTAL_TRIM_KB/1024))MB"
else 
    SHOW_TRIM="${TOTAL_TRIM_KB}KB"
fi

# ä¼˜åŒ– 0KB çš„æ˜¾ç¤ºé€»è¾‘
if [ "$TOTAL_TRIM_KB" -eq 0 ] 2>/dev/null; then
    if [ "$COUNT_TRIM_SKIP" -gt 0 ] 2>/dev/null; then
        # æ™ºèƒ½è·³è¿‡ï¼šçœŸæ­£å¥åº·
        SHOW_TRIM="ğŸ’¤å¥åº·"
    elif [ "$COUNT_TRIM_ZERO" -gt 0 ] 2>/dev/null; then
        # æ‰§è¡Œäº†ä½†è¿”å› 0 å­—èŠ‚ï¼ˆdiscard/F2FS/SELinuxï¼‰
        SHOW_TRIM="0B(æ— éœ€æ¸…ç†)"
    fi
fi

if [ "$TOTAL_GC_SEGS" -gt 0 ] 2>/dev/null; then
    SHOW_GC="${TOTAL_GC_SEGS}æ®µ"
    [ "$COUNT_SCREEN_SKIP" -gt 0 ] 2>/dev/null && SHOW_GC="${SHOW_GC} ğŸš«äº®å±"
elif [ "$COUNT_SCREEN_SKIP" -gt 0 ] 2>/dev/null; then
    SHOW_GC="ğŸš«äº®å±ä¿æŠ¤"
elif [ "$COUNT_GC_SKIP" -gt 0 ] 2>/dev/null; then
    SHOW_GC="ğŸ’¤å¥åº·"
elif [ "$COUNT_SYS_API" -gt 0 ] 2>/dev/null; then
    SHOW_GC="âš ï¸æ‰˜ç®¡"
elif [ "$COUNT_GC_RUN" -gt 0 ] 2>/dev/null; then
    SHOW_GC="â–æ— å˜åŒ–"
else
    SHOW_GC="æœªè¿è¡Œ"
fi

SUMMARY="ğŸ§¹Trim:${SHOW_TRIM} â™»ï¸GC:${SHOW_GC} â±ï¸è€—æ—¶:${DURATION}ç§’"
log_msg "=== æ‰§è¡Œå®Œæˆ ==="
log_msg "$SUMMARY"
update_magisk_ui "$SUMMARY"
send_notification "$SUMMARY"
cleanup $EXIT_SUCCESS
