# F2FS æ·±åº¦ä¼˜åŒ– (F2FS Optimizer)

> **æç®€ã€é«˜æ•ˆã€çº¯å‡€çš„ Android å­˜å‚¨ç»´æŠ¤æ–¹æ¡ˆ**

ä¸€ä¸ªä¸“ä¸º Android è®¾å¤‡æ‰“é€ çš„å­˜å‚¨ä¼˜åŒ–æ¨¡å—ã€‚åŸºäºçº¯ Shell è„šæœ¬å®ç°ï¼Œé€šè¿‡å†…æ ¸çº§æŒ‡ä»¤å¯¹ F2FS/MIFS/EXT4 åˆ†åŒºè¿›è¡Œæ·±åº¦ Trim å’Œæ™ºèƒ½åƒåœ¾å›æ”¶ (GC)ï¼Œä»è€Œæ˜¾è‘—æå‡è®¾å¤‡é•¿æœŸçš„è¯»å†™æ€§èƒ½ä¸å“åº”é€Ÿåº¦ã€‚

## âœ¨ æ ¸å¿ƒç‰¹æ€§

* **âš¡ åŒå¼•æ“è°ƒåº¦æ¶æ„**
    * **Sleep æ¨¡å¼** ï¼šé›¶ä¾èµ–ï¼ŒåŸºäº Shell å†…ç½®å¾ªç¯ï¼ŒæŠ—æ€åå°ï¼Œé€‚åˆæ‰€æœ‰ç¯å¢ƒã€‚
    * **Cron æ¨¡å¼**ï¼šä¾èµ– Busyboxï¼Œæä¾›ç§’çº§ç²¾åº¦çš„å®šæ—¶ä»»åŠ¡ï¼Œæ”¯æŒå¤æ‚ Cron è¡¨è¾¾å¼ã€‚
* **ğŸ§  æ™ºèƒ½æ„ŸçŸ¥ç­–ç•¥**
    * **å¥åº·é”**ï¼šè‡ªåŠ¨æ£€æµ‹ F2FS `dirty_segments`ï¼Œä»…åœ¨è„æ®µè¶…è¿‡é˜ˆå€¼ (é»˜è®¤ 200) æ—¶è§¦å‘ GCï¼Œæ‹’ç»æ— æ•ˆå†™å…¥ï¼Œä¿æŠ¤é—ªå­˜å¯¿å‘½ã€‚
    * **åœºæ™¯æ„ŸçŸ¥**ï¼šæ”¯æŒ**äº®å±è·³è¿‡**ã€**ä»…å……ç”µè¿è¡Œ**ï¼Œé›¶å¹²æ‰°æ—¥å¸¸ä½¿ç”¨ã€‚
    * **Turbo GC**ï¼šåŠ¨æ€è°ƒæ•´ `gc_urgent_sleep_time`ï¼Œåœ¨æçŸ­æ—¶é—´å†…å®Œæˆåƒåœ¾å›æ”¶ï¼Œå‡å°‘ç³»ç»Ÿå”¤é†’æ—¶é—´ã€‚

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¸ç”Ÿæ•ˆ
1.  åœ¨ Magisk / KernelSU / APatch ç®¡ç†å™¨ä¸­åˆ·å…¥æœ¬æ¨¡å—ã€‚
2.  é‡å¯æ‰‹æœºã€‚
3.  ç­‰å¾…çº¦ **2-3 åˆ†é’Ÿ**ï¼ŒæœåŠ¡å°†è‡ªåŠ¨å¯åŠ¨ã€‚
4.  **æ£€æŸ¥çŠ¶æ€**ï¼šæ‰“å¼€æ¨¡å—åˆ—è¡¨ï¼Œè§‚å¯Ÿæœ¬æ¨¡å—çš„â€œæè¿°â€æ ï¼Œå®ƒä¼šæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š
    > ğŸ§¹Trim:1.2GB â™»ï¸GC:158æ®µ â±ï¸ è€—æ—¶:5ç§’ (ä¸Šæ¬¡è¿è¡Œæ—¶é—´)

### 2. æ‰‹åŠ¨è§¦å‘ (Action)
* **æ–¹æ³•**ï¼šç‚¹å‡»æ¨¡å—å¡ç‰‡ä¸Šçš„ **â€œæ“ä½œâ€ (Action)** æŒ‰é’®ã€‚
* **æ•ˆæœ**ï¼šç«‹å³æ‰§è¡Œä¸€æ¬¡å…¨é‡ä¼˜åŒ–ï¼Œå¹¶åœ¨å¼¹çª—ä¸­å®æ—¶æ˜¾ç¤ºè¿è¡Œæ—¥å¿—ã€‚æ­¤æ“ä½œä¸ä¼šå¹²æ‰°åå°å®šæ—¶ä»»åŠ¡ã€‚

### 3. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
* æ—¥å¿—è·¯å¾„ï¼š`/data/adb/modules/f2fs_optimizer/service.log`
* è¯¥æ—¥å¿—è®°å½•äº†è°ƒåº¦å™¨çš„å¯åŠ¨ã€å¿ƒè·³ç›‘æµ‹ä»¥åŠæ¯ä¸€æ¬¡ä»»åŠ¡çš„è¯¦ç»†è¾“å‡ºã€‚

---

## âš™ï¸ é«˜çº§é…ç½®æŒ‡å—

æœ¬æ¨¡å—è®¾è®¡ä¸ºâ€œå¼€ç®±å³ç”¨â€ï¼Œä½†ä½ å¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶æ¥å®šåˆ¶è¡Œä¸ºã€‚

### é…ç½®æ–‡ä»¶ 1ï¼šè°ƒåº¦ç­–ç•¥ (`service.sh`)

ä½äºæ¨¡å—æ ¹ç›®å½•ã€‚æ§åˆ¶**ä½•æ—¶**è¿è¡Œä»»åŠ¡ã€‚

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `SCHEDULE_MODE` | `"sleep"` | è°ƒåº¦æ¨¡å¼ã€‚`sleep` (æ— ä¾èµ–) æˆ– `cron` (éœ€è¦ Busybox)ã€‚ |
| `CRON_EXP` | "*/20 * * * *" | å®šæ—¶è§„åˆ™ (Cron è¡¨è¾¾å¼)ã€‚é»˜è®¤æ¯ 20 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ã€‚ |
| `SLEEP_HEARTBEAT` | `"300"` | Sleep æ¨¡å¼å¿ƒè·³é—´éš” (ç§’)ã€‚é˜²æ­¢ Doze æ¨¡å¼å¯¼è‡´å”¤é†’å»¶è¿Ÿã€‚ |
| `LOG_MODE` | `"INFO"` | æ—¥å¿—çº§åˆ«ã€‚`INFO` (è¯¦ç»†) / `ERROR` (ä»…é”™è¯¯) / `NONE` (å…³é—­)ã€‚ |
| `MAX_LOG_SIZE` | `"524288"` | æ—¥å¿—è½®æ›¿é˜ˆå€¼ (å­—èŠ‚)ã€‚é»˜è®¤ 512KBï¼Œè¶…è¿‡åä¿ç•™æœ«å°¾ 200 è¡Œã€‚ |

**Cron è¡¨è¾¾å¼æ”¯æŒæ ¼å¼** (Sleep æ¨¡å¼)ï¼š
- `*/N * * * *` - æ¯ N åˆ†é’Ÿ (å¦‚ `*/10 * * * *` = æ¯ 10 åˆ†é’Ÿ)
- `0 */N * * *` - æ¯ N å°æ—¶æ•´ç‚¹ (å¦‚ `0 */2 * * *` = æ¯ 2 å°æ—¶æ•´ç‚¹)
- `M */N * * *` - æ¯ N å°æ—¶ M åˆ† (å¦‚ `30 */2 * * *` = æ¯ 2 å°æ—¶çš„ 30 åˆ†)
- `M H * * *` - æ¯å¤©å›ºå®šæ—¶é—´ (å¦‚ `30 02 * * *` = æ¯å¤© 02:30)
> Cron æ¨¡å¼æ”¯æŒå®Œæ•´ Cron è¯­æ³•ã€‚

### æ ¸å¿ƒå‚æ•° (`f2fsopt`)

| å˜é‡å | é»˜è®¤å€¼ | è¯´æ˜ |
| :--- | :--- | :--- |
| `ENABLE_MAGISK_UI` | `true` | æ˜¯å¦å°†ç»“æœå›å†™åˆ° Magisk æ¨¡å—æè¿°æ ã€‚ |
| `ENABLE_SMART_GC` | `true` | **å¼ºçƒˆå»ºè®®å¼€å¯**ã€‚å¥åº·åˆ†åŒºè·³è¿‡ GCï¼Œä¿æŠ¤é—ªå­˜å¯¿å‘½ã€‚ |
| `ENABLE_SMART_TRIM` | `false` | å¥åº·åˆ†åŒºæ˜¯å¦è·³è¿‡ Trimã€‚é»˜è®¤å…³é—­ï¼Œå§‹ç»ˆæ‰§è¡Œ Trimã€‚ |
| `STOP_ON_SCREEN_ON` | `false` | äº®å±æ—¶æ˜¯å¦ä¸­æ–­ä»»åŠ¡ã€‚é»˜è®¤å…³é—­ï¼Œäº®å±ä¹Ÿä¼šæ‰§è¡Œã€‚ |
| `ONLY_CHARGING` | `false` | æ˜¯å¦ä»…åœ¨å……ç”µæ—¶è¿è¡Œã€‚é»˜è®¤å…³é—­ã€‚ |
| `ENABLE_TURBO_GC` | `true` | æé€Ÿ GC æ¨¡å¼ã€‚ç¼©çŸ­ç¡çœ æ—¶é—´åŠ å¿« GCï¼Œé»˜è®¤å¼€å¯ã€‚ |
| `GC_MODE_PREF` | `"1"` | GC æ¨¡å¼ã€‚`1` = å‰å° / `2` = åå°ã€‚ |
| `GC_DIRTY_MIN` | `200` | GC è§¦å‘é˜ˆå€¼ã€‚è„æ®µä½äºæ­¤å€¼è§†ä¸ºå¥åº·ã€‚ |
| `GC_MAX_SEC` | `500` | GC æœ€å¤§è¿è¡Œæ—¶é•¿ (ç§’)ã€‚ |
| `TRIM_TIMEOUT` | `500` | Trim è¶…æ—¶æ—¶é—´ (ç§’)ã€‚ |

---

## ğŸ”§ å¸¸è§é—®é¢˜ (FAQ) & æ³¨æ„äº‹é¡¹

### Q1: æ¨¡å—æè¿°æ˜¾ç¤º "GC:ğŸ’¤å¥åº·" æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ
**A:** è¿™ä¸ä»…ä¸æ˜¯é”™è¯¯ï¼Œåè€Œæ˜¯æ¨¡å—åœ¨ä¿æŠ¤ä½ çš„è®¾å¤‡ï¼è¿™è¡¨ç¤ºä½ çš„ F2FS åˆ†åŒºéå¸¸å¹²å‡€ï¼ˆè„æ®µå°‘äº `GC_DIRTY_MIN`ï¼‰ï¼Œæ— éœ€æ‰§è¡Œåƒåœ¾å›æ”¶ã€‚å¼ºè¡Œ GC åªä¼šå¾’å¢é—ªå­˜å†™å…¥é‡ï¼ˆWAï¼‰ã€‚

### Q2: ä¸ºä»€ä¹ˆæ‰‹åŠ¨æ‰§è¡Œæ—¶æ˜¾ç¤º "Trim: 0B/bytes"ï¼Ÿ
**A:** Android ç³»ç»Ÿè‡ªèº«æˆ–æœ¬æ¨¡å—å¯èƒ½åˆšåˆšæ‰§è¡Œè¿‡ Trimã€‚Trim æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœæ²¡æœ‰ç”±äºåˆ é™¤æ–‡ä»¶äº§ç”Ÿçš„è¢«é‡Šæ”¾å—ï¼Œç»“æœè‡ªç„¶ä¸º 0Bã€‚

### Q2.1: ä¸ºä»€ä¹ˆå®‰å“é«˜ç‰ˆæœ¬Trimæ˜¾ç¤º "Trim: 0KB/bytes"ï¼Ÿ
**åœ¨é«˜ç‰ˆæœ¬ Android ä¸Šï¼Œæ‰‹åŠ¨è¿è¡Œ Busybox çš„ fstrim è¿”å› 0 bytes é€šå¸¸ä¸æ˜¯å› ä¸ºå¤±è´¥ï¼Œè€Œæ˜¯ä»¥ä¸‹ä¸‰ç§ç³»ç»Ÿæœºåˆ¶å¯¼è‡´çš„â€œæ— äº‹å¯åšâ€æˆ–â€œæ— æ³•åšâ€ï¼š**
**A:** æŒ‚è½½é€‰é¡¹ discard (æœ€å¸¸è§åŸå› )
`æœºåˆ¶ï¼šç°ä»£ Android ä¸ºäº†æ€§èƒ½ï¼Œ/data åˆ†åŒºé€šå¸¸åœ¨æŒ‚è½½æ—¶å°±åŠ ä¸Šäº† discard å‚æ•°ã€‚
åæœï¼šè¿™æ„å‘³ç€å½“ä½ åˆ é™¤æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶ç³»ç»Ÿä¼šå®æ—¶å‘é—ªå­˜æ§åˆ¶å™¨å‘é€ Trim æŒ‡ä»¤ã€‚
ç°è±¡ï¼šå› ä¸ºå·²åˆ é™¤çš„å—å·²ç»è¢«å®æ—¶æ¸…ç†äº†ï¼Œç­‰ä½ æ‰‹åŠ¨è¿è¡Œ fstrim æ—¶ï¼Œå·²ç»æ²¡æœ‰å¤šä½™çš„åºŸå¼ƒå—éœ€è¦æ¸…ç†ï¼Œè‡ªç„¶æ˜¾ç¤º 0 bytes trimmedã€‚`
**B:** F2FS æ–‡ä»¶ç³»ç»Ÿçš„ç‰¹æ®Šæ€§
`æœºåˆ¶ï¼šå¦‚æœä½ çš„ /data æ˜¯ F2FS (Flash-Friendly File System)ï¼Œå®ƒä¸åƒ ext4 é‚£æ ·ä¾èµ–ä¼ ç»Ÿçš„ Trimã€‚F2FS ä¸¥é‡ä¾èµ–åå° GC (åƒåœ¾å›æ”¶) æ¥æ•´ç†ç¢ç‰‡å’Œé‡Šæ”¾ç©ºé—´ã€‚
ç°è±¡ï¼šå¯¹ F2FS æ‰§è¡Œ fstrim å¾€å¾€æ•ˆæœç”šå¾®ï¼Œæˆ–è€…å…¶ Trim é€»è¾‘è¢«é›†æˆåœ¨ Checkpoint è¿‡ç¨‹ä¸­ï¼Œæ‰‹åŠ¨è§¦å‘å¯èƒ½æ— æ³•æŒ‰é¢„æœŸå›æ”¶ç©ºé—´ã€‚
éªŒè¯ï¼šæŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿç±»å‹ã€‚å¦‚æœæ˜¯ f2fsï¼Œåº”ä¼˜å…ˆå…³æ³¨ GC è€Œé Trimã€‚`
**C:** SELinux æ‹¦æˆª (éšå½¢æ€æ‰‹)
`æœºåˆ¶ï¼šAndroid é«˜ç‰ˆæœ¬çš„ SELinux ç­–ç•¥éå¸¸ä¸¥æ ¼ã€‚è™½ç„¶ä½ æ˜¯ Rootï¼Œä½† Shell è¿›ç¨‹å¯èƒ½è¢«ç¦æ­¢å¯¹ /data åˆ†åŒºè®¾å¤‡æ–‡ä»¶æ‰§è¡Œ FITRIM ioctl æ“ä½œã€‚
ç°è±¡ï¼šioctl è°ƒç”¨è¢«é™é»˜æ‹’ç»ï¼Œå·¥å…·è™½ç„¶è¿è¡Œäº†ä½†å®é™…ä¸Šæ²¡èƒ½æŠŠæŒ‡ä»¤å‘ç»™ç£ç›˜æ§åˆ¶å™¨ï¼Œå¯¼è‡´è¿”å› 0ã€‚`

### Q3: ä¿®æ”¹é…ç½®æ–‡ä»¶åéœ€è¦é‡å¯å—ï¼Ÿ
**A:** * ä¿®æ”¹ `f2fsopt`ï¼š**ä¸éœ€è¦é‡å¯**ã€‚ä¸‹æ¬¡ä»»åŠ¡æ‰§è¡Œæ—¶è‡ªåŠ¨ç”Ÿæ•ˆã€‚
* ä¿®æ”¹ `service.sh`ï¼š**å»ºè®®é‡å¯**ã€‚æˆ–è€…åœ¨ç»ˆç«¯æ‰§è¡Œ `killall f2fsopt_scheduler` (éœ€è‡ªè¡ŒæŸ¥æ‰¾å¯¹åº”è¿›ç¨‹å) è®©å…¶é‡å¯ï¼Œæœ€ç®€å•çš„è¿˜æ˜¯é‡å¯æ‰‹æœºã€‚

### Q4: æ”¯æŒå“ªäº›æ–‡ä»¶ç³»ç»Ÿï¼Ÿ
**A:** * **F2FS / MIFS (Xiaomi)**: æ”¯æŒå®Œæ•´çš„ Trim + GC (åƒåœ¾å›æ”¶)ã€‚
* **EXT4**: ä»…æ”¯æŒ Trim (EXT4 æ— éœ€ç”¨æˆ·æ€ GC)ã€‚

### Q5: 1è„æ®µç­‰äºå¤šå°‘MB?
**A:** ç»“è®º
`1 ä¸ªæ®µ (Segment) â‰ˆ 2 MB`
**B:** è®¡ç®—
`F2FS çš„å­˜å‚¨ç»“æ„æ ‡å‡†é»˜è®¤é…ç½®å¦‚ä¸‹ï¼š
Block Size (å—å¤§å°)ï¼šé»˜è®¤ä¸º 4 KBã€‚
Blocks per Segment (æ¯æ®µå—æ•°)ï¼šé»˜è®¤ä¸º 512 ä¸ªå—ã€‚`
**Cï¼š** è®¡ç®—å…¬å¼
`4 KB X 512 = 2048 KB = 2 MB`

### âš ï¸ é£é™©æç¤º
1.  **æ•°æ®å®‰å…¨**ï¼šæœ¬æ¨¡å—ä½¿ç”¨æ ‡å‡†çš„ Linux å†…æ ¸æŒ‡ä»¤ (`fstrim`, `ioctl`)ï¼Œç†è®ºä¸Šéå¸¸å®‰å…¨ã€‚ä½†ä»»ä½•æ¶‰åŠåº•å±‚æ–‡ä»¶ç³»ç»Ÿçš„æ“ä½œéƒ½æœ‰æå°æ¦‚ç‡çš„é£é™©ï¼Œè¯·ä¿æŒå®šæœŸå¤‡ä»½é‡è¦æ•°æ®çš„ä¹ æƒ¯ã€‚
2.  **å†²çªæ’æŸ¥**ï¼šè¯·å‹¿ä¸å…¶ä»– F2FS ä¼˜åŒ–ç±»æ¨¡å—ï¼ˆå°¤å…¶æ˜¯åŒ…å«æ¿€è¿› GC ç­–ç•¥çš„æ¨¡å—ï¼‰æ··ç”¨ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´å¡é¡¿æˆ–å¼‚å¸¸è€—ç”µã€‚

---

**å…è´£å£°æ˜**: æœ¬æ¨¡å—æ¶‰åŠåº•å±‚æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼Œè™½å·²åŒ…å«å®Œå–„çš„å®‰å…¨æœºåˆ¶å’Œé”™è¯¯å¤„ç†ï¼Œä½†ä½œè€…ä¸å¯¹ç¡¬ä»¶è€åŒ–æˆ–ä¸å½“æ“ä½œå¯¼è‡´çš„æ•°æ®ä¸¢å¤±è´Ÿè´£ã€‚è¯·å®šæœŸå¤‡ä»½é‡è¦æ•°æ®ã€‚

> å¦‚æœé‡åˆ° Bugï¼Œè¯·æä¾› `/data/adb/modules/f2fs_optimizer/service.log` ä»¥ä¾¿æ’æŸ¥ã€‚

