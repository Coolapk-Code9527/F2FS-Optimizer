<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="color-scheme" content="light dark">
<title>F2FS-Optimizer - Web UI</title>
<style>
/* ===== macOS 风格基础样式 ===== */
:root {
  --bg-primary: #f5f5f7;
  --bg-card: rgba(255,255,255,0.72);
  --bg-input: rgba(255,255,255,0.9);
  --text-primary: #1d1d1f;
  --text-secondary: #86868b;
  --text-tertiary: #6e6e73;
  --border-color: rgba(0,0,0,0.1);
  --accent: #007AFF;
  --accent-hover: #0056b3;
  --success: #34C759;
  --warning: #FF9500;
  --danger: #FF3B30;
  --shadow: 0 4px 24px rgba(0,0,0,0.08);
  --shadow-hover: 0 8px 32px rgba(0,0,0,0.12);
  --blur: blur(20px);
  --radius-lg: 12px;
  --radius-md: 8px;
  --radius-sm: 6px;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 15px;
  --font-size-lg: 17px;
  --font-size-xl: 22px;
  --font-size-2xl: 28px;
  --line-height-tight: 1.25;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.75;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 12px;
  --spacing-lg: 16px;
  --spacing-xl: 20px;
  --spacing-2xl: 24px;
  --spacing-3xl: 28px;
  --icon-size-sm: 16px;
  --icon-size-md: 20px;
  --icon-size-lg: 24px;
  --card-gap: 24px;
  --transition-fast: 0.15s;
  --transition-normal: 0.3s;
  --transition-slow: 0.5s;
}
@media (prefers-color-scheme: dark) {
  :root {
    --bg-primary: #1d1d1f;
    --bg-card: rgba(44,44,46,0.72);
    --bg-input: rgba(58,58,60,0.9);
    --text-primary: #f5f5f7;
    --text-secondary: #98989d;
    --text-tertiary: #8e8e93;
    --border-color: rgba(255,255,255,0.1);
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
    --shadow-hover: 0 8px 32px rgba(0,0,0,0.4);
  }
}

/* 主题切换平滑过渡 */
*{
  margin:0;
  padding:0;
  box-sizing:border-box;
  transition:background-color var(--transition-normal) ease,
             color var(--transition-normal) ease,
             border-color var(--transition-normal) ease;
}

/* 排除不需要过渡的元素 */
*:where(button, input, select, .toggle::after, .status-spinner) {
  transition:all var(--transition-normal) ease;
}

body{
  font-family:-apple-system,BlinkMacSystemFont,"SF Pro Display","SF Pro Text","Helvetica Neue",sans-serif;
  background:var(--bg-primary);
  color:var(--text-primary);
  padding:var(--spacing-xl);
  font-size:var(--font-size-base);
  line-height:var(--line-height-normal);
  font-weight:var(--font-weight-normal);
  -webkit-font-smoothing:antialiased;
}
.container{max-width:900px;margin:0 auto}

/* ===== 毛玻璃卡片 ===== */
.card{
  background:var(--bg-card);
  backdrop-filter:var(--blur);
  -webkit-backdrop-filter:var(--blur);
  border-radius:var(--radius-lg);
  border:1px solid var(--border-color);
  padding:var(--spacing-2xl) var(--spacing-3xl);
  margin-bottom:var(--card-gap);
  box-shadow:var(--shadow);
  transition:transform 0.2s ease,box-shadow 0.2s ease;
}
.card:hover{
  transform:translateY(-4px);
  box-shadow:0 12px 40px rgba(0,0,0,0.15);
}

/* 卡片变体 - 带标识色边框 */
.card-accent {
  border-left:4px solid var(--accent);
}

.card-success {
  border-left:4px solid var(--success);
}

.card-warning {
  border-left:4px solid var(--warning);
}

@media (prefers-color-scheme: dark) {
  .card:hover{
    box-shadow:0 12px 40px rgba(0,0,0,0.4);
  }
}

/* ===== 标题样式 ===== */
h1{
  font-size:var(--font-size-2xl);
  font-weight:var(--font-weight-semibold);
  line-height:var(--line-height-tight);
  margin-bottom:var(--spacing-sm);
  letter-spacing:-0.5px;
}
h2{
  font-size:20px;
  font-weight:600;
  line-height:var(--line-height-tight);
  margin-bottom:24px;
  color:var(--text-primary);
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px 16px;
  margin-left:-16px;
  margin-right:-16px;
  border-radius:var(--radius-md);
  background:rgba(0,122,255,0.05);
}
h2 .icon{
  color:var(--accent);
  width:var(--icon-size-lg);
  height:var(--icon-size-lg);
  flex-shrink:0;
}

/* 标题变体 - 不同颜色 */
.card-success h2{
  background:rgba(52,199,89,0.05);
}
.card-success h2 .icon{
  color:var(--success);
}

@media (prefers-color-scheme: dark) {
  h2{
    background:rgba(0,122,255,0.08);
  }
  .card-success h2{
    background:rgba(52,199,89,0.08);
  }
}

/* ===== 状态徽章 ===== */
.status-badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
  font-weight:500;
  background:rgba(134,134,139,0.12);
  color:var(--text-secondary);
}
.status-badge.running{background:rgba(52,199,89,0.15);color:var(--success)}
.status-badge.stopped{background:rgba(255,59,48,0.15);color:var(--danger)}
.status-badge .icon{
  width:16px;
  height:16px;
}

/* ===== 状态网格 ===== */
.status-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
  gap:12px;
  margin-top:16px;
}
.status-item{
  background:var(--bg-input);
  padding:16px;
  border-radius:var(--radius-md);
  border:1px solid var(--border-color);
  transition:transform 0.15s ease;
}
.status-item:hover{transform:scale(1.02)}
.status-label{font-size:12px;color:var(--text-tertiary);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px}
.status-value{font-size:15px;font-weight:500;color:var(--text-primary)}

/* ===== 表单样式 ===== */
.form-group{margin-bottom:var(--spacing-xl)}
.form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-xl)}
label{
  display:block;
  margin-bottom:var(--spacing-sm);
  color:var(--text-secondary);
  font-size:var(--font-size-sm);
  font-weight:var(--font-weight-medium);
}
input[type="text"],input[type="number"],select{
  width:100%;
  height:44px;
  padding:10px 14px;
  background:var(--bg-input);
  border:1px solid var(--border-color);
  border-radius:var(--radius-md);
  color:var(--text-primary);
  font-size:15px;
  transition:border-color var(--transition-normal),box-shadow var(--transition-normal),transform var(--transition-fast);
  -webkit-appearance:none;
  appearance:none;
}
input:focus,select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 4px rgba(0,122,255,0.15);
  transform:translateY(-1px);
}
input.error,select.error{
  border-color:var(--danger);
  box-shadow:0 0 0 4px rgba(255,59,48,0.1);
}
select{
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2386868b' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:right 14px center;
  padding-right:36px;
  cursor:pointer;
}
.help-text{
  font-size:var(--font-size-sm);
  color:var(--text-tertiary);
  margin-top:6px;
  line-height:var(--line-height-normal);
}
.error-text{
  font-size:var(--font-size-sm);
  color:var(--danger);
  margin-top:6px;
  display:none;
  font-weight:var(--font-weight-medium);
}
.error-text.show{display:block}

/* ===== macOS 风格开关 ===== */
.toggle-group{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color)}
.toggle-group:last-child{border-bottom:none}
.toggle-info{flex:1}
.toggle-label{font-size:15px;font-weight:500;color:var(--text-primary);margin-bottom:2px}
.toggle-desc{font-size:12px;color:var(--text-tertiary)}
.toggle{
  position:relative;
  width:51px;
  height:31px;
  background:#e9e9eb;
  border-radius:15.5px;
  cursor:pointer;
  transition:background var(--transition-normal) ease;
  flex-shrink:0;
}
@media (prefers-color-scheme: dark) {
  .toggle{background:#39393d}
}
.toggle.active{background:var(--success)}
.toggle::after{
  content:'';
  position:absolute;
  top:2px;
  left:2px;
  width:27px;
  height:27px;
  background:#fff;
  border-radius:50%;
  box-shadow:0 3px 8px rgba(0,0,0,0.15),0 1px 1px rgba(0,0,0,0.06);
  transition:transform var(--transition-normal) cubic-bezier(0.4, 0.0, 0.2, 1);
}
.toggle.active::after{transform:translateX(20px)}
.toggle:hover::after{
  box-shadow:0 4px 12px rgba(0,0,0,0.2),0 2px 4px rgba(0,0,0,0.1);
}

/* ===== 按钮样式 ===== */
.button-group{display:flex;flex-wrap:wrap;gap:var(--spacing-md);margin-top:var(--spacing-md)}
button{
  min-width:120px;
  height:44px;
  padding:12px 24px;
  background:var(--accent);
  color:#fff;
  border:none;
  border-radius:var(--radius-md);
  cursor:pointer;
  font-size:14px;
  font-weight:500;
  transition:all var(--transition-normal) ease;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:6px;
  position:relative;
  overflow:hidden;
}
button:hover{
  background:var(--accent-hover);
  transform:translateY(-2px);
  box-shadow:0 4px 12px rgba(0,122,255,0.3);
}
button:active{
  transform:translateY(0) scale(0.98);
}
button:disabled{
  opacity:0.5;
  cursor:not-allowed;
  transform:none;
  box-shadow:none;
}
button.secondary{
  background:var(--bg-input);
  color:var(--text-primary);
  border:1px solid var(--border-color);
}
button.secondary:hover{
  background:var(--border-color);
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
button.danger{background:var(--danger)}
button.danger:hover{
  background:#e0312b;
  box-shadow:0 4px 12px rgba(255,59,48,0.3);
}
button.success{background:var(--success)}
button.success:hover{
  background:#2db84e;
  box-shadow:0 4px 12px rgba(52,199,89,0.3);
}
button.loading{
  pointer-events:none;
  opacity:0.7;
}
button.loading::after{
  content:'';
  position:absolute;
  width:16px;
  height:16px;
  top:50%;
  left:50%;
  margin-left:-8px;
  margin-top:-8px;
  border:2px solid transparent;
  border-top-color:currentColor;
  border-radius:50%;
  animation:button-loading-spinner 0.6s linear infinite;
}
@keyframes button-loading-spinner{
  from{transform:rotate(0deg)}
  to{transform:rotate(360deg)}
}

@media (prefers-color-scheme: dark) {
  button.secondary:hover{
    box-shadow:0 4px 12px rgba(255,255,255,0.1);
  }
}

/* ===== 操作项 ===== */
.action-item{
  display:flex;
  align-items:center;
  gap:16px;
  padding:14px 0;
  border-bottom:1px solid var(--border-color);
}
.action-item:last-child{border-bottom:none}
.action-item button{min-width:130px;justify-content:center}
.action-desc{font-size:13px;color:var(--text-tertiary);flex:1}

/* ===== 日志框 ===== */
.log-box{
  background:var(--bg-input);
  padding:16px;
  border-radius:var(--radius-md);
  height:350px;
  overflow-y:auto;
  font-family:"SF Mono","Monaco","Menlo",monospace;
  font-size:12px;
  line-height:1.8;
  white-space:pre-wrap;
  word-break:break-all;
  border:1px solid var(--border-color);
  color:var(--text-primary);
}
.log-box::-webkit-scrollbar{width:8px}
.log-box::-webkit-scrollbar-track{background:transparent}
.log-box::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:4px}

/* 日志语法高亮 */
.log-timestamp{
  color:var(--text-tertiary);
  font-weight:500;
}
.log-level-info{
  color:var(--accent);
  font-weight:500;
}
.log-level-warn{
  color:var(--warning);
  font-weight:600;
}
.log-level-error{
  color:var(--danger);
  font-weight:600;
}
.log-success{
  color:var(--success);
  font-weight:500;
}

/* ===== Toast 通知 ===== */
.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--bg-card);
  backdrop-filter:var(--blur);
  -webkit-backdrop-filter:var(--blur);
  color:var(--text-primary);
  padding:14px 20px;
  border-radius:var(--radius-md);
  border:1px solid var(--border-color);
  box-shadow:var(--shadow-hover);
  opacity:0;
  transform:translateY(-10px);
  transition:all 0.3s ease;
  z-index:1000;
  display:flex;
  align-items:center;
  gap:10px;
  max-width:360px;
  cursor:pointer;
}
.toast.show{opacity:1;transform:translateY(0)}
.toast.success{border-left:4px solid var(--success)}
.toast.error{border-left:4px solid var(--danger)}
.toast-icon{
  font-size:18px;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:center;
}
@media (max-width:600px){
  .toast{top:10px;right:10px;left:10px;max-width:none}
}

/* ===== 分组标题 ===== */
.section-title{
  font-size:13px;
  font-weight:600;
  color:var(--text-primary);
  text-transform:uppercase;
  letter-spacing:0.8px;
  margin:28px 0 16px;
  padding:8px 12px;
  background:rgba(0,122,255,0.08);
  border-radius:6px;
  border-left:3px solid var(--accent);
}
.section-title:first-child{margin-top:0}

@media (prefers-color-scheme: dark) {
  .section-title{
    background:rgba(0,122,255,0.12);
  }
}

/* ===== Cron 快捷选择容器 ===== */
.cron-presets-container{
  margin-top:16px;
  padding:16px;
  background:var(--bg-input);
  border:1px solid var(--border-color);
  border-radius:var(--radius-md);
  max-height:400px;
  overflow-y:auto;
}
.cron-presets-container::-webkit-scrollbar{width:6px}
.cron-presets-container::-webkit-scrollbar-track{background:transparent}
.cron-presets-container::-webkit-scrollbar-thumb{background:var(--border-color);border-radius:3px}

/* 搜索输入框包装器 */
.preset-search-wrapper{
  position:relative;
  margin-bottom:16px;
}

/* 搜索输入框 */
.preset-search{
  width:100%;
  height:40px;
  padding:8px 36px 8px 36px;
  background:var(--bg-card);
  border:1px solid var(--border-color);
  border-radius:var(--radius-md);
  color:var(--text-primary);
  font-size:14px;
  transition:border-color var(--transition-fast),box-shadow var(--transition-fast);
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2386868b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position:12px center;
}
.preset-search:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,122,255,0.1);
}
.preset-search::placeholder{
  color:var(--text-tertiary);
}

/* 清空搜索按钮 */
.preset-search-clear{
  position:absolute;
  right:8px;
  top:50%;
  transform:translateY(-50%);
  width:24px;
  height:24px;
  min-width:24px;
  padding:0;
  background:var(--border-color);
  border:none;
  border-radius:50%;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:background var(--transition-fast),opacity var(--transition-fast);
  opacity:0.7;
}
.preset-search-clear:hover{
  background:var(--text-tertiary);
  opacity:1;
  transform:translateY(-50%);
  box-shadow:none;
}
.preset-search-clear .icon{
  stroke:var(--bg-card);
}

/* 分组样式 */
.preset-group{
  margin-bottom:16px;
}
.preset-group:last-child{
  margin-bottom:0;
}
.preset-group-title{
  display:flex;
  align-items:center;
  gap:8px;
  font-size:12px;
  font-weight:600;
  color:var(--text-secondary);
  text-transform:uppercase;
  letter-spacing:0.5px;
  margin-bottom:10px;
  padding:6px 10px;
  background:rgba(0,122,255,0.05);
  border-radius:var(--radius-sm);
  border-left:3px solid var(--accent);
}
.preset-group-title .icon{
  width:14px;
  height:14px;
  stroke:var(--accent);
}
@media (prefers-color-scheme: dark) {
  .preset-group-title{
    background:rgba(0,122,255,0.1);
  }
}

/* 选项容器 */
.preset-items{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
}

/* 旧版快捷选项（兼容） */
.cron-presets{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}

/* 快捷选项样式 */
.cron-preset{
  padding:8px 14px;
  background:var(--bg-card);
  border:1px solid var(--border-color);
  border-radius:var(--radius-sm);
  font-size:12px;
  color:var(--text-secondary);
  cursor:pointer;
  transition:all var(--transition-fast) ease;
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-weight:500;
  position:relative;
}
.cron-preset .icon{
  width:14px;
  height:14px;
  stroke:var(--text-tertiary);
  transition:stroke var(--transition-fast);
}
.cron-preset:hover{
  border-color:var(--accent);
  color:var(--accent);
  background:rgba(0,122,255,0.05);
  transform:translateY(-1px);
}
.cron-preset:hover .icon{
  stroke:var(--accent);
}
.cron-preset:active{
  transform:translateY(0) scale(0.98);
}

/* 激活/高亮状态 */
.cron-preset.active{
  border-color:var(--accent);
  background:rgba(0,122,255,0.1);
  color:var(--accent);
  box-shadow:0 0 0 2px rgba(0,122,255,0.2);
}
.cron-preset.active .icon{
  stroke:var(--accent);
}

/* 焦点状态 (键盘导航) */
.cron-preset:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px rgba(0,122,255,0.3);
}
.cron-preset:focus-visible{
  outline:2px solid var(--accent);
  outline-offset:2px;
}

/* 推荐标记 */
.preset-badge{
  display:inline-flex;
  align-items:center;
  padding:2px 6px;
  border-radius:10px;
  font-size:10px;
  font-weight:600;
  margin-left:4px;
}

/* 推荐标记样式 */
.preset-badge.preset-recommended{
  background:rgba(52,199,89,0.15);
  color:var(--success);
}

/* 频率标记 - 极高频 */
.preset-badge.frequency-very-high{
  background:rgba(255,59,48,0.15);
  color:var(--danger);
}

/* 频率标记 - 高频 */
.preset-badge.frequency-high{
  background:rgba(255,149,0,0.15);
  color:var(--warning);
}

/* 频率标记 - 中频 */
.preset-badge.frequency-medium{
  background:rgba(255,149,0,0.15);
  color:var(--warning);
}

/* 频率标记 - 低频 */
.preset-badge.frequency-low{
  background:rgba(0,122,255,0.15);
  color:var(--accent);
}

/* 隐藏状态 (用于搜索过滤) */
.preset-group.hidden,
.cron-preset.hidden{
  display:none !important;
}

/* 无结果提示 */
.preset-no-results{
  display:none;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:32px 16px;
  text-align:center;
}

/* 跨模式警告提示框 */
.cross-mode-warning{
  display:flex;
  align-items:flex-start;
  gap:12px;
  padding:12px 16px;
  margin-top:12px;
  background:rgba(255,149,0,0.1);
  border:1px solid rgba(255,149,0,0.3);
  border-radius:var(--radius-md);
  border-left:4px solid var(--warning);
  animation:fadeIn var(--transition-normal) ease-out;
}
.cross-mode-warning .icon{
  width:20px;
  height:20px;
  stroke:var(--warning);
  flex-shrink:0;
  margin-top:2px;
}
.cross-mode-warning-content{
  flex:1;
}
.cross-mode-warning-title{
  font-size:14px;
  font-weight:600;
  color:var(--text-primary);
  margin-bottom:4px;
}
.cross-mode-warning-message{
  font-size:12px;
  color:var(--text-secondary);
  line-height:1.5;
}
.cross-mode-warning.error{
  background:rgba(255,59,48,0.1);
  border-color:rgba(255,59,48,0.3);
  border-left-color:var(--danger);
}
.cross-mode-warning.error .icon{
  stroke:var(--danger);
}

/* 禁用状态的输入框 */
input[type="text"]:disabled,
input[type="number"]:disabled{
  background:var(--bg-input);
  opacity:0.5;
  cursor:not-allowed;
}
input[type="text"]:disabled::placeholder,
input[type="number"]:disabled::placeholder{
  color:var(--text-tertiary);
}

@keyframes fadeIn{
  from{opacity:0;transform:translateY(-8px)}
  to{opacity:1;transform:translateY(0)}
}

/* 性能建议提示 */
.performance-tip{
  display:flex;
  align-items:center;
  gap:8px;
  padding:10px 14px;
  margin-top:12px;
  border-radius:var(--radius-md);
  font-size:12px;
  animation:fadeIn var(--transition-normal) ease-out;
}
.performance-tip.very-high{
  background:rgba(255,59,48,0.1);
  border:1px solid rgba(255,59,48,0.2);
  color:var(--danger);
}
.performance-tip.high{
  background:rgba(255,149,0,0.1);
  border:1px solid rgba(255,149,0,0.2);
  color:var(--warning);
}
.performance-tip.medium{
  background:rgba(255,149,0,0.1);
  border:1px solid rgba(255,149,0,0.2);
  color:var(--warning);
}
.performance-tip.low{
  background:rgba(52,199,89,0.1);
  border:1px solid rgba(52,199,89,0.2);
  color:var(--success);
}
.performance-tip .icon{
  width:16px;
  height:16px;
  flex-shrink:0;
}

/* Cron 预览 */
.cron-preview{
  font-size:12px;
  color:var(--success);
  margin-top:6px;
  display:none;
  font-weight:500;
}
.cron-preview.show{display:block}

/* ===== 响应式 - 快捷选项 ===== */
@media (max-width:600px){
  .cron-presets-container{
    padding:12px;
    max-height:300px;
  }
  .preset-search-wrapper{
    margin-bottom:12px;
  }
  .preset-search{
    height:44px;
    font-size:16px; /* 防止 iOS 缩放 */
    padding-right:40px;
  }
  .preset-search-clear{
    width:28px;
    height:28px;
    min-width:28px;
    right:10px;
  }
  .preset-group-title{
    font-size:11px;
    padding:5px 8px;
  }
  .preset-items{
    gap:6px;
  }
  .cron-preset{
    padding:10px 12px;
    font-size:13px;
    min-height:40px;
  }
  .preset-badge{
    font-size:9px;
    padding:2px 5px;
  }
  .cross-mode-warning{
    padding:10px 12px;
  }
  .cross-mode-warning-title{
    font-size:13px;
  }
  .cross-mode-warning-message{
    font-size:11px;
  }
}

/* ===== 响应式 ===== */
@media (max-width:600px){
  :root{
    --font-size-2xl:var(--font-size-xl);
    --font-size-xl:18px;
    --font-size-lg:16px;
  }
  body{padding:var(--spacing-md)}
  .card{
    padding:var(--spacing-lg) var(--spacing-xl);
    margin-bottom:var(--spacing-lg);
  }
  .form-row{grid-template-columns:1fr}
  .button-group{flex-direction:column}
  .button-group button{
    width:100%;
    min-height:44px;
  }
  .action-item{
    flex-direction:column;
    align-items:stretch;
    gap:var(--spacing-md);
    padding:var(--spacing-lg) 0;
  }
  .action-item button{
    width:100%;
    min-width:auto;
    min-height:44px;
  }
  .action-desc{text-align:center}
  .toggle-group{
    flex-wrap:wrap;
    gap:var(--spacing-md);
    padding:var(--spacing-lg) 0;
  }
  .toggle{
    min-width:51px;
    min-height:31px;
  }
  .cron-presets{justify-content:center}
  .cron-preset{
    min-height:36px;
    padding:8px 14px;
  }
  /* 确保输入框触摸目标足够大 */
  input[type="text"],
  input[type="number"],
  select{
    min-height:44px;
  }
  /* 移动端隐藏悬停效果 */
  .card:hover{
    transform:none;
  }
  button:hover{
    transform:none;
  }
  /* 优化移动端间距 */
  h2{
    font-size:18px;
    margin-bottom:var(--spacing-lg);
  }
  .section-title{
    margin:var(--spacing-lg) 0 var(--spacing-md);
  }
}

/* ===== 配置状态提示框 ===== */
.alert-box{
  display:flex;
  align-items:flex-start;
  gap:var(--spacing-md);
  padding:var(--spacing-lg);
  margin-top:var(--spacing-lg);
  background:rgba(255,149,0,0.1);
  border:1px solid rgba(255,149,0,0.3);
  border-radius:var(--radius-md);
  border-left:4px solid var(--warning);
}
.alert-icon{
  font-size:var(--font-size-xl);
  line-height:1;
  width:24px;
  height:24px;
  flex-shrink:0;
}
.alert-content{
  flex:1;
}
.alert-title{
  font-size:var(--font-size-md);
  font-weight:var(--font-weight-semibold);
  margin-bottom:var(--spacing-xs);
}
.alert-message{
  font-size:var(--font-size-sm);
  color:var(--text-secondary);
  margin-bottom:var(--spacing-sm);
}
.alert-box.info{
  background:rgba(0,122,255,0.1);
  border-color:rgba(0,122,255,0.3);
  border-left-color:var(--accent);
}
.alert-box.success{
  background:rgba(52,199,89,0.1);
  border-color:rgba(52,199,89,0.3);
  border-left-color:var(--success);
}
.alert-box.error{
  background:rgba(255,59,48,0.1);
  border-color:rgba(255,59,48,0.3);
  border-left-color:var(--danger);
}
.btn-link{
  background:none;
  border:none;
  color:var(--accent);
  font-size:var(--font-size-sm);
  font-weight:var(--font-weight-medium);
  cursor:pointer;
  padding:0;
  text-decoration:underline;
  transition:color var(--transition-fast);
}
.btn-link:hover{
  color:var(--accent-hover);
}

/* ===== 执行进度模态框 ===== */
.modal-overlay{
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.5);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1000;
  backdrop-filter:blur(4px);
  -webkit-backdrop-filter:blur(4px);
  animation:modalFadeIn var(--transition-normal) ease-out;
}
.modal-content{
  background:var(--bg-card);
  backdrop-filter:var(--blur);
  -webkit-backdrop-filter:var(--blur);
  border-radius:var(--radius-lg);
  border:1px solid var(--border-color);
  padding:var(--spacing-3xl);
  max-width:600px;
  width:90%;
  max-height:80vh;
  overflow-y:auto;
  box-shadow:var(--shadow-hover);
  animation:modalSlideIn var(--transition-normal) ease-out;
}

@keyframes modalFadeIn{
  from{
    opacity:0;
  }
  to{
    opacity:1;
  }
}

@keyframes modalSlideIn{
  from{
    opacity:0;
    transform:translateY(-20px) scale(0.95);
  }
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

.modal-header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  margin-bottom:var(--spacing-lg);
}
.modal-title{
  font-size:var(--font-size-lg);
  font-weight:var(--font-weight-semibold);
}
.modal-close{
  background:none;
  border:none;
  font-size:var(--font-size-xl);
  color:var(--text-secondary);
  cursor:pointer;
  padding:0;
  width:32px;
  height:32px;
  display:flex;
  align-items:center;
  justify-content:center;
  border-radius:50%;
  transition:background var(--transition-fast) ease;
}
.modal-close:hover{
  background:var(--border-color);
}
.execution-log{
  background:var(--bg-input);
  border:1px solid var(--border-color);
  border-radius:var(--radius-md);
  padding:var(--spacing-md);
  font-family:'SF Mono',Monaco,Consolas,monospace;
  font-size:var(--font-size-xs);
  line-height:var(--line-height-relaxed);
  max-height:400px;
  overflow-y:auto;
  white-space:pre-wrap;
  word-break:break-all;
}
.execution-status{
  display:flex;
  align-items:center;
  gap:var(--spacing-sm);
  padding:var(--spacing-md);
  margin-bottom:var(--spacing-lg);
  background:var(--bg-input);
  border-radius:var(--radius-md);
}
.status-spinner{
  width:20px;
  height:20px;
  border:2px solid var(--border-color);
  border-top-color:var(--accent);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{
  to{transform:rotate(360deg)}
}
.status-icon{
  font-size:var(--font-size-lg);
  width:24px;
  height:24px;
}
.status-icon{
  font-size:var(--font-size-lg);
}
.status-text{
  flex:1;
  font-size:var(--font-size-sm);
  color:var(--text-secondary);
}

/* ===== SVG 图标系统 ===== */
.icon {
  display: inline-block;
  vertical-align: middle;
  flex-shrink: 0;
  stroke: currentColor;
  fill: none;
  stroke-width: 2;
  stroke-linecap: round;
  stroke-linejoin: round;
}

.icon-small { 
  width: var(--icon-size-sm); 
  height: var(--icon-size-sm); 
}

.icon-medium { 
  width: var(--icon-size-md); 
  height: var(--icon-size-md); 
}

.icon-large { 
  width: var(--icon-size-lg); 
  height: var(--icon-size-lg); 
}
</style>
</head>
<body>
<!-- SVG 图标库 -->
<svg style="display:none" aria-hidden="true">
  <defs>
    <!-- 保存图标 -->
    <symbol id="icon-save" viewBox="0 0 24 24">
      <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
      <polyline points="17 21 17 13 7 13 7 21"/>
      <polyline points="7 3 7 8 15 8"/>
    </symbol>
    
    <!-- 重新加载图标 -->
    <symbol id="icon-reload" viewBox="0 0 24 24">
      <polyline points="23 4 23 10 17 10"/>
      <polyline points="1 20 1 14 7 14"/>
      <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
    </symbol>
    
    <!-- 播放图标 -->
    <symbol id="icon-play" viewBox="0 0 24 24">
      <polygon points="5 3 19 12 5 21 5 3"/>
    </symbol>
    
    <!-- 重启图标 -->
    <symbol id="icon-restart" viewBox="0 0 24 24">
      <polyline points="1 4 1 10 7 10"/>
      <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
    </symbol>
    
    <!-- 刷新图标 -->
    <symbol id="icon-refresh" viewBox="0 0 24 24">
      <polyline points="23 4 23 10 17 10"/>
      <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
    </symbol>
    
    <!-- 删除图标 -->
    <symbol id="icon-delete" viewBox="0 0 24 24">
      <polyline points="3 6 5 6 21 6"/>
      <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
      <line x1="10" y1="11" x2="10" y2="17"/>
      <line x1="14" y1="11" x2="14" y2="17"/>
    </symbol>
    
    <!-- 暂停图标 -->
    <symbol id="icon-pause" viewBox="0 0 24 24">
      <rect x="6" y="4" width="4" height="16"/>
      <rect x="14" y="4" width="4" height="16"/>
    </symbol>
    
    <!-- 关闭图标 -->
    <symbol id="icon-close" viewBox="0 0 24 24">
      <line x1="18" y1="6" x2="6" y2="18"/>
      <line x1="6" y1="6" x2="18" y2="18"/>
    </symbol>
    
    <!-- 取消图标 -->
    <symbol id="icon-cancel" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
      <line x1="15" y1="9" x2="9" y2="15"/>
      <line x1="9" y1="9" x2="15" y2="15"/>
    </symbol>
    
    <!-- 成功/对勾圆圈图标 -->
    <symbol id="icon-check-circle" viewBox="0 0 24 24">
      <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
      <polyline points="22 4 12 14.01 9 11.01"/>
    </symbol>
    
    <!-- 错误/X圆圈图标 -->
    <symbol id="icon-x-circle" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
      <line x1="15" y1="9" x2="9" y2="15"/>
      <line x1="9" y1="9" x2="15" y2="15"/>
    </symbol>
    
    <!-- 警告/三角形图标 -->
    <symbol id="icon-alert-triangle" viewBox="0 0 24 24">
      <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
      <line x1="12" y1="9" x2="12" y2="13"/>
      <line x1="12" y1="17" x2="12.01" y2="17"/>
    </symbol>
    
    <!-- 信息圆圈图标 -->
    <symbol id="icon-info-circle" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
      <line x1="12" y1="16" x2="12" y2="12"/>
      <line x1="12" y1="8" x2="12.01" y2="8"/>
    </symbol>
    
    <!-- 活动/运行图标 -->
    <symbol id="icon-activity" viewBox="0 0 24 24">
      <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
    </symbol>
    
    <!-- 圆圈图标 -->
    <symbol id="icon-circle" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
    </symbol>
    
    <!-- 下拉箭头图标 -->
    <symbol id="icon-chevron-down" viewBox="0 0 24 24">
      <polyline points="6 9 12 15 18 9"/>
    </symbol>
    
    <!-- 设置图标 -->
    <symbol id="icon-settings" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="3"/>
      <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
    </symbol>
    
    <!-- 文件文本/日志图标 -->
    <symbol id="icon-file-text" viewBox="0 0 24 24">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
      <line x1="16" y1="13" x2="8" y2="13"/>
      <line x1="16" y1="17" x2="8" y2="17"/>
      <polyline points="10 9 9 9 8 9"/>
    </symbol>
    
    <!-- 时钟图标 -->
    <symbol id="icon-clock" viewBox="0 0 24 24">
      <circle cx="12" cy="12" r="10"/>
      <polyline points="12 6 12 12 16 14"/>
    </symbol>
    
    <!-- 数据库图标 -->
    <symbol id="icon-database" viewBox="0 0 24 24">
      <ellipse cx="12" cy="5" rx="9" ry="3"/>
      <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/>
      <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/>
    </symbol>
    
    <!-- 搜索图标 -->
    <symbol id="icon-search" viewBox="0 0 24 24">
      <circle cx="11" cy="11" r="8"/>
      <line x1="21" y1="21" x2="16.65" y2="16.65"/>
    </symbol>
    
    <!-- 星星图标 (推荐) -->
    <symbol id="icon-star" viewBox="0 0 24 24">
      <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
    </symbol>
    
    <!-- 闪电图标 (高频) -->
    <symbol id="icon-zap" viewBox="0 0 24 24">
      <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
    </symbol>
  </defs>
</svg>

<div class="container">
<!-- 状态概览卡片 -->
<div class="card">
<h1>F2FS-Optimizer</h1>
<span class="status-badge" id="statusBadge">加载中</span>
<div class="status-grid">
<div class="status-item">
<div class="status-label">服务状态</div>
<div class="status-value" id="serviceStatus">加载中...</div>
</div>
<div class="status-item">
<div class="status-label">最后运行</div>
<div class="status-value" id="lastRun">加载中...</div>
</div>
<div class="status-item">
<div class="status-label">日志大小</div>
<div class="status-value" id="logSize">加载中...</div>
</div>
<div class="status-item">
<div class="status-label">配置状态</div>
<div class="status-value" id="configStatus">加载中...</div>
</div>
<div class="status-item">
<div class="status-label">下次执行</div>
<div class="status-value" id="nextRun">加载中...</div>
</div>
</div>
<!-- 配置待生效提示 -->
<div id="pendingChangesAlert" class="alert-box" style="display:none">
<div class="alert-icon"><svg class="icon icon-large" style="stroke:var(--warning)"><use href="#icon-alert-triangle"/></svg></div>
<div class="alert-content">
<div class="alert-title">配置待生效</div>
<div class="alert-message" id="pendingChangesMessage"></div>
<button class="btn-link" onclick="triggerImmediateExecution()">立即应用配置</button>
</div>
</div>
</div>

<!-- 调度器配置 -->
<div class="card card-accent">
<h2><svg class="icon icon-large"><use href="#icon-settings"/></svg>调度器配置</h2>
<form id="configForm">
<div class="form-row">
<div class="form-group">
<label>调度模式</label>
<select id="scheduleMode">
<option value="sleep">Sleep - 循环休眠</option>
<option value="cron">Cron - 精准调度</option>
</select>
</div>
<div class="form-group">
<label>日志级别</label>
<select id="logMode">
<option value="INFO">INFO</option>
<option value="DEBUG">DEBUG</option>
<option value="NONE">关闭</option>
</select>
</div>
</div>
<div class="form-group">
<label>Cron 表达式</label>
<input type="text" id="cronExp" placeholder="0 */4 * * *" oninput="validateCron(); presetManager.highlightActive(this.value)">
<div class="help-text">格式: 分 时 日 月 周</div>
<div class="error-text" id="cronError"></div>
<div class="cron-preview" id="cronPreview"></div>
<!-- 跨模式警告容器 -->
<div id="crossModeWarning" class="cross-mode-warning" style="display:none" role="alert" aria-live="polite">
<svg class="icon" aria-hidden="true"><use href="#icon-alert-triangle"/></svg>
<div class="cross-mode-warning-content">
<div class="cross-mode-warning-title" id="crossModeWarningTitle"></div>
<div class="cross-mode-warning-message" id="crossModeWarningMessage"></div>
</div>
</div>
<!-- 性能建议容器 -->
<div id="performanceTip" class="performance-tip" style="display:none">
<svg class="icon"><use href="#icon-info-circle"/></svg>
<span id="performanceTipText"></span>
</div>
</div>
<!-- 快捷选项容器 -->
<div class="cron-presets-container" id="cronPresetsContainer">
<div class="preset-search-wrapper">
<input type="text" class="preset-search" id="presetSearch" placeholder="搜索快捷选项..." oninput="handlePresetSearch(this.value)" aria-label="搜索快捷选项">
<button type="button" class="preset-search-clear" id="presetSearchClear" onclick="clearPresetSearch()" aria-label="清空搜索" style="display:none">
<svg class="icon" style="width:14px;height:14px"><use href="#icon-close"/></svg>
</button>
</div>
<!-- 快捷选项将由 JavaScript 动态渲染 -->
</div>
<div class="form-row">
<div class="form-group">
<label>Sleep 模式心跳间隔 (秒)</label>
<input type="number" id="sleepHeartbeat" min="60" max="7200" placeholder="1800">
<div class="help-text">Sleep 模式唤醒检查周期，范围 60-7200 秒 (默认 1800)</div>
</div>
<div class="form-group">
<label>Web UI 超时时间 (秒)</label>
<input type="number" id="webuiTimeout" min="60" max="3600" placeholder="300">
<div class="help-text">无操作自动退出时间，范围 60-3600 秒 (默认 300)</div>
</div>
</div>
<div class="form-group">
<label>Web UI 心跳间隔 (秒)</label>
<input type="number" id="heartbeatSec" min="10" max="300" placeholder="30">
<div class="help-text">WebUI 守护进程心跳检测间隔，范围 10-300 秒 (默认 30)</div>
</div>
<div class="button-group">
<button type="submit" id="saveConfigBtn"><svg class="icon icon-small"><use href="#icon-save"/></svg> 保存配置</button>
<button type="button" class="secondary" id="reloadConfigBtn" onclick="loadConfig('reloadConfigBtn')"><svg class="icon icon-small"><use href="#icon-reload"/></svg> 重新加载</button>
</div>
</form>
</div>

<!-- action.sh 配置 -->
<div class="card card-accent">
<h2><svg class="icon icon-large"><use href="#icon-settings"/></svg>WebUI 启动控制</h2>
<form id="actionConfigForm">
<div class="form-group">
<label>WebUI 自动启动模式</label>
<select id="autoStartWebui">
<option value="ask">询问用户 (推荐)</option>
<option value="true">总是启动</option>
<option value="false">从不启动</option>
</select>
<div class="help-text">控制手动触发任务后是否自动启动 WebUI</div>
</div>
<div class="form-group" id="promptTimeoutGroup">
<label>音量键选择超时 (秒)</label>
<input type="number" id="webuiPromptTimeout" min="1" max="60" placeholder="10">
<div class="help-text">询问模式下等待用户按键的时间，范围 1-60 秒 (默认 10)</div>
</div>
<div class="button-group">
<button type="submit" id="saveActionConfigBtn"><svg class="icon icon-small"><use href="#icon-save"/></svg> 保存配置</button>
<button type="button" class="secondary" id="reloadActionConfigBtn" onclick="loadActionConfig('reloadActionConfigBtn')"><svg class="icon icon-small"><use href="#icon-reload"/></svg> 重新加载</button>
</div>
</form>
</div>

<!-- f2fsopt 核心配置 -->
<div class="card card-accent">
<h2><svg class="icon icon-large"><use href="#icon-database"/></svg>f2fsopt 配置</h2>
<form id="f2fsoptForm">
<div class="section-title">基础参数</div>
<div class="form-row">
<div class="form-group">
<label>GC 脏段阈值</label>
<input type="number" id="gcDirtyMin" placeholder="200">
<div class="help-text">触发 GC 的 Dirty 段数 (150-300)</div>
</div>
<div class="form-group">
<label>GC 最大时长 (秒)</label>
<input type="number" id="gcMaxSec" placeholder="500">
<div class="help-text">GC 操作超时时间 (300-600)</div>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Trim 超时 (秒)</label>
<input type="number" id="trimTimeout" placeholder="500">
<div class="help-text">Trim 操作超时时间 (300-600)</div>
</div>
<div class="form-group">
<label>GC 轮询间隔 (秒)</label>
<input type="number" id="gcPoll" placeholder="5">
<div class="help-text">GC 状态检查间隔</div>
</div>
</div>

<div class="section-title">GC 高级配置</div>
<div class="form-row">
<div class="form-group">
<label>极速 GC 睡眠 (ms)</label>
<input type="number" id="gcTurboSleep" placeholder="50">
<div class="help-text">极速模式下的 GC 间隔</div>
</div>
<div class="form-group">
<label>安全 GC 睡眠 (ms)</label>
<input type="number" id="gcSafeSleep" placeholder="500">
<div class="help-text">安全模式下的 GC 间隔</div>
</div>
</div>
<div class="form-group">
<label>GC 稳定计数</label>
<input type="number" id="gcStableCnt" placeholder="3">
<div class="help-text">连续稳定次数后切换模式</div>
</div>

<div class="section-title">智能功能开关</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">智能 GC</div>
<div class="toggle-desc">根据系统负载自动调整 GC 策略</div>
</div>
<div class="toggle" id="toggleSmartGc" onclick="toggleSwitch('smartGc')"></div>
</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">智能 Trim</div>
<div class="toggle-desc">根据存储状态智能执行 Trim</div>
</div>
<div class="toggle" id="toggleSmartTrim" onclick="toggleSwitch('smartTrim')"></div>
</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">极速 GC</div>
<div class="toggle-desc">启用高性能 GC 模式 (耗电增加)</div>
</div>
<div class="toggle" id="toggleTurboGc" onclick="toggleSwitch('turboGc')"></div>
</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">系统通知</div>
<div class="toggle-desc">任务完成后发送系统通知 (需 Android 10+)</div>
</div>
<div class="toggle" id="toggleNotifications" onclick="toggleSwitch('notifications')"></div>
</div>

<div class="section-title">运行条件</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">亮屏中断</div>
<div class="toggle-desc">屏幕点亮时暂停优化任务</div>
</div>
<div class="toggle" id="toggleStopOnScreen" onclick="toggleSwitch('stopOnScreen')"></div>
</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">仅充电运行</div>
<div class="toggle-desc">仅在充电状态下执行优化</div>
</div>
<div class="toggle" id="toggleOnlyCharging" onclick="toggleSwitch('onlyCharging')"></div>
</div>

<div class="section-title">扫描诊断</div>
<div class="toggle-group">
<div class="toggle-info">
<div class="toggle-label">扫描性能诊断</div>
<div class="toggle-desc">启用挂载点扫描耗时监控和日志输出</div>
</div>
<div class="toggle" id="toggleDebugScan" onclick="toggleSwitch('debugScan')"></div>
</div>
<div class="form-row">
<div class="form-group">
<label>慢速阈值 (ms)</label>
<input type="number" id="slowMountThreshold" min="100" max="10000" placeholder="1000">
<div class="help-text">超过此值输出信息日志 (100-10000)</div>
</div>
<div class="form-group">
<label>极慢阈值 (ms)</label>
<input type="number" id="verySlowThreshold" min="100" max="30000" placeholder="1500">
<div class="help-text">超过此值输出警告日志 (100-30000)</div>
</div>
</div>

<div class="button-group">
<button type="submit" id="saveF2fsoptBtn"><svg class="icon icon-small"><use href="#icon-save"/></svg> 保存配置</button>
<button type="button" class="secondary" id="reloadF2fsoptBtn" onclick="loadF2fsoptConfig('reloadF2fsoptBtn')"><svg class="icon icon-small"><use href="#icon-reload"/></svg> 重新加载</button>
</div>
</form>
</div>

<!-- 快捷操作 -->
<div class="card card-success">
<h2><svg class="icon icon-large"><use href="#icon-activity"/></svg>快捷操作</h2>
<div class="action-item">
<button class="success" id="runNowBtn" onclick="doAction('run_now')"><svg class="icon icon-small"><use href="#icon-play"/></svg> 立即执行</button>
<span class="action-desc">直接执行 f2fsopt 优化任务，同步等待结果返回</span>
</div>
<div class="action-item">
<button id="restartBtn" onclick="doAction('restart')"><svg class="icon icon-small"><use href="#icon-restart"/></svg> 重启服务</button>
<span class="action-desc">仅重启调度服务 (service.sh)，不执行优化任务</span>
</div>
<div class="action-item">
<button class="secondary" id="refreshStatusBtn" onclick="refreshStatus('refreshStatusBtn')"><svg class="icon icon-small"><use href="#icon-refresh"/></svg> 刷新状态</button>
<span class="action-desc">刷新服务状态和日志信息</span>
</div>
</div>

<!-- 日志查看器 -->
<div class="card">
<h2><svg class="icon icon-large"><use href="#icon-file-text"/></svg>日志查看器</h2>
<div id="logBox" class="log-box">加载中...</div>
<div class="button-group" style="margin-top:16px">
<button class="secondary" id="refreshLogBtn" onclick="refreshLog('refreshLogBtn')"><svg class="icon icon-small"><use href="#icon-refresh"/></svg> 刷新</button>
<button class="danger" onclick="clearLog()"><svg class="icon icon-small"><use href="#icon-delete"/></svg> 清空</button>
<button class="secondary" onclick="toggleAutoRefresh()" id="autoRefreshBtn"><svg class="icon icon-small"><use href="#icon-pause"/></svg> 暂停自动刷新</button>
</div>
</div>

<!-- 页脚 -->
<div style="text-align:center;padding:20px;color:var(--text-tertiary);font-size:12px">
<span id="footerText">临时 Web UI · 无操作自动退出</span>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
const API = '/cgi-bin/api.sh';
let autoRefreshInterval = null;
const toggleState = {
    smartGc: false,
    smartTrim: false,
    turboGc: false,
    notifications: false,
    stopOnScreen: false,
    onlyCharging: false,
    debugScan: false
};

// ===== Cron 快捷选项配置 =====
const CRON_PRESETS = [
    // 分钟级别 - 高频/极高频
    { group: 'minute', expr: '*/5 * * * *', label: '每5分钟', icon: 'clock', frequency: 'very-high' },
    { group: 'minute', expr: '*/10 * * * *', label: '每10分钟', icon: 'clock', frequency: 'very-high' },
    { group: 'minute', expr: '*/15 * * * *', label: '每15分钟', icon: 'clock', frequency: 'high' },
    { group: 'minute', expr: '*/30 * * * *', label: '每30分钟', icon: 'clock', frequency: 'high' },
    
    // 小时级别 - 中频/低频
    { group: 'hour', expr: '0 * * * *', label: '每小时', icon: 'clock', frequency: 'medium' },
    { group: 'hour', expr: '0 */2 * * *', label: '每2小时', icon: 'clock', frequency: 'medium' },
    { group: 'hour', expr: '0 */3 * * *', label: '每3小时', icon: 'clock', frequency: 'low', recommended: true },
    { group: 'hour', expr: '0 */4 * * *', label: '每4小时', icon: 'clock', frequency: 'low', recommended: true, default: true },
    { group: 'hour', expr: '0 */6 * * *', label: '每6小时', icon: 'clock', frequency: 'low', recommended: true },
    { group: 'hour', expr: '0 */8 * * *', label: '每8小时', icon: 'clock' },
    { group: 'hour', expr: '0 */12 * * *', label: '每12小时', icon: 'clock' },
    
    // 天级别 - 无警告
    { group: 'day', expr: '0 0 * * *', label: '每天凌晨0点', icon: 'clock' },
    { group: 'day', expr: '0 3 * * *', label: '每天凌晨3点', icon: 'clock', recommended: true },
    { group: 'day', expr: '0 12 * * *', label: '每天中午12点', icon: 'clock' },
    { group: 'day', expr: '0 21 * * *', label: '每天晚上21点', icon: 'clock' },
    
    // 周级别
    { group: 'week', expr: '0 3 * * 1', label: '每周一凌晨3点', icon: 'clock' },
    { group: 'week', expr: '0 3 * * 0', label: '每周日凌晨3点', icon: 'clock' },
    { group: 'week', expr: '0 21 * * 3', label: '每周三晚上21点', icon: 'clock' },
    
    // 月级别
    { group: 'month', expr: '0 3 1 * *', label: '每月1号凌晨3点', icon: 'clock' },
    { group: 'month', expr: '0 3 15 * *', label: '每月15号凌晨3点', icon: 'clock' }
];

const GROUP_CONFIG = {
    minute: { title: '分钟级别', icon: 'clock', order: 1 },
    hour: { title: '小时级别', icon: 'clock', order: 2 },
    day: { title: '天级别', icon: 'clock', order: 3 },
    week: { title: '周级别', icon: 'clock', order: 4 },
    month: { title: '月级别', icon: 'clock', order: 5 }
};

// ===== 频率影响级别配置 =====
const FREQUENCY_LEVELS = {
    'very-high': {
        badge: '极高频',
        color: 'var(--danger)',
        icon: 'alert-triangle',
        message: '⚠️ 极高频执行会导致显著的电池消耗、性能影响和闪存磨损',
        cssClass: 'frequency-very-high'
    },
    'high': {
        badge: '高频',
        color: 'var(--warning)',
        icon: 'alert-triangle',
        message: '💡 高频执行可能导致明显的电池消耗和性能影响',
        cssClass: 'frequency-high'
    },
    'medium': {
        badge: '中频',
        color: 'var(--warning)',
        icon: 'info-circle',
        message: 'ℹ️ 中等频率，适度的资源使用',
        cssClass: 'frequency-medium'
    },
    'low': {
        badge: '低频',
        color: 'var(--accent)',
        icon: 'check-circle',
        message: '✓ 低频执行，对系统影响最小',
        cssClass: 'frequency-low'
    }
};

// ===== 推荐标记配置 =====
const RECOMMENDATION_CONFIG = {
    badge: '推荐',
    color: 'var(--success)',
    icon: 'check-circle',
    message: '✓ 推荐频率，平衡优化效果和系统影响',
    cssClass: 'preset-recommended'
};

const CRON_FIELD_RULES = [
    { name: '分钟', min: 0, max: 59, index: 0 },
    { name: '小时', min: 0, max: 23, index: 1 },
    { name: '日期', min: 1, max: 31, index: 2 },
    { name: '月份', min: 1, max: 12, index: 3 },
    { name: '星期', min: 0, max: 7, index: 4 }
];

// 按钮状态管理器
const ButtonState = {
    IDLE: 'idle',
    LOADING: 'loading',
    DISABLED: 'disabled'
};

class ButtonManager {
    constructor() {
        this.buttons = new Map();
    }
    
    setState(buttonId, state, text = null) {
        const btn = document.getElementById(buttonId);
        if (!btn) return;
        
        if (!this.buttons.has(buttonId)) {
            this.buttons.set(buttonId, {
                originalText: btn.textContent,
                originalDisabled: btn.disabled
            });
        }
        
        const original = this.buttons.get(buttonId);
        
        switch(state) {
            case ButtonState.LOADING:
                btn.disabled = true;
                btn.classList.add('loading');
                if (text) btn.textContent = text;
                break;
                
            case ButtonState.DISABLED:
                btn.disabled = true;
                btn.classList.remove('loading');
                break;
                
            case ButtonState.IDLE:
            default:
                btn.disabled = original.originalDisabled;
                btn.classList.remove('loading');
                btn.textContent = original.originalText;
                break;
        }
    }
    
    reset(buttonId) {
        this.setState(buttonId, ButtonState.IDLE);
    }
}

const btnManager = new ButtonManager();

// ===== 快捷选项管理器 =====
class PresetManager {
    constructor() {
        this.presets = CRON_PRESETS;
        this.groups = GROUP_CONFIG;
        this.container = null;
        this.searchInput = null;
        this.activePreset = null;
    }
    
    // 渲染所有快捷选项
    renderPresets() {
        this.container = document.querySelector('.cron-presets-container');
        if (!this.container) {
            console.warn('快捷选项容器未找到');
            return;
        }
        
        // 清空容器
        this.container.innerHTML = '';
        
        // 按分组渲染
        const groupedPresets = this.groupPresets();
        const fragment = document.createDocumentFragment();
        
        // 按顺序渲染分组
        Object.keys(this.groups)
            .sort((a, b) => this.groups[a].order - this.groups[b].order)
            .forEach(groupKey => {
                const group = this.groups[groupKey];
                const presets = groupedPresets[groupKey] || [];
                
                if (presets.length === 0) return;
                
                const groupEl = this.createGroupElement(group, presets);
                fragment.appendChild(groupEl);
            });
        
        this.container.appendChild(fragment);
        
        // 使用事件委托处理点击
        this.container.addEventListener('click', (e) => {
            const presetEl = e.target.closest('.cron-preset');
            if (presetEl) {
                const expr = presetEl.dataset.expr;
                this.applyPreset(expr);
            }
        });
    }
    
    // 按分组组织快捷选项
    groupPresets() {
        const grouped = {};
        this.presets.forEach(preset => {
            if (!grouped[preset.group]) {
                grouped[preset.group] = [];
            }
            grouped[preset.group].push(preset);
        });
        return grouped;
    }
    
    // 创建分组元素
    createGroupElement(group, presets) {
        const groupEl = document.createElement('div');
        groupEl.className = 'preset-group';
        groupEl.dataset.group = group.title;
        
        // 分组标题
        const titleEl = document.createElement('div');
        titleEl.className = 'preset-group-title';
        titleEl.innerHTML = `
            <svg class="icon"><use href="#icon-${group.icon}"/></svg>
            ${group.title}
        `;
        groupEl.appendChild(titleEl);
        
        // 选项容器
        const itemsEl = document.createElement('div');
        itemsEl.className = 'preset-items';
        
        presets.forEach(preset => {
            const presetEl = this.createPresetElement(preset);
            itemsEl.appendChild(presetEl);
        });
        
        groupEl.appendChild(itemsEl);
        return groupEl;
    }
    
    // 创建快捷选项元素
    createPresetElement(preset) {
        const el = document.createElement('span');
        el.className = 'cron-preset';
        el.dataset.expr = preset.expr;
        el.dataset.group = preset.group;
        el.setAttribute('role', 'button');
        el.setAttribute('tabindex', '0');
        el.setAttribute('aria-label', `${preset.label}，Cron 表达式: ${preset.expr}`);
        
        let html = `<svg class="icon"><use href="#icon-${preset.icon}"/></svg>${preset.label}`;
        
        // 使用新的 badge 渲染逻辑：优先显示推荐，其次显示频率
        html += this.renderBadge(preset);
        
        el.innerHTML = html;
        
        // 添加键盘支持
        el.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.applyPreset(preset.expr);
            }
        });
        
        return el;
    }
    
    // 渲染 badge（推荐或频率警告）
    renderBadge(preset) {
        // 优先显示推荐标记
        if (preset.recommended) {
            return this.renderRecommendationBadge();
        }
        
        // 其次显示频率警告
        if (preset.frequency && FREQUENCY_LEVELS[preset.frequency]) {
            return this.renderFrequencyBadge(preset.frequency);
        }
        
        // 无标记
        return '';
    }
    
    // 渲染推荐标记
    renderRecommendationBadge() {
        const config = RECOMMENDATION_CONFIG;
        return `<span class="preset-badge ${config.cssClass}" 
                      style="background: ${config.color}15; color: ${config.color}"
                      aria-label="${config.message}">
                    ${config.badge}
                </span>`;
    }
    
    // 渲染频率标记
    renderFrequencyBadge(level) {
        const config = FREQUENCY_LEVELS[level];
        return `<span class="preset-badge ${config.cssClass}" 
                      style="background: ${config.color}15; color: ${config.color}"
                      aria-label="${config.message}">
                    ${config.badge}
                </span>`;
    }
    
    // 应用快捷选项
    applyPreset(expr) {
        const input = document.getElementById('cronExp');
        if (!input) return;
        
        input.value = expr;
        this.highlightActive(expr);
        
        // 触发验证和预览
        validateCron();
        
        // 显示性能建议
        this.showRecommendation(expr);
    }
    
    // 高亮匹配的快捷选项
    highlightActive(expr) {
        if (!this.container) return;
        
        // 移除所有高亮
        this.container.querySelectorAll('.cron-preset').forEach(el => {
            el.classList.remove('active');
        });
        
        // 高亮匹配的选项
        const matchingEl = this.container.querySelector(`[data-expr="${expr}"]`);
        if (matchingEl) {
            matchingEl.classList.add('active');
            this.activePreset = expr;
        } else {
            this.activePreset = null;
        }
    }
    
    // 过滤快捷选项
    filterPresets(keyword) {
        if (!this.container) return;
        
        const lowerKeyword = keyword.toLowerCase().trim();
        
        if (!lowerKeyword) {
            // 显示所有选项 - 使用 CSS 类
            this.container.querySelectorAll('.preset-group').forEach(group => {
                group.classList.remove('hidden');
            });
            this.container.querySelectorAll('.cron-preset').forEach(preset => {
                preset.classList.remove('hidden');
            });
            this.showNoResults(false, '');
            return;
        }
        
        let hasResults = false;
        
        // 遍历所有分组
        this.container.querySelectorAll('.preset-group').forEach(groupEl => {
            const groupTitle = groupEl.dataset.group.toLowerCase();
            let groupHasMatch = false;
            
            // 检查分组标题是否匹配
            const groupMatches = groupTitle.includes(lowerKeyword);
            
            // 遍历分组内的选项
            groupEl.querySelectorAll('.cron-preset').forEach(presetEl => {
                const label = presetEl.textContent.toLowerCase();
                const matches = groupMatches || label.includes(lowerKeyword);
                
                // 使用 CSS 类控制显示/隐藏
                if (matches) {
                    presetEl.classList.remove('hidden');
                    groupHasMatch = true;
                    hasResults = true;
                } else {
                    presetEl.classList.add('hidden');
                }
            });
            
            // 使用 CSS 类控制分组显示/隐藏
            if (groupHasMatch) {
                groupEl.classList.remove('hidden');
            } else {
                groupEl.classList.add('hidden');
            }
        });
        
        // 显示/隐藏无结果提示
        this.showNoResults(!hasResults, lowerKeyword);
    }
    
    // 显示无结果提示
    showNoResults(show, keyword) {
        let noResultsEl = this.container.querySelector('.preset-no-results');
        
        if (show) {
            if (!noResultsEl) {
                noResultsEl = document.createElement('div');
                noResultsEl.className = 'preset-no-results';
                this.container.appendChild(noResultsEl);
            }
            noResultsEl.innerHTML = `
                <svg class="icon" style="width:48px;height:48px;opacity:0.3"><use href="#icon-info-circle"/></svg>
                <div style="margin-top:12px;font-size:14px;color:var(--text-secondary)">无匹配选项: "${keyword}"</div>
                <div style="margin-top:8px;font-size:12px;color:var(--text-tertiary)">提示: 快捷选项最小间隔为每 5 分钟</div>
                <div style="margin-top:4px;font-size:12px;color:var(--text-tertiary)">建议: 尝试搜索"分钟"、"小时"或"天"</div>
            `;
            noResultsEl.style.display = 'flex';
        } else if (noResultsEl) {
            noResultsEl.style.display = 'none';
        }
    }
    
    // 显示性能建议
    showRecommendation(expr) {
        const preset = this.presets.find(p => p.expr === expr);
        const tipEl = document.getElementById('performanceTip');
        const tipTextEl = document.getElementById('performanceTipText');
        
        if (!tipEl || !tipTextEl) return;
        
        // 优先显示推荐信息
        if (preset && preset.recommended) {
            const config = RECOMMENDATION_CONFIG;
            tipTextEl.textContent = config.message;
            tipEl.className = 'performance-tip low';
            tipEl.style.display = 'flex';
            
            const iconEl = tipEl.querySelector('.icon use');
            if (iconEl) {
                iconEl.setAttribute('href', '#icon-' + config.icon);
            }
            return;
        }
        
        // 其次显示频率警告
        if (preset && preset.frequency) {
            const level = FREQUENCY_LEVELS[preset.frequency];
            if (!level) {
                tipEl.style.display = 'none';
                return;
            }
            
            tipTextEl.textContent = level.message;
            tipEl.className = 'performance-tip ' + preset.frequency;
            tipEl.style.display = 'flex';
            
            const iconEl = tipEl.querySelector('.icon use');
            if (iconEl) {
                iconEl.setAttribute('href', '#icon-' + level.icon);
            }
            return;
        }
        
        // 无提示
        tipEl.style.display = 'none';
    }
}

const presetManager = new PresetManager();

// 搜索防抖处理
let searchDebounceTimer = null;
function handlePresetSearch(keyword) {
    if (searchDebounceTimer) {
        clearTimeout(searchDebounceTimer);
    }
    
    // 显示/隐藏清空按钮
    const clearBtn = document.getElementById('presetSearchClear');
    if (clearBtn) {
        clearBtn.style.display = keyword.trim() ? 'flex' : 'none';
    }
    
    searchDebounceTimer = setTimeout(() => {
        presetManager.filterPresets(keyword);
    }, 300);
}

// 清空搜索
function clearPresetSearch() {
    const searchInput = document.getElementById('presetSearch');
    const clearBtn = document.getElementById('presetSearchClear');
    
    if (searchInput) {
        searchInput.value = '';
        searchInput.focus();
    }
    
    if (clearBtn) {
        clearBtn.style.display = 'none';
    }
    
    // 显示所有选项
    presetManager.filterPresets('');
}

// 搜索框键盘事件处理
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('presetSearch');
    if (searchInput) {
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                clearPresetSearch();
            }
        });
    }
});

// ===== 跨模式验证器 =====
class CrossModeValidator {
    constructor() {
        this.scheduleMode = null;
        this.cronExpInput = null;
        this.sleepHeartbeatInput = null;
    }
    
    init() {
        this.scheduleMode = document.getElementById('scheduleMode');
        this.cronExpInput = document.getElementById('cronExp');
        this.sleepHeartbeatInput = document.getElementById('sleepHeartbeat');
        
        // 监听模式切换
        if (this.scheduleMode) {
            this.scheduleMode.addEventListener('change', () => {
                this.updateFieldStates(this.scheduleMode.value);
            });
        }
    }
    
    // 验证模式配置
    validateMode(mode, cronExp, sleepHeartbeat) {
        const result = {
            valid: true,
            warnings: [],
            errors: []
        };
        
        if (mode === 'sleep') {
            // Sleep 模式下检查 Cron 表达式
            if (cronExp && cronExp.trim() !== '') {
                result.warnings.push({
                    type: 'unused_cron',
                    message: 'Sleep 模式下 Cron 表达式将被忽略',
                    suggestion: '建议清空 Cron 表达式或切换到 Cron 模式'
                });
            }
            
            // 检查心跳间隔
            if (!sleepHeartbeat || sleepHeartbeat.trim() === '') {
                result.errors.push({
                    type: 'missing_heartbeat',
                    message: 'Sleep 模式需要设置心跳间隔',
                    suggestion: '请设置 60-7200 秒之间的心跳间隔'
                });
                result.valid = false;
            }
        } else if (mode === 'cron') {
            // Cron 模式下检查 Cron 表达式
            if (!cronExp || cronExp.trim() === '') {
                result.errors.push({
                    type: 'missing_cron',
                    message: 'Cron 模式需要设置 Cron 表达式',
                    suggestion: '请输入有效的 Cron 表达式或使用快捷选项'
                });
                result.valid = false;
            }
        }
        
        return result;
    }
    
    // 更新字段启用/禁用状态
    updateFieldStates(mode) {
        if (!this.cronExpInput || !this.sleepHeartbeatInput) return;
        
        const presetsContainer = document.getElementById('cronPresetsContainer');
        const cronPreview = document.getElementById('cronPreview');
        const crossModeWarning = document.getElementById('crossModeWarning');
        
        if (mode === 'sleep') {
            // Sleep 模式: 禁用 Cron 表达式，启用心跳间隔
            this.cronExpInput.disabled = true;
            this.cronExpInput.style.opacity = '0.5';
            this.cronExpInput.style.cursor = 'not-allowed';
            this.cronExpInput.setAttribute('aria-disabled', 'true');
            
            this.sleepHeartbeatInput.disabled = false;
            this.sleepHeartbeatInput.style.opacity = '1';
            this.sleepHeartbeatInput.style.cursor = 'text';
            this.sleepHeartbeatInput.removeAttribute('aria-disabled');
            
            // 隐藏 Cron 快捷选项容器
            if (presetsContainer) {
                presetsContainer.style.display = 'none';
                presetsContainer.setAttribute('aria-hidden', 'true');
            }
            
            // 隐藏 Cron 预览
            if (cronPreview) {
                cronPreview.classList.remove('show');
            }
            
            // 检查是否有 Cron 表达式，显示警告
            if (this.cronExpInput.value && this.cronExpInput.value.trim() !== '') {
                this.showCrossModeWarning(
                    'Sleep 模式下 Cron 表达式将被忽略',
                    '当前配置的 Cron 表达式不会生效。建议清空 Cron 表达式或切换到 Cron 模式。',
                    'warning'
                );
            } else {
                this.hideCrossModeWarning();
            }
            
        } else if (mode === 'cron') {
            // Cron 模式: 启用 Cron 表达式，心跳间隔可选
            this.cronExpInput.disabled = false;
            this.cronExpInput.style.opacity = '1';
            this.cronExpInput.style.cursor = 'text';
            this.cronExpInput.removeAttribute('aria-disabled');
            
            this.sleepHeartbeatInput.disabled = false;
            this.sleepHeartbeatInput.style.opacity = '1';
            this.sleepHeartbeatInput.style.cursor = 'text';
            this.sleepHeartbeatInput.removeAttribute('aria-disabled');
            
            // 显示 Cron 快捷选项容器
            if (presetsContainer) {
                presetsContainer.style.display = 'block';
                presetsContainer.removeAttribute('aria-hidden');
            }
            
            // 检查是否缺少 Cron 表达式，显示错误
            if (!this.cronExpInput.value || this.cronExpInput.value.trim() === '') {
                this.showCrossModeWarning(
                    'Cron 模式需要配置 Cron 表达式',
                    '请输入有效的 Cron 表达式或使用下方的快捷选项。',
                    'error'
                );
            } else {
                this.hideCrossModeWarning();
            }
            
            // 触发验证
            validateCron();
        }
    }
    
    // 显示跨模式警告
    showCrossModeWarning(title, message, type = 'warning') {
        const warningEl = document.getElementById('crossModeWarning');
        const titleEl = document.getElementById('crossModeWarningTitle');
        const messageEl = document.getElementById('crossModeWarningMessage');
        
        if (!warningEl || !titleEl || !messageEl) return;
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        
        warningEl.classList.remove('warning', 'error');
        warningEl.classList.add(type);
        warningEl.style.display = 'flex';
    }
    
    // 隐藏跨模式警告
    hideCrossModeWarning() {
        const warningEl = document.getElementById('crossModeWarning');
        if (warningEl) {
            warningEl.style.display = 'none';
        }
    }
}

const crossModeValidator = new CrossModeValidator();

// ===== 配置建议引擎 =====
class ConfigAdvisor {
    constructor() {
        this.frequencyLevels = FREQUENCY_LEVELS;
        this.recommendationConfig = RECOMMENDATION_CONFIG;
    }
    
    // 获取频率级别
    getFrequencyLevel(expr) {
        if (!expr || expr.trim() === '') return null;
        
        const parts = expr.split(/\s+/);
        if (parts.length !== 5) return null;
        
        const [min, hour, day, month, week] = parts;
        
        // 极高频 (< 15分钟)
        if (min.startsWith('*/')) {
            const interval = parseInt(min.slice(2));
            if (interval < 15) return 'very-high';
            if (interval <= 30) return 'high';
        }
        
        // 高频 (每小时)
        if (hour === '*' || (hour.startsWith('*/') && parseInt(hour.slice(2)) === 1)) {
            return 'medium';
        }
        
        // 中频 (每2-3小时)
        if (hour.startsWith('*/')) {
            const interval = parseInt(hour.slice(2));
            if (interval <= 3) return 'medium';
            if (interval <= 12) return 'low';
        }
        
        // 天级别及以上 - 无警告
        return null;
    }
    
    // 获取配置建议
    getRecommendation(expr) {
        const level = this.getFrequencyLevel(expr);
        if (!level) return null;
        
        const config = this.frequencyLevels[level];
        if (!config) return null;
        
        return {
            level: level,
            message: config.message,
            icon: config.icon,
            color: config.color
        };
    }
    
    // 显示性能警告
    showPerformanceWarning(level) {
        if (!level || !this.frequencyLevels[level]) return;
        
        const config = this.frequencyLevels[level];
        showToast(config.message, level === 'very-high' || level === 'high', 5000);
    }
    
    // 分析配置并提供建议
    analyzeConfig(mode, cronExp, sleepHeartbeat) {
        const recommendations = [];
        
        if (mode === 'cron' && cronExp) {
            const level = this.getWarningLevel(cronExp);
            if (level === 'high') {
                recommendations.push({
                    type: 'performance',
                    severity: 'warning',
                    message: '当前 Cron 表达式执行频率较高',
                    suggestion: '建议降低执行频率以减少电池消耗，推荐每 4-6 小时执行一次'
                });
            }
        }
        
        if (mode === 'sleep' && sleepHeartbeat) {
            const heartbeat = parseInt(sleepHeartbeat);
            if (!isNaN(heartbeat) && heartbeat < 300) {
                recommendations.push({
                    type: 'performance',
                    severity: 'info',
                    message: 'Sleep 心跳间隔较短',
                    suggestion: '较短的心跳间隔会增加电池消耗，建议设置为 1800 秒(30分钟)或更长'
                });
            }
        }
        
        return recommendations;
    }
}

const configAdvisor = new ConfigAdvisor();

function showToast(msg, isError = false, duration = 3000) {
    const t = document.getElementById('toast');
    
    // 检测消息是否已包含图标前缀 (✓ 或 ✗ 或 ⚠️ 或 ⊗)
    const hasIconPrefix = /^[✓✗⚠️⊗]\s/.test(msg);
    
    let displayMsg = msg;
    let iconSvg = '';
    
    if (hasIconPrefix) {
        // 消息已包含图标,提取并移除前缀
        const iconChar = msg.charAt(0);
        displayMsg = msg.substring(2); // 移除图标和空格
        
        // 根据图标字符选择 SVG
        if (iconChar === '✓') {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--success)"><use href="#icon-check-circle"/></svg>';
        } else if (iconChar === '✗') {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--danger)"><use href="#icon-x-circle"/></svg>';
        } else if (iconChar === '⚠️') {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--warning)"><use href="#icon-alert-triangle"/></svg>';
        } else if (iconChar === '⊗') {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--warning)"><use href="#icon-cancel"/></svg>';
        }
    } else {
        // 消息不包含图标,根据类型添加
        if (isError) {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--danger)"><use href="#icon-x-circle"/></svg>';
        } else {
            iconSvg = '<svg class="icon" style="width:18px;height:18px;stroke:var(--success)"><use href="#icon-check-circle"/></svg>';
        }
    }
    
    t.innerHTML = '<span class="toast-icon">' + iconSvg + '</span>' + displayMsg;
    t.className = 'toast show ' + (isError ? 'error' : 'success');
    
    // 清除之前的定时器
    if (t.hideTimer) clearTimeout(t.hideTimer);
    
    // 设置新的定时器
    t.hideTimer = setTimeout(() => {
        t.classList.remove('show');
    }, duration);
    
    // 点击关闭
    t.onclick = () => {
        t.classList.remove('show');
        if (t.hideTimer) clearTimeout(t.hideTimer);
    };
}

async function apiGet(route) {
    try {
        const r = await fetch(API + '?' + route);
        if (!r.ok) {
            throw new Error('HTTP ' + r.status + ': ' + r.statusText);
        }
        const data = await r.json();
        
        // 只检查明确的错误响应
        if (data.error) {
            throw new Error(data.error);
        }
        
        return data;
    } catch (error) {
        if (error.name === 'TypeError') {
            throw new Error('网络连接失败，请检查服务是否运行');
        }
        throw error;
    }
}

async function apiPost(route, data) {
    try {
        const r = await fetch(API + '?' + route, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });
        if (!r.ok) {
            throw new Error('HTTP ' + r.status + ': ' + r.statusText);
        }
        const responseData = await r.json();
        
        // 只检查明确的错误响应
        if (responseData.error) {
            throw new Error(responseData.error);
        }
        
        return responseData;
    } catch (error) {
        if (error.name === 'TypeError') {
            throw new Error('网络连接失败，请检查服务是否运行');
        }
        throw error;
    }
}

async function withFeedback(apiCall, buttonId = null, loadingText = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, loadingText);
        }
        
        const response = await apiCall();
        
        if (response.success) {
            showToast('✓ ' + response.message, false);
            
            // 保存配置后刷新状态
            if (buttonId && (buttonId === 'saveConfigBtn' || buttonId === 'saveF2fsoptConfigBtn' || buttonId === 'saveActionConfigBtn')) {
                setTimeout(() => refreshStatus(), 500);
            }
        } else {
            showToast('✗ ' + response.message, true);
        }
        
        return response;
        
    } catch (error) {
        showToast('✗ 操作失败: ' + error.message, true);
        throw error;
        
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

function toggleSwitch(name) {
    toggleState[name] = !toggleState[name];
    updateToggleUI(name);
}

function updateToggleUI(name) {
    const el = document.getElementById('toggle' + name.charAt(0).toUpperCase() + name.slice(1));
    if (el) {
        if (toggleState[name]) {
            el.classList.add('active');
        } else {
            el.classList.remove('active');
        }
    }
}

function setToggle(name, value) {
    toggleState[name] = (value === 'true' || value === true);
    updateToggleUI(name);
}

// Cron 表达式验证
function validateCron() {
    const input = document.getElementById('cronExp');
    const error = document.getElementById('cronError');
    const preview = document.getElementById('cronPreview');
    const exp = input.value.trim();
    
    if (!exp) {
        input.classList.remove('error');
        error.classList.remove('show');
        preview.classList.remove('show');
        return true;
    }
    
    const parts = exp.split(/\s+/);
    if (parts.length !== 5) {
        input.classList.add('error');
        error.textContent = '格式错误: 需要 5 个字段 (分 时 日 月 周)';
        error.classList.add('show');
        preview.classList.remove('show');
        return false;
    }
    
    // 使用增强的字段验证
    for (let i = 0; i < 5; i++) {
        const result = validateCronField(parts[i], CRON_FIELD_RULES[i]);
        if (!result.valid) {
            input.classList.add('error');
            error.textContent = `${CRON_FIELD_RULES[i].name}字段错误: ${result.error}`;
            error.classList.add('show');
            preview.classList.remove('show');
            return false;
        }
    }
    
    input.classList.remove('error');
    error.classList.remove('show');
    
    // 显示预览
    const previewText = getCronDescription(parts);
    if (previewText) {
        preview.textContent = '⏰ ' + previewText;
        preview.classList.add('show');
    }
    return true;
}

// 验证单个 Cron 字段
function validateCronField(value, rule) {
    // 1. 通配符
    if (value === '*') {
        return { valid: true };
    }
    
    // 2. 步长表达式 */n
    if (/^\*\/\d+$/.test(value)) {
        const step = parseInt(value.slice(2));
        if (step <= 0) {
            return { valid: false, error: '步长必须为正整数' };
        }
        if (step > rule.max) {
            return { valid: false, error: `步长不能超过 ${rule.max}` };
        }
        return { valid: true };
    }
    
    // 3. 范围表达式 n-m
    if (/^\d+-\d+$/.test(value)) {
        const [start, end] = value.split('-').map(Number);
        if (start < rule.min || start > rule.max) {
            return { valid: false, error: `起始值必须在 ${rule.min}-${rule.max} 范围内` };
        }
        if (end < rule.min || end > rule.max) {
            return { valid: false, error: `结束值必须在 ${rule.min}-${rule.max} 范围内` };
        }
        if (start >= end) {
            return { valid: false, error: '起始值必须小于结束值' };
        }
        return { valid: true };
    }
    
    // 4. 列表表达式 n,m,o
    if (/^\d+(,\d+)*$/.test(value)) {
        const values = value.split(',').map(Number);
        for (const v of values) {
            if (v < rule.min || v > rule.max) {
                return { valid: false, error: `值 ${v} 超出 ${rule.min}-${rule.max} 范围` };
            }
        }
        return { valid: true };
    }
    
    // 5. 单个数值
    if (/^\d+$/.test(value)) {
        const num = parseInt(value);
        if (num < rule.min || num > rule.max) {
            return { valid: false, error: `值必须在 ${rule.min}-${rule.max} 范围内` };
        }
        return { valid: true };
    }
    
    return { valid: false, error: '格式错误，应为数字、*、*/n、n-m 或 n,m,o' };
}

function getCronDescription(parts) {
    const [min, hour, day, month, week] = parts;
    let desc = '';
    
    // 每分钟执行
    if (min === '*' && hour === '*' && day === '*' && month === '*' && week === '*') {
        desc = '每分钟执行';
    }
    // 每 N 分钟执行
    else if (min.startsWith('*/') && hour === '*' && day === '*' && month === '*' && week === '*') {
        const interval = min.slice(2);
        desc = '每 ' + interval + ' 分钟执行';
    }
    // 每小时执行
    else if (min === '0' && hour === '*' && day === '*' && month === '*' && week === '*') {
        desc = '每小时执行';
    }
    // 每 N 小时执行
    else if (min === '0' && hour.startsWith('*/')) {
        const interval = hour.slice(2);
        desc = '每 ' + interval + ' 小时执行';
    }
    // 每天特定时间执行
    else if (/^\d+$/.test(min) && /^\d+$/.test(hour) && day === '*' && month === '*' && week === '*') {
        const h = hour.padStart(2, '0');
        const m = min.padStart(2, '0');
        desc = '每天 ' + h + ':' + m + ' 执行';
    }
    // 每周特定时间执行
    else if (/^\d+$/.test(min) && /^\d+$/.test(hour) && day === '*' && month === '*' && /^\d+$/.test(week)) {
        const weekNames = ['日', '一', '二', '三', '四', '五', '六', '日'];
        const h = hour.padStart(2, '0');
        const m = min.padStart(2, '0');
        desc = '每周' + weekNames[parseInt(week)] + ' ' + h + ':' + m + ' 执行';
    }
    // 每月特定日期执行
    else if (/^\d+$/.test(min) && /^\d+$/.test(hour) && /^\d+$/.test(day) && month === '*' && week === '*') {
        const h = hour.padStart(2, '0');
        const m = min.padStart(2, '0');
        desc = '每月 ' + day + ' 号 ' + h + ':' + m + ' 执行';
    }
    // 范围表达式
    else if (min.includes('-') || hour.includes('-')) {
        desc = '按指定范围执行';
    }
    // 列表表达式
    else if (min.includes(',') || hour.includes(',')) {
        desc = '按指定列表执行';
    }
    // 复杂表达式
    else {
        desc = '自定义调度 (查看表达式详情)';
    }
    
    return desc;
}

function setCron(exp) {
    document.getElementById('cronExp').value = exp;
    validateCron();
}

async function loadConfig(buttonId = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, '加载中...');
        }
        
        const d = await apiGet('/api/config');
        document.getElementById('scheduleMode').value = d.schedule_mode || 'sleep';
        document.getElementById('cronExp').value = d.cron_exp || '';
        document.getElementById('logMode').value = d.log_mode || 'INFO';
        document.getElementById('sleepHeartbeat').value = d.sleep_heartbeat || '1800';
        document.getElementById('webuiTimeout').value = d.webui_timeout || '300';
        document.getElementById('heartbeatSec').value = d.heartbeat_sec || '30';
        
        // 更新页脚超时提示 - 增强容错处理
        const footerText = document.getElementById('footerText');
        if (footerText) {
            // 确保获取有效的超时值
            let timeoutSec = 300; // 默认 5 分钟
            if (d.webui_timeout) {
                const parsed = parseInt(d.webui_timeout, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    timeoutSec = parsed;
                }
            }
            const timeoutMin = Math.floor(timeoutSec / 60);
            footerText.textContent = `临时 Web UI · ${timeoutMin}分钟无操作自动退出`;
        }
        
        // 更新跨模式验证器状态
        crossModeValidator.updateFieldStates(d.schedule_mode || 'sleep');
        
        // 高亮匹配的快捷选项
        if (d.cron_exp) {
            presetManager.highlightActive(d.cron_exp);
            validateCron();
        }
        
        if (buttonId) {
            showToast('✓ 配置已重新加载', false);
        }
    } catch(e) {
        showToast('✗ 加载配置失败: ' + e.message, true);
        // 加载失败时使用默认值更新页脚
        const footerText = document.getElementById('footerText');
        if (footerText) {
            footerText.textContent = '临时 Web UI · 5分钟无操作自动退出';
        }
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

async function loadActionConfig(buttonId = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, '加载中...');
        }
        
        const d = await apiGet('/api/action_config');
        document.getElementById('autoStartWebui').value = d.auto_start_webui || 'ask';
        document.getElementById('webuiPromptTimeout').value = d.webui_prompt_timeout || '10';
        updatePromptTimeoutVisibility();
        
        if (buttonId) {
            showToast('✓ 配置已重新加载', false);
        }
    } catch(e) {
        showToast('✗ 加载 action.sh 配置失败: ' + e.message, true);
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

function updatePromptTimeoutVisibility() {
    const mode = document.getElementById('autoStartWebui').value;
    const group = document.getElementById('promptTimeoutGroup');
    const input = document.getElementById('webuiPromptTimeout');
    
    if (!group || !input) return;
    
    if (mode === 'ask') {
        group.style.display = 'block';
        group.style.opacity = '1';
        input.disabled = false;
    } else {
        group.style.display = 'block';
        group.style.opacity = '0.5';
        input.disabled = true;
    }
}

async function loadF2fsoptConfig(buttonId = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, '加载中...');
        }
        
        const d = await apiGet('/api/f2fsopt_config');
        document.getElementById('gcDirtyMin').value = d.gc_dirty_min || '200';
        document.getElementById('trimTimeout').value = d.trim_timeout || '500';
        document.getElementById('gcMaxSec').value = d.gc_max_sec || '500';
        document.getElementById('gcTurboSleep').value = d.gc_turbo_sleep || '50';
        document.getElementById('gcSafeSleep').value = d.gc_safe_sleep || '500';
        document.getElementById('gcStableCnt').value = d.gc_stable_cnt || '3';
        document.getElementById('gcPoll').value = d.gc_poll || '5';
        setToggle('smartGc', d.enable_smart_gc);
        setToggle('smartTrim', d.enable_smart_trim);
        setToggle('turboGc', d.enable_turbo_gc);
        setToggle('notifications', d.enable_notifications);
        setToggle('stopOnScreen', d.stop_on_screen);
        setToggle('onlyCharging', d.only_charging);
        // 扫描诊断配置
        setToggle('debugScan', d.debug_scan === '1' || d.debug_scan === 1);
        document.getElementById('slowMountThreshold').value = d.slow_mount_threshold || '1000';
        document.getElementById('verySlowThreshold').value = d.very_slow_threshold || '1500';
        
        if (buttonId) {
            showToast('✓ 配置已重新加载', false);
        }
    } catch(e) {
        showToast('✗ 加载 f2fsopt 配置失败: ' + e.message, true);
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

async function refreshStatus(buttonId = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, '刷新中...');
        }
        
        const d = await apiGet('/api/status');
        const status = d.service_status || '未知';
        document.getElementById('serviceStatus').textContent = status;
        document.getElementById('lastRun').textContent = d.last_run || '未知';
        document.getElementById('logSize').textContent = d.log_size || '0 KB';
        const badge = document.getElementById('statusBadge');
        if (status.indexOf('运行中') >= 0) {
            badge.innerHTML = '<svg class="icon"><use href="#icon-activity"/></svg>运行中';
            badge.className = 'status-badge running';
        } else {
            badge.innerHTML = '<svg class="icon"><use href="#icon-circle"/></svg>已停止';
            badge.className = 'status-badge stopped';
        }
        
        // 更新下次执行时间（从 api/status 响应）
        const nextRunEl = document.getElementById('nextRun');
        if (d.next_run_ts && d.next_run_ts > 0) {
            const nextRunDate = new Date(d.next_run_ts * 1000);
            const now = new Date();
            const diffMs = nextRunDate - now;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 0) {
                nextRunEl.textContent = '即将执行';
            } else if (diffMins < 60) {
                nextRunEl.textContent = '约 ' + diffMins + ' 分钟后';
            } else {
                const diffHours = Math.floor(diffMins / 60);
                nextRunEl.textContent = '约 ' + diffHours + ' 小时后';
            }
            
            // 添加详细时间提示
            const timeStr = nextRunDate.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            nextRunEl.title = '预计时间: ' + timeStr;
        } else {
            nextRunEl.textContent = '未知';
            nextRunEl.title = '';
        }
        
        // 更新配置状态
        const configStatusEl = document.getElementById('configStatus');
        if (d.pending_changes === true || d.pending_changes === 'true') {
            configStatusEl.innerHTML = '<svg class="icon" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;stroke:var(--warning)"><use href="#icon-alert-triangle"/></svg>待生效';
            configStatusEl.style.color = 'var(--warning)';
            
            // 显示待生效提示
            const alertBox = document.getElementById('pendingChangesAlert');
            const alertMessage = document.getElementById('pendingChangesMessage');
            
            const diffMins = Math.floor((d.next_run_ts * 1000 - Date.now()) / 60000);
            let message = '配置已修改，';
            
            if (diffMins > 0) {
                message += '将在 ' + diffMins + ' 分钟后自动生效。';
                
                if (diffMins < 5) {
                    message += '\n💡 建议：等待时间较短，可以等待自动生效。';
                } else if (diffMins > 30) {
                    message += '\n💡 建议：等待时间较长，建议立即应用配置。';
                } else {
                    message += '\n💡 提示：您可以立即应用配置或等待自动生效。';
                }
            } else {
                message += '将在下次调度时生效。';
            }
            
            alertMessage.textContent = message;
            alertMessage.style.whiteSpace = 'pre-line';
            alertBox.style.display = 'flex';
        } else {
            configStatusEl.innerHTML = '<svg class="icon" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;stroke:var(--success)"><use href="#icon-check-circle"/></svg>已同步';
            configStatusEl.style.color = 'var(--success)';
            
            // 隐藏待生效提示
            const alertBox = document.getElementById('pendingChangesAlert');
            alertBox.style.display = 'none';
        }
        
        if (buttonId) {
            showToast('✓ 状态已刷新', false);
        }
    } catch(e) {
        showToast('✗ 状态刷新失败: ' + e.message, true);
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

// 刷新配置状态（已废弃，保留用于兼容性）
async function refreshConfigStatus() {
    // 此函数已合并到 refreshStatus 中
    // 保留空函数以避免破坏现有调用
}

// 触发立即执行
// 全局变量保存当前执行 ID
let currentExecutionId = null;

// 触发立即执行
async function triggerImmediateExecution() {
    try {
        // 显示执行进度模态框
        showExecutionModal();
        
        // 触发立即执行
        const response = await apiGet('/api/trigger_immediate');
        
        if (!response.success) {
            throw new Error(response.message || '触发失败');
        }
        
        // 保存执行 ID
        currentExecutionId = response.execution_id;
        
        // 轮询执行状态
        await pollExecutionStatus(response.execution_id);
        
        // 清除执行 ID
        currentExecutionId = null;
        
    } catch(e) {
        showToast('✗ 立即执行失败: ' + e.message, true);
        hideExecutionModal();
        currentExecutionId = null;
        
        // 在控制台输出详细错误信息
        console.error('立即执行失败:', e);
    }
}

// 取消执行
async function cancelExecution() {
    if (!currentExecutionId) {
        showToast('⚠️ 没有正在执行的任务', true);
        return;
    }
    
    try {
        const cancelBtn = document.getElementById('cancelExecutionBtn');
        if (cancelBtn) {
            cancelBtn.disabled = true;
            cancelBtn.textContent = '取消中...';
        }
        
        const response = await apiGet('/api/cancel_execution?id=' + currentExecutionId);
        
        if (response.success) {
            showToast('✓ 已取消执行', false);
        } else {
            showToast('✗ 取消失败: ' + (response.message || '未知错误'), true);
            
            // 重新启用取消按钮
            if (cancelBtn) {
                cancelBtn.disabled = false;
                cancelBtn.textContent = '取消';
            }
        }
        
    } catch(e) {
        showToast('✗ 取消失败: ' + e.message, true);
        console.error('取消执行失败:', e);
        
        // 重新启用取消按钮
        const cancelBtn = document.getElementById('cancelExecutionBtn');
        if (cancelBtn) {
            cancelBtn.disabled = false;
            cancelBtn.textContent = '取消';
        }
    }
}

// 显示执行进度模态框
function showExecutionModal() {
    const modal = document.createElement('div');
    modal.id = 'executionModal';
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">执行进度</div>
                <button class="modal-close" onclick="hideExecutionModal()"><svg class="icon icon-small"><use href="#icon-close"/></svg></button>
            </div>
            <div class="execution-status">
                <div class="status-spinner"></div>
                <div class="status-text">正在执行...</div>
            </div>
            <div class="execution-log" id="executionLog">等待日志输出...</div>
            <div class="button-group" style="margin-top:16px;justify-content:flex-end">
                <button class="secondary" id="cancelExecutionBtn" onclick="cancelExecution()"><svg class="icon icon-small"><use href="#icon-cancel"/></svg> 取消</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

// 隐藏执行进度模态框
function hideExecutionModal() {
    const modal = document.getElementById('executionModal');
    if (modal) {
        modal.remove();
    }
}

// 轮询执行状态
async function pollExecutionStatus(executionId) {
    const maxAttempts = 120; // 最多轮询 2 分钟
    let attempts = 0;
    
    while (attempts < maxAttempts) {
        try {
            const response = await apiGet('/api/execution_status?id=' + executionId);
            
            // 更新日志
            const logEl = document.getElementById('executionLog');
            if (logEl && response.log_tail && response.log_tail.length > 0) {
                logEl.textContent = response.log_tail.join('\n');
                logEl.scrollTop = logEl.scrollHeight;
            }
            
            // 检查状态
            if (response.status === 'completed') {
                // 执行完成
                const statusEl = document.querySelector('.execution-status');
                if (statusEl) {
                    const duration = response.duration || 0;
                    statusEl.innerHTML = `
                        <svg class="icon icon-medium" style="stroke:var(--success)"><use href="#icon-check-circle"/></svg>
                        <div class="status-text" style="color:var(--success)">执行完成 (耗时: ${duration}秒)</div>
                    `;
                }
                
                // 更新取消按钮为关闭按钮
                const cancelBtn = document.getElementById('cancelExecutionBtn');
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '<svg class="icon icon-small"><use href="#icon-close"/></svg> 关闭';
                    cancelBtn.onclick = hideExecutionModal;
                }
                
                showToast('✓ 配置已应用', false);
                
                // 刷新状态
                refreshStatus();
                
                return;
                
            } else if (response.status === 'failed') {
                // 执行失败
                const statusEl = document.querySelector('.execution-status');
                if (statusEl) {
                    const exitCode = response.exit_code || 0;
                    const duration = response.duration || 0;
                    statusEl.innerHTML = `
                        <svg class="icon icon-medium" style="stroke:var(--danger)"><use href="#icon-x-circle"/></svg>
                        <div class="status-text" style="color:var(--danger)">执行失败 (退出码: ${exitCode}, 耗时: ${duration}秒)</div>
                    `;
                }
                
                // 更新取消按钮为关闭按钮
                const cancelBtn = document.getElementById('cancelExecutionBtn');
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '<svg class="icon icon-small"><use href="#icon-close"/></svg> 关闭';
                    cancelBtn.onclick = hideExecutionModal;
                }
                
                showToast('✗ 执行失败，请查看日志', true);
                return;
                
            } else if (response.status === 'cancelled') {
                // 已取消
                const statusEl = document.querySelector('.execution-status');
                if (statusEl) {
                    statusEl.innerHTML = `
                        <svg class="icon icon-medium" style="stroke:var(--warning)"><use href="#icon-cancel"/></svg>
                        <div class="status-text" style="color:var(--warning)">已取消</div>
                    `;
                }
                
                // 更新取消按钮为关闭按钮
                const cancelBtn = document.getElementById('cancelExecutionBtn');
                if (cancelBtn) {
                    cancelBtn.disabled = false;
                    cancelBtn.innerHTML = '<svg class="icon icon-small"><use href="#icon-close"/></svg> 关闭';
                    cancelBtn.onclick = hideExecutionModal;
                }
                
                showToast('⊗ 执行已取消', false);
                return;
            }
            
            // 继续轮询
            await new Promise(resolve => setTimeout(resolve, 1000));
            attempts++;
            
        } catch(e) {
            console.error('轮询执行状态失败:', e);
            attempts++;
            await new Promise(resolve => setTimeout(resolve, 1000));
        }
    }
    
    // 超时
    showToast('⚠️ 执行超时，请手动检查日志', true);
    
    // 禁用取消按钮
    const cancelBtn = document.getElementById('cancelExecutionBtn');
    if (cancelBtn) {
        cancelBtn.disabled = true;
        cancelBtn.textContent = '超时';
    }
}

// 日志格式化和高亮
function formatLog(logText) {
    if (!logText) return '';
    
    return logText.split('\n').map(line => {
        // 匹配时间戳 (YYYY-MM-DD HH:MM:SS)
        line = line.replace(
            /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})/g,
            '<span class="log-timestamp">$1</span>'
        );
        
        // 匹配日志级别
        if (line.includes(' I ')) {
            line = line.replace(' I ', ' <span class="log-level-info">I</span> ');
        } else if (line.includes(' W ')) {
            line = line.replace(' W ', ' <span class="log-level-warn">W</span> ');
        } else if (line.includes(' E ')) {
            line = line.replace(' E ', ' <span class="log-level-error">E</span> ');
        }
        
        // 匹配成功标记
        line = line.replace(/✓/g, '<span class="log-success">✓</span>');
        
        return line;
    }).join('\n');
}

async function refreshLog(buttonId = null) {
    try {
        if (buttonId) {
            btnManager.setState(buttonId, ButtonState.LOADING, '刷新中...');
        }
        
        const r = await fetch(API + '?/api/logs');
        const logText = await r.text();
        const box = document.getElementById('logBox');
        box.innerHTML = formatLog(logText);
        box.scrollTop = box.scrollHeight;
        
        if (buttonId) {
            showToast('✓ 日志已刷新', false);
        }
    } catch(e) {
        showToast('✗ 日志加载失败: ' + e.message, true);
    } finally {
        if (buttonId) {
            setTimeout(() => btnManager.reset(buttonId), 500);
        }
    }
}

async function clearLog() {
    const r = await apiGet('/api/action/clear_log');
    showToast(r.message, !r.success);
    if(r.success) refreshLog();
}

async function doAction(act) {
    // 操作确认
    if(act === 'clear_log') {
        if(!confirm('确定要清空日志吗？')) return;
    }
    
    // 确定按钮 ID 和加载文字
    const buttonMap = {
        'run_now': { id: 'runNowBtn', text: '执行中...' },
        'restart': { id: 'restartBtn', text: '重启中...' }
    };
    
    const btnInfo = buttonMap[act];
    
    try {
        // 设置按钮加载状态
        if (btnInfo) {
            btnManager.setState(btnInfo.id, ButtonState.LOADING, btnInfo.text);
        }
        
        const r = await apiGet('/api/action/' + act);
        let msg = r.message;
        
        // 添加耗时信息
        if(r.duration !== undefined) {
            msg += ' (耗时: ' + r.duration + '秒)';
        }
        
        showToast(r.success ? '✓ ' + msg : '✗ ' + msg, !r.success);
        
        // 刷新状态和日志
        setTimeout(refreshStatus, 1000);
        if(act === 'run_now' || act === 'clear_log') {
            setTimeout(refreshLog, 1500);
        }
        
    } catch(e) {
        showToast('✗ 操作失败: ' + e.message, true);
    } finally {
        // 恢复按钮状态
        if (btnInfo) {
            setTimeout(() => btnManager.reset(btnInfo.id), 500);
        }
    }
}

function toggleAutoRefresh() {
    const btn = document.getElementById('autoRefreshBtn');
    if(autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        btn.innerHTML = '<svg class="icon icon-small"><use href="#icon-play"/></svg> 启动自动刷新';
    } else {
        autoRefreshInterval = setInterval(function() { refreshLog(); refreshStatus(); }, 5000);
        btn.innerHTML = '<svg class="icon icon-small"><use href="#icon-pause"/></svg> 暂停自动刷新';
    }
}

document.getElementById('configForm').onsubmit = async function(e) {
    e.preventDefault();
    
    // 验证 Cron 表达式
    const mode = document.getElementById('scheduleMode').value;
    const cronExp = document.getElementById('cronExp').value.trim();
    const sleepHeartbeatValue = document.getElementById('sleepHeartbeat').value.trim();
    
    // 跨模式验证
    const validation = crossModeValidator.validateMode(mode, cronExp, sleepHeartbeatValue);
    
    // 处理错误
    if (!validation.valid) {
        const errorMsg = validation.errors.map(e => e.message).join('\n');
        showToast('✗ ' + errorMsg, true);
        return;
    }
    
    // 处理警告
    if (validation.warnings.length > 0) {
        const warning = validation.warnings[0];
        const confirmed = confirm(
            warning.message + '\n\n' + warning.suggestion + '\n\n是否继续保存？'
        );
        if (!confirmed) return;
    }
    
    // Cron 格式验证
    if (mode === 'cron' && !validateCron()) {
        showToast('✗ 请修正 Cron 表达式格式', true);
        return;
    }
    
    // 验证范围
    const sleepHeartbeat = document.getElementById('sleepHeartbeat').value;
    if (sleepHeartbeat && !validateRange('sleepHeartbeat', 60, 7200, 'Sleep 心跳间隔')) {
        return;
    }
    
    const webuiTimeout = document.getElementById('webuiTimeout').value;
    if (webuiTimeout && !validateRange('webuiTimeout', 60, 3600, 'Web UI 超时时间')) {
        return;
    }
    
    const heartbeatSec = document.getElementById('heartbeatSec').value;
    if (heartbeatSec && !validateRange('heartbeatSec', 10, 300, 'Web UI 心跳间隔')) {
        return;
    }
    
    const data = {
        schedule_mode: mode,
        cron_exp: document.getElementById('cronExp').value,
        log_mode: document.getElementById('logMode').value,
        sleep_heartbeat: sleepHeartbeat,
        webui_timeout: webuiTimeout,
        heartbeat_sec: heartbeatSec
    };
    
    await withFeedback(
        () => apiPost('/api/config', data),
        'saveConfigBtn',
        '保存中...'
    );
};

document.getElementById('actionConfigForm').onsubmit = async function(e) {
    e.preventDefault();
    
    // 验证范围
    const promptTimeout = document.getElementById('webuiPromptTimeout').value;
    if (promptTimeout && !validateRange('webuiPromptTimeout', 1, 60, '音量键选择超时')) {
        return;
    }
    
    const data = {
        auto_start_webui: document.getElementById('autoStartWebui').value,
        webui_prompt_timeout: promptTimeout
    };
    
    await withFeedback(
        () => apiPost('/api/action_config', data),
        'saveActionConfigBtn',
        '保存中...'
    );
};

// 监听 autoStartWebui 变化
document.getElementById('autoStartWebui').addEventListener('change', updatePromptTimeoutVisibility);

// 数值范围验证
function validateRange(id, min, max, name) {
    const el = document.getElementById(id);
    const val = parseInt(el.value, 10);
    if (isNaN(val) || val < min || val > max) {
        el.classList.add('error');
        showToast(name + ' 必须在 ' + min + '-' + max + ' 之间', true);
        return false;
    }
    el.classList.remove('error');
    return true;
}

document.getElementById('f2fsoptForm').onsubmit = async function(e) {
    e.preventDefault();
    
    // 前端范围验证
    if (!validateRange('gcDirtyMin', 50, 1000, 'GC脏段阈值')) return;
    if (!validateRange('gcTurboSleep', 10, 5000, '极速GC睡眠')) return;
    if (!validateRange('gcSafeSleep', 100, 10000, '安全GC睡眠')) return;
    if (!validateRange('gcMaxSec', 60, 3600, 'GC最大时长')) return;
    if (!validateRange('trimTimeout', 60, 3600, 'Trim超时')) return;
    if (!validateRange('gcStableCnt', 1, 50, 'GC稳定计数')) return;
    if (!validateRange('gcPoll', 1, 60, 'GC轮询间隔')) return;
    // 扫描诊断配置验证
    if (!validateRange('slowMountThreshold', 100, 10000, '慢速阈值')) return;
    if (!validateRange('verySlowThreshold', 100, 30000, '极慢阈值')) return;
    
    // 跨字段验证：极慢阈值 >= 慢速阈值
    const slowVal = parseInt(document.getElementById('slowMountThreshold').value, 10);
    const verySlowVal = parseInt(document.getElementById('verySlowThreshold').value, 10);
    if (verySlowVal < slowVal) {
        showToast('✗ 极慢阈值必须大于等于慢速阈值', true);
        document.getElementById('verySlowThreshold').classList.add('error');
        return;
    }
    document.getElementById('verySlowThreshold').classList.remove('error');
    
    const data = {
        gc_dirty_min: document.getElementById('gcDirtyMin').value,
        gc_turbo_sleep: document.getElementById('gcTurboSleep').value,
        gc_safe_sleep: document.getElementById('gcSafeSleep').value,
        gc_max_sec: document.getElementById('gcMaxSec').value,
        trim_timeout: document.getElementById('trimTimeout').value,
        gc_stable_cnt: document.getElementById('gcStableCnt').value,
        gc_poll: document.getElementById('gcPoll').value,
        enable_smart_gc: toggleState.smartGc ? 'true' : 'false',
        enable_smart_trim: toggleState.smartTrim ? 'true' : 'false',
        enable_turbo_gc: toggleState.turboGc ? 'true' : 'false',
        enable_notifications: toggleState.notifications ? 'true' : 'false',
        stop_on_screen: toggleState.stopOnScreen ? 'true' : 'false',
        only_charging: toggleState.onlyCharging ? 'true' : 'false',
        // 扫描诊断配置
        debug_scan: toggleState.debugScan ? '1' : '0',
        slow_mount_threshold: document.getElementById('slowMountThreshold').value,
        very_slow_threshold: document.getElementById('verySlowThreshold').value
    };
    
    await withFeedback(
        () => apiPost('/api/f2fsopt_config', data),
        'saveF2fsoptBtn',
        '保存中...'
    );
};

// 初始化跨模式验证器
crossModeValidator.init();

// 初始化快捷选项
presetManager.renderPresets();

loadConfig();
loadF2fsoptConfig();
loadActionConfig();
refreshStatus();
refreshLog();
autoRefreshInterval = setInterval(function() { refreshLog(); refreshStatus(); }, 5000);
</script>
</body>
</html>